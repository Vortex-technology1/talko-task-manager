<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TALKO System - Таск Менеджер Pro</title>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --primary: #22c55e;
            --primary-dark: #16a34a;
            --success: #22c55e;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #3b82f6;
            --dark: #1a1a1a;
            --gray: #525252;
            --light: #ffffff;
            --white: #ffffff;
            --shadow: 0 2px 10px rgba(0,0,0,0.08);
            --shadow-lg: 0 10px 40px rgba(0,0,0,0.12);
            --radius: 16px;
            --radius-sm: 8px;
            --header-bg: #0d1f0d;
        }
        
        /* SVG Icon styles */
        .icon {
            width: 18px;
            height: 18px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            vertical-align: middle;
        }
        .icon svg {
            width: 100%;
            height: 100%;
            stroke-width: 2;
        }
        .icon-sm { width: 14px; height: 14px; }
        .icon-lg { width: 22px; height: 22px; }
        .icon-xl { width: 28px; height: 28px; }
        
        .btn .icon, .tab-btn .icon { margin-right: 6px; }
        .action-btn .icon { margin: 0; }
        
        body { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            background: #f9fafb; 
            color: var(--dark);
            min-height: 100vh;
        }
        
        .header { 
            background: var(--header-bg); 
            color: white; 
            padding: 0.75rem 1rem; 
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header-content { 
            max-width: 1400px; 
            margin: 0 auto; 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        
        .logo { font-size: 1.1rem; font-weight: 700; display: flex; align-items: center; gap: 0.5rem; }
        .header-actions { display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap; }
        
        .header-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 0.5rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .header-btn:hover { background: rgba(255,255,255,0.3); }
        
        .header-ai-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            padding: 0.4rem 0.6rem;
            border-radius: 15px;
            font-size: 0.75rem;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 0.3rem;
            transition: all 0.2s;
        }
        
        .header-ai-btn:hover { background: rgba(255,255,255,0.35); transform: translateY(-1px); }
        .header-ai-btn.tech { background: rgba(46, 204, 113, 0.3); }
        .header-ai-btn.tech:hover { background: rgba(46, 204, 113, 0.5); }
        
        .lang-switcher {
            display: flex;
            background: rgba(255,255,255,0.2);
            border-radius: 15px;
            overflow: hidden;
        }
        
        .lang-btn {
            background: transparent;
            border: none;
            color: rgba(255,255,255,0.7);
            padding: 0.3rem 0.5rem;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .lang-btn.active {
            background: rgba(255,255,255,0.3);
            color: white;
            font-weight: 600;
        }
        
        .lang-btn:hover { color: white; }
        
        .user-info {
            display: none;
            background: rgba(255,255,255,0.2);
            padding: 0.4rem 0.8rem;
            border-radius: 20px;
            font-size: 0.85rem;
            transition: background 0.2s;
        }
        
        .user-info:hover {
            background: rgba(255,255,255,0.35);
        }
        
        .container { max-width: 1400px; margin: 0 auto; padding: 1rem; }
        
        .tab-navigation { 
            display: flex; 
            background: var(--white); 
            border-radius: var(--radius) var(--radius) 0 0; 
            box-shadow: var(--shadow);
            overflow-x: auto;
            scrollbar-width: none;
        }
        
        .tab-navigation::-webkit-scrollbar { display: none; }
        
        .tab-btn { 
            background: transparent; 
            border: none; 
            padding: 0.9rem 1rem; 
            cursor: pointer; 
            font-size: 0.8rem; 
            font-weight: 500; 
            color: var(--gray); 
            border-bottom: 3px solid transparent; 
            white-space: nowrap;
            flex-shrink: 0;
        }
        
        .tab-btn:hover { color: var(--dark); background: rgba(34, 197, 94, 0.05); }
        .tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); font-weight: 600; }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .controls { 
            background: var(--white); 
            padding: 1rem; 
            border-radius: 0 0 var(--radius) var(--radius); 
            box-shadow: var(--shadow); 
            margin-bottom: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        
        .controls-row { display: flex; flex-wrap: wrap; gap: 0.5rem; }
        
        .btn { 
            background: var(--info); 
            color: white; 
            border: none; 
            padding: 0.7rem 1rem; 
            border-radius: var(--radius-sm); 
            cursor: pointer; 
            font-size: 0.85rem; 
            font-weight: 500;
            min-height: 44px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.4rem;
            transition: all 0.2s;
        }
        
        .btn:hover { transform: translateY(-1px); box-shadow: var(--shadow); }
        .btn:active { transform: translateY(0); }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        .btn-success { background: var(--success); color: white; }
        .btn-success:hover { background: var(--primary-dark); }
        .btn-danger { background: var(--danger); color: white; }
        .btn-warning { background: var(--warning); color: white; }
        .btn-clear { background: var(--gray); color: white; }
        .btn-outline { background: transparent; border: 2px solid var(--primary); color: var(--primary); }
        .btn-outline:hover { background: var(--primary); color: white; }
        .btn-dark { background: var(--dark); color: white; }
        .btn-small { padding: 0.4rem 0.6rem; font-size: 0.8rem; min-height: 36px; }
        
        .btn-google {
            background: white;
            color: #444;
            border: 2px solid #e5e7eb;
            font-weight: 600;
        }
        
        .btn-google:hover {
            background: #f9fafb;
            border-color: #d1d5db;
        }
        
        .btn-google img {
            width: 20px;
            height: 20px;
        }
        
        .filters { display: flex; flex-wrap: wrap; gap: 0.5rem; width: 100%; }
        
        .filter-select { 
            padding: 0.6rem; 
            border: 2px solid #e5e7eb; 
            border-radius: var(--radius-sm); 
            background: var(--white); 
            font-size: 0.85rem;
            min-height: 44px;
            flex: 1;
            min-width: 100px;
        }
        
        .filter-select:focus { outline: none; border-color: var(--info); }
        
        .tasks-container, .cards-grid {
            background: var(--white);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            overflow: hidden;
        }
        
        .cards-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 0.75rem;
            padding: 1rem;
        }
        
        .task-card, .function-card, .user-card {
            padding: 1rem;
            border-bottom: 1px solid #e5e7eb;
            transition: all 0.2s;
        }
        
        .function-card, .user-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: var(--radius);
        }
        
        .task-card:last-child { border-bottom: none; }
        .task-card:hover, .function-card:hover, .user-card:hover { background: #f9fafb; border-color: var(--primary); }
        
        .task-card.pinned {
            background: linear-gradient(90deg, rgba(34, 197, 94, 0.08) 0%, var(--white) 100%);
            border-left: 4px solid var(--primary);
        }
        
        .task-card-header, .function-header, .user-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }
        
        .task-title, .function-title, .user-name { font-weight: 600; font-size: 0.95rem; flex: 1; color: var(--dark); }
        
        .pin-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 0.9rem;
            color: #d1d5db;
            padding: 0.2rem;
        }
        
        .pin-btn:hover, .pin-btn.pinned { color: var(--warning); }
        
        .task-meta, .function-description, .user-details {
            font-size: 0.8rem;
            color: var(--gray);
            margin-bottom: 0.5rem;
            line-height: 1.4;
        }
        
        .task-meta { display: flex; flex-wrap: wrap; gap: 0.5rem; }
        .task-meta-item { display: flex; align-items: center; gap: 0.2rem; }
        
        .task-badges, .function-assignees { display: flex; flex-wrap: wrap; gap: 0.4rem; margin-bottom: 0.5rem; }
        
        .badge, .assignee-badge, .role-badge {
            padding: 0.2rem 0.5rem;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 500;
        }
        
        .badge-new { background: #eff6ff; color: #2563eb; }
        .badge-progress { background: #fef3c7; color: #d97706; }
        .badge-review { background: #fae8ff; color: #a855f7; }
        .badge-done { background: #f0fdf4; color: #16a34a; }
        .badge-high { background: #fef2f2; color: #dc2626; }
        .badge-medium { background: #fef3c7; color: #d97706; }
        .badge-low { background: #f0fdf4; color: #16a34a; }
        
        .assignee-badge { background: var(--primary); color: white; }
        .assignee-badge.head { background: var(--warning); }
        
        .role-badge { color: white; }
        .role-badge.owner { background: var(--danger); }
        .role-badge.manager { background: var(--warning); }
        .role-badge.employee { background: var(--info); }
        
        .task-actions, .function-stats, .user-stats { 
            display: flex; 
            gap: 0.4rem; 
            justify-content: flex-end;
            padding-top: 0.5rem;
        }
        
        .task-deadline-row {
            display: flex;
            gap: 0.75rem;
            align-items: center;
            font-size: 0.85rem;
            padding: 0.5rem 0;
            flex-wrap: wrap;
        }
        
        .task-deadline-row.overdue-text { color: #e74c3c; font-weight: 600; }
        .task-deadline-row.today-text { color: #2980b9; font-weight: 600; }
        
        .time-badge {
            background: #e8f4fd;
            color: #2980b9;
            padding: 0.15rem 0.5rem;
            border-radius: 10px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .task-detail {
            font-size: 0.8rem;
            color: #555;
            padding: 0.4rem 0.6rem;
            background: #f8f9fa;
            border-radius: 6px;
            margin-top: 0.4rem;
            line-height: 1.4;
        }
        
        .task-detail strong { color: #333; }
        
        .task-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 0.5rem;
            margin-top: 0.5rem;
            border-top: 1px solid #ecf0f1;
        }
        
        .task-created {
            font-size: 0.7rem;
            color: #95a5a6;
        }
        
        .regular-schedule {
            font-size: 0.85rem;
            color: #2980b9;
            font-weight: 500;
            margin-bottom: 0.5rem;
            padding: 0.3rem 0.6rem;
            background: #e8f4fd;
            border-radius: 6px;
            display: inline-block;
        }
        
        .instruction-preview {
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .instruction-preview:hover {
            background: #e8f4fd;
        }
        
        .task-card.overdue {
            border-left: 4px solid #e74c3c;
            background: linear-gradient(90deg, rgba(231, 76, 60, 0.05) 0%, var(--white) 100%);
        }
        
        .task-card.today {
            border-left: 4px solid #3498db;
            background: linear-gradient(90deg, rgba(52, 152, 219, 0.05) 0%, var(--white) 100%);
        }
        
        .total-time-badge {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
        }
        
        .total-time-container {
            padding: 0.5rem 1rem;
            text-align: right;
        }
        
        .filters-row {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            align-items: center;
        }
        
        .btn-clear {
            background: #95a5a6;
        }
        
        /* Table styles */
        .table-container {
            background: var(--white);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            overflow-x: auto;
        }
        
        .tasks-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }
        
        .tasks-table th {
            background: #34495e;
            color: white;
            padding: 1rem;
            text-align: left;
            font-weight: 500;
            font-size: 0.85rem;
        }
        
        .tasks-table td {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #ecf0f1;
            font-size: 0.85rem;
        }
        
        .tasks-table tr:hover {
            background: #f8f9fa;
        }
        
        .tasks-table .task-title-cell {
            max-width: 250px;
        }
        
        .tasks-table .task-title-text {
            font-weight: 500;
            color: var(--dark);
        }
        
        .tasks-table .task-title-text.pinned {
            color: #e74c3c;
        }
        
        .status-badge {
            padding: 0.25rem 0.6rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
            display: inline-block;
        }
        
        .status-new { background: #e3f2fd; color: #1976d2; }
        .status-progress { background: #fff3e0; color: #f57c00; }
        .status-review { background: #fce4ec; color: #c2185b; }
        .status-done { background: #e8f5e8; color: #388e3c; }
        
        .deadline-text.overdue { color: #e74c3c; font-weight: 600; }
        .deadline-text.today { color: #3498db; font-weight: 600; }
        
        .action-btns {
            display: flex;
            gap: 0.25rem;
        }
        
        .action-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            padding: 0.25rem;
            border-radius: 4px;
            transition: background 0.2s;
        }
        
        .action-btn:hover {
            background: #ecf0f1;
        }
        
        /* Dashboard subtitle */
        .dashboard-subtitle {
            font-size: 0.7rem;
            opacity: 0.85;
            margin-top: 0.25rem;
        }
        
        /* Analytics */
        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }
        
        .analytics-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 1.25rem;
            text-align: center;
        }
        
        .analytics-card h3 {
            font-size: 0.85rem;
            color: var(--gray);
            margin-bottom: 0.5rem;
        }
        
        .analytics-number {
            font-size: 2rem;
            font-weight: 700;
            color: var(--dark);
        }
        
        .analytics-number.green { color: #27ae60; }
        .analytics-number.blue { color: #3498db; }
        .analytics-number.orange { color: #f39c12; }
        
        @media (min-width: 768px) {
            .analytics-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }
        
        .controls-row {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            align-items: center;
        }
        
        .empty-table {
            text-align: center;
            padding: 3rem;
            color: var(--gray);
        }
        
        .empty-table h3 {
            margin-bottom: 0.5rem;
            color: var(--dark);
        }
        
        .function-stats, .user-stats {
            justify-content: space-between;
            border-top: 1px solid #ecf0f1;
            font-size: 0.8rem;
        }
        
        .empty-state { text-align: center; padding: 2.5rem 1.5rem; color: var(--gray); }
        .empty-state h3 { margin-bottom: 0.5rem; color: var(--dark); font-size: 1.1rem; }
        
        .modal { 
            display: none; 
            position: fixed; 
            z-index: 1000; 
            left: 0; top: 0; 
            width: 100%; height: 100%; 
            background: rgba(0,0,0,0.5); 
            backdrop-filter: blur(3px);
            overflow-y: auto;
            padding: 0.5rem;
        }
        
        .modal-content { 
            background: var(--white); 
            margin: 0 auto;
            border-radius: var(--radius); 
            width: 100%;
            max-width: 550px;
            max-height: calc(100vh - 1rem);
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
        }
        
        .modal-header { 
            background: var(--dark); 
            color: white; 
            padding: 1rem; 
            border-radius: var(--radius) var(--radius) 0 0;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .modal-header h2 { font-size: 1.1rem; padding-right: 2rem; }
        .modal-body { padding: 1rem; }
        
        .close { 
            color: rgba(255,255,255,0.7);
            position: absolute;
            right: 1rem; top: 0.8rem;
            font-size: 1.5rem;
            cursor: pointer;
        }
        
        .close:hover { color: white; }
        
        .form-grid { display: grid; grid-template-columns: 1fr; gap: 0.9rem; }
        .form-group { display: flex; flex-direction: column; }
        .form-group.full-width { grid-column: span 1; }
        .form-label { margin-bottom: 0.4rem; font-weight: 600; color: var(--dark); font-size: 0.85rem; }
        
        .form-input, .form-select, .form-textarea { 
            padding: 0.7rem; 
            border: 2px solid #ecf0f1; 
            border-radius: var(--radius-sm); 
            font-size: 1rem;
            min-height: 44px;
        }
        
        .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: var(--info); }
        .form-textarea { resize: vertical; min-height: 70px; }
        .form-actions { display: flex; gap: 0.5rem; justify-content: flex-end; margin-top: 1rem; flex-wrap: wrap; }
        
        .dashboard-cards {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.6rem;
            margin-bottom: 1rem;
        }
        
        .dashboard-card {
            border-radius: var(--radius);
            padding: 0.8rem;
            text-align: center;
            color: white;
        }
        
        .dashboard-card.urgent { background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%); }
        .dashboard-card.warning { background: linear-gradient(135deg, #feca57 0%, #f39c12 100%); }
        .dashboard-card.active { background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%); }
        .dashboard-card.completed { background: linear-gradient(135deg, #55efc4 0%, #00b894 100%); }
        
        .dashboard-card h3 { font-size: 0.75rem; margin-bottom: 0.2rem; opacity: 0.9; }
        .dashboard-number { font-size: 1.75rem; font-weight: 700; }
        
        /* AUTH */
        .auth-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: calc(100vh - 80px);
            padding: 1rem;
        }
        
        .auth-card {
            background: var(--white);
            border-radius: var(--radius);
            box-shadow: var(--shadow-lg);
            width: 100%;
            max-width: 420px;
            overflow: hidden;
            border: 1px solid #e5e7eb;
        }
        
        .auth-header {
            background: var(--header-bg);
            color: white;
            padding: 1.5rem;
            text-align: center;
        }
        
        .auth-header h2 { font-size: 1.4rem; margin-bottom: 0.3rem; }
        .auth-header p { opacity: 0.9; font-size: 0.85rem; }
        .auth-body { padding: 1.25rem; }
        
        .auth-message {
            padding: 0.75rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            font-size: 0.85rem;
        }
        .auth-message.success { background: #f0fdf4; color: #16a34a; }
        .auth-message.error { background: #fef2f2; color: #dc2626; }
        .auth-message.info { background: #eff6ff; color: #2563eb; }
        
        .auth-divider {
            display: flex;
            align-items: center;
            margin: 1.25rem 0;
            color: var(--gray);
            font-size: 0.85rem;
        }
        
        .auth-divider::before,
        .auth-divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: #e5e7eb;
        }
        
        .auth-divider span {
            padding: 0 1rem;
        }
        
        .main-interface { display: none; }
        
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 3rem;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e5e7eb;
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .footer {
            text-align: center;
            padding: 1.25rem;
            background: #f9fafb;
            border-top: 1px solid #e5e7eb;
            margin-top: 1.5rem;
        }
        
        .footer p { color: var(--gray); font-size: 0.8rem; margin-bottom: 0.5rem; }
        .footer-links { display: flex; justify-content: center; gap: 1rem; flex-wrap: wrap; }
        .footer-links a { color: var(--primary); text-decoration: none; font-size: 0.8rem; }
        
        .support-btn {
            position: fixed;
            bottom: 16px;
            right: 16px;
            z-index: 999;
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 12px 20px;
            background: var(--primary);
            color: #ffffff !important;
            border-radius: 50px;
            font-weight: 600;
            font-size: 14px;
            box-shadow: 0 4px 15px rgba(34, 197, 94, 0.4);
            cursor: pointer;
            text-decoration: none;
            border: none;
            transition: all 0.3s;
        }
        
        .support-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(16, 185, 129, 0.5); }
        
        /* Mobile buttons */
        
        @media (min-width: 768px) {
            .header { padding: 1rem 2rem; }
            .logo { font-size: 1.4rem; }
            .user-info { display: flex; }
            .container { padding: 1.5rem; }
            .controls { flex-direction: row; align-items: center; justify-content: space-between; }
            .filters { width: auto; flex-wrap: nowrap; }
            .filter-select { flex: none; min-width: auto; }
            .form-grid { grid-template-columns: 1fr 1fr; }
            .form-group.full-width { grid-column: span 2; }
            .cards-grid { grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); }
            .dashboard-cards { grid-template-columns: repeat(4, 1fr); }
        }
        
        /* Mobile optimizations */
        @media (max-width: 767px) {
            .filters {
                display: flex;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                padding-bottom: 0.5rem;
                gap: 0.5rem;
            }
            
            .filter-select {
                flex: 0 0 auto;
                min-width: 130px;
                font-size: 0.8rem;
                padding: 0.5rem;
            }
            
            .task-card {
                padding: 0.75rem;
            }
            
            .task-title {
                font-size: 0.9rem;
            }
            
            .task-deadline-row {
                font-size: 0.8rem;
                gap: 0.5rem;
            }
            
            .task-meta {
                gap: 0.3rem;
            }
            
            .task-meta-item {
                font-size: 0.75rem;
            }
            
            .task-detail {
                font-size: 0.75rem;
                padding: 0.3rem 0.5rem;
            }
            
            .btn {
                padding: 0.6rem 0.8rem;
                font-size: 0.8rem;
            }
            
            .btn-small {
                padding: 0.35rem 0.5rem;
                font-size: 0.75rem;
                min-height: 44px;
                min-width: 44px;
            }
            
            .total-time-badge {
                font-size: 0.75rem;
                padding: 0.4rem 0.8rem;
            }
            
            .controls-row {
                justify-content: space-between;
                width: 100%;
            }
            
            .modal-content {
                margin-top: 0;
                border-radius: var(--radius) var(--radius) 0 0;
                max-height: 95vh;
            }
            
            .form-input, .form-select, .form-textarea {
                font-size: 16px; /* Prevents zoom on iOS */
            }
            
            /* Hide table on mobile */
            .tasks-table { display: none !important; }
            
            /* Mobile task cards */
            .mobile-tasks-list { display: block; }
            
            .mobile-task-card {
                background: transparent;
                border-radius: 12px;
                margin-bottom: 0.75rem;
                position: relative;
                overflow: hidden;
            }
            
            .mobile-task-content {
                background: white;
                padding: 1rem;
                border-radius: 12px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.08);
                border-left: 4px solid var(--gray);
                position: relative;
                z-index: 2;
                transition: transform 0.2s ease-out, opacity 0.2s;
            }
            
            .mobile-task-card.status-new .mobile-task-content { border-left-color: #3498db; }
            .mobile-task-card.status-progress .mobile-task-content { border-left-color: #f39c12; }
            .mobile-task-card.status-review .mobile-task-content { border-left-color: #9b59b6; }
            .mobile-task-card.status-done .mobile-task-content { border-left-color: #27ae60; opacity: 0.7; }
            .mobile-task-card.overdue .mobile-task-content { border-left-color: #e74c3c; }
            .mobile-task-card.pinned .mobile-task-content { border-left-color: #e74c3c; background: #fff5f5; }
            
            .mobile-task-header {
                display: flex;
                justify-content: space-between;
                align-items: flex-start;
                gap: 0.5rem;
                margin-bottom: 0.5rem;
            }
            
            .mobile-task-title {
                font-weight: 600;
                font-size: 0.95rem;
                color: #1a1a1a;
                flex: 1;
                line-height: 1.3;
            }
            
            .mobile-task-status {
                flex-shrink: 0;
            }
            
            .mobile-task-meta {
                display: flex;
                flex-wrap: wrap;
                gap: 0.5rem;
                font-size: 0.8rem;
                color: #666;
                margin-bottom: 0.75rem;
            }
            
            .mobile-task-meta-item {
                display: flex;
                align-items: center;
                gap: 0.25rem;
                background: #f5f5f5;
                padding: 0.25rem 0.5rem;
                border-radius: 6px;
            }
            
            .mobile-task-meta-item.deadline-overdue {
                background: #ffe5e5;
                color: #e74c3c;
            }
            
            .mobile-task-meta-item.deadline-today {
                background: #fff3e0;
                color: #f57c00;
            }
            
            .mobile-task-actions {
                display: flex;
                gap: 0.5rem;
                padding-top: 0.75rem;
                border-top: 1px solid #eee;
            }
            
            .mobile-action-btn {
                flex: 1;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 0.3rem;
                padding: 0.6rem;
                border: none;
                border-radius: 8px;
                font-size: 0.8rem;
                font-weight: 500;
                cursor: pointer;
                min-height: 44px;
                transition: all 0.2s;
            }
            
            .mobile-action-btn.complete {
                background: #e8f5e9;
                color: #2e7d32;
            }
            
            .mobile-action-btn.edit {
                background: #e3f2fd;
                color: #1565c0;
            }
            
            .mobile-action-btn.delete {
                background: #ffebee;
                color: #c62828;
            }
            
            .mobile-action-btn:active {
                transform: scale(0.95);
            }
        }
        
        /* Desktop: show table, hide mobile cards */
        @media (min-width: 768px) {
            .mobile-tasks-list { display: none !important; }
            .tasks-table { display: table !important; }
            .bottom-nav { display: none !important; }
            .fab-add { display: none !important; }
            .mobile-filter-bar { display: none !important; }
            .filters-row { display: flex !important; }
            .controls-row .btn { display: inline-flex !important; }
        }
        
        /* Bottom Navigation for Mobile */
        .bottom-nav {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.08);
            z-index: 1000;
            padding: 0.5rem 0;
            padding-bottom: calc(0.5rem + env(safe-area-inset-bottom));
            border-top: 1px solid #e5e7eb;
        }
        
        .bottom-nav-items {
            display: flex;
            justify-content: space-around;
            max-width: 500px;
            margin: 0 auto;
        }
        
        .bottom-nav-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.2rem;
            padding: 0.5rem 0.75rem;
            background: none;
            border: none;
            color: #9ca3af;
            font-size: 0.65rem;
            cursor: pointer;
            border-radius: 8px;
            min-width: 60px;
            transition: all 0.2s;
        }
        
        .bottom-nav-btn .icon {
            width: 22px;
            height: 22px;
        }
        
        .bottom-nav-btn.active {
            color: var(--primary);
            background: #f0fdf4;
        }
        
        .bottom-nav-btn:active {
            transform: scale(0.95);
        }
        
        @media (max-width: 767px) {
            .bottom-nav { display: block; }
            .tab-navigation { display: none; }
            .main-interface { padding-bottom: 80px; }
            .hide-mobile { display: none !important; }
            
            /* FAB for adding tasks */
            .fab-add {
                position: fixed;
                bottom: 90px;
                right: 16px;
                width: 56px;
                height: 56px;
                border-radius: 50%;
                background: var(--success);
                color: white;
                border: none;
                box-shadow: 0 4px 12px rgba(34, 197, 94, 0.4);
                cursor: pointer;
                z-index: 999;
                display: flex;
                align-items: center;
                justify-content: center;
                transition: all 0.2s;
            }
            
            .fab-add:active {
                transform: scale(0.9);
            }
            
            .fab-add .icon {
                width: 24px;
                height: 24px;
            }
            
            /* Hide desktop add buttons on mobile */
            .controls .btn-success:first-child { display: none; }
            
            /* Compact mobile header */
            .header-container {
                padding: 0.5rem 1rem;
            }
            
            .header-logo {
                font-size: 1rem;
            }
            
            .header-logo .company-badge {
                display: none !important;
            }
            
            .header-actions {
                gap: 0.5rem;
            }
            
            /* Hide AI buttons and full logout on mobile */
            .header-ai-btn { display: none !important; }
            .header-btn span { display: none; }
            .header-btn { 
                padding: 0.5rem; 
                border-radius: 50%;
                min-width: 40px;
                min-height: 40px;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            .header-btn .icon { margin: 0; }
            
            .lang-switcher { display: none; }
            .user-info { display: none !important; }
            
            /* Swipe to complete */
            .mobile-task-card {
                position: relative;
                overflow: hidden;
                touch-action: pan-y;
                transition: transform 0.2s ease-out;
            }
            
            .mobile-task-card.swiping {
                transition: none;
            }
            
            .swipe-action-bg {
                position: absolute;
                top: 0;
                bottom: 0;
                width: 100%;
                display: flex;
                align-items: center;
                padding: 0 1.5rem;
                font-weight: 600;
                font-size: 0.9rem;
                opacity: 0;
                transition: opacity 0.2s;
            }
            
            .swipe-action-bg.left {
                left: 0;
                background: linear-gradient(90deg, #27ae60 0%, #2ecc71 100%);
                color: white;
                justify-content: flex-start;
            }
            
            .swipe-action-bg.right {
                right: 0;
                background: linear-gradient(90deg, #e74c3c 0%, #c0392b 100%);
                color: white;
                justify-content: flex-end;
            }
            
            .swipe-action-bg.visible {
                opacity: 1;
            }
            
            .mobile-task-content {
                position: relative;
                background: white;
                z-index: 1;
                padding: 1rem;
                border-radius: 12px;
            }
            
            /* Swipe hint animation */
            @keyframes swipeHint {
                0%, 100% { transform: translateX(0); }
                50% { transform: translateX(10px); }
            }
            
            .mobile-task-card.hint-swipe {
                animation: swipeHint 0.5s ease-in-out;
            }
            
            /* Mobile filter button */
            .mobile-filter-bar {
                display: flex;
                gap: 0.5rem;
                padding: 0.75rem;
                background: white;
                border-radius: 12px;
                margin-bottom: 0.75rem;
                box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            }
            
            .mobile-filter-btn {
                flex: 1;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 0.4rem;
                padding: 0.7rem;
                background: #f5f5f5;
                border: none;
                border-radius: 10px;
                font-size: 0.85rem;
                font-weight: 500;
                color: #555;
                cursor: pointer;
                min-height: 44px;
                transition: all 0.2s;
            }
            
            .mobile-filter-btn.active {
                background: var(--success);
                color: white;
            }
            
            .mobile-filter-btn .filter-count {
                background: var(--success);
                color: white;
                font-size: 0.7rem;
                padding: 0.15rem 0.4rem;
                border-radius: 10px;
                font-weight: 600;
            }
            
            .mobile-filter-btn.active .filter-count {
                background: white;
                color: var(--success);
            }
            
            /* Hide desktop filters on mobile */
            .filters-row { display: none; }
            .controls-row .btn:not(.btn-success) { display: none; }
            
            /* Date group headers */
            .date-group-header {
                display: flex;
                align-items: center;
                gap: 0.5rem;
                padding: 0.75rem 0.5rem;
                font-weight: 600;
                font-size: 0.85rem;
                color: #555;
                border-bottom: 2px solid #eee;
                margin-top: 0.5rem;
            }
            
            .date-group-header:first-child {
                margin-top: 0;
            }
            
            .date-group-header .date-label {
                flex: 1;
            }
            
            .date-group-header .task-count {
                background: #f0f0f0;
                padding: 0.2rem 0.6rem;
                border-radius: 10px;
                font-size: 0.75rem;
                color: #888;
            }
            
            .date-group-header.overdue {
                color: #e74c3c;
                border-bottom-color: #ffcccc;
            }
            
            .date-group-header.today {
                color: #f39c12;
                border-bottom-color: #ffe5b4;
            }
            
            .date-group-header.tomorrow {
                color: #3498db;
                border-bottom-color: #cce5ff;
            }
            
            /* Filter modal */
            .filter-modal-content {
                padding: 0;
                max-height: 80vh;
                overflow-y: auto;
            }
            
            .filter-modal-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 1rem;
                border-bottom: 1px solid #eee;
                position: sticky;
                top: 0;
                background: white;
                z-index: 10;
            }
            
            .filter-modal-header h3 {
                margin: 0;
                font-size: 1.1rem;
            }
            
            .filter-section {
                padding: 1rem;
                border-bottom: 1px solid #f0f0f0;
            }
            
            .filter-section:last-child {
                border-bottom: none;
            }
            
            .filter-section-title {
                font-weight: 600;
                font-size: 0.85rem;
                color: #888;
                margin-bottom: 0.75rem;
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }
            
            .filter-chips {
                display: flex;
                flex-wrap: wrap;
                gap: 0.5rem;
            }
            
            .filter-chip {
                padding: 0.5rem 1rem;
                background: #f5f5f5;
                border: 2px solid transparent;
                border-radius: 20px;
                font-size: 0.85rem;
                cursor: pointer;
                transition: all 0.2s;
            }
            
            .filter-chip.selected {
                background: #e8f5e9;
                border-color: var(--success);
                color: var(--success);
                font-weight: 500;
            }
            
            .filter-modal-footer {
                display: flex;
                gap: 0.75rem;
                padding: 1rem;
                border-top: 1px solid #eee;
                position: sticky;
                bottom: 0;
                background: white;
            }
            
            .filter-modal-footer .btn {
                flex: 1;
            }
        }
        
        @media (max-width: 400px) {
            .header-ai-btn span { display: none; }
            .header-ai-btn { padding: 0.4rem; font-size: 0.9rem; }
            .support-btn span { display: none; }
            .support-btn { padding: 14px; border-radius: 50%; font-size: 18px; }
        }
        
        .assignee-checkbox {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            background: #f0f0f0;
            padding: 0.3rem 0.5rem;
            border-radius: 15px;
            font-size: 0.8rem;
            cursor: pointer;
        }
        
        .assignee-checkbox:hover { background: #e0e0e0; }
        .assignee-checkbox input { width: 14px; height: 14px; cursor: pointer; }
        
        .company-badge {
            background: rgba(255,255,255,0.3);
            padding: 0.2rem 0.5rem;
            border-radius: 10px;
            font-size: 0.7rem;
            margin-left: 0.5rem;
        }
        
        .password-toggle {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.1rem;
            color: var(--gray);
        }
        
        .input-wrapper {
            position: relative;
        }
        
        .no-access-card {
            text-align: center;
            padding: 2rem;
        }
        
        .no-access-card h3 {
            color: var(--danger);
            margin-bottom: 1rem;
        }
        
        .no-access-card p {
            color: var(--gray);
            margin-bottom: 1.5rem;
            line-height: 1.5;
        }
        
        /* ===================== */
        /* CALENDAR VIEW STYLES  */
        /* ===================== */
        
        .calendar-view-switcher {
            display: flex;
            gap: 0.25rem;
            background: #e5e7eb;
            padding: 0.25rem;
            border-radius: 8px;
            margin-right: 1rem;
        }
        
        .calendar-view-btn {
            padding: 0.4rem 0.8rem;
            border: none;
            background: transparent;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            color: var(--gray);
            transition: all 0.2s;
        }
        
        .calendar-view-btn:hover {
            color: var(--dark);
        }
        
        .calendar-view-btn.active {
            background: white;
            color: var(--dark);
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .calendar-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem;
            background: white;
            border-radius: 12px;
            margin-bottom: 1rem;
            box-shadow: var(--shadow);
        }
        
        .calendar-nav {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .calendar-nav-btn {
            width: 36px;
            height: 36px;
            border: 1px solid #e5e7eb;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .calendar-nav-btn:hover {
            background: #f3f4f6;
        }
        
        .calendar-title {
            font-size: 1.25rem;
            font-weight: 600;
            min-width: 200px;
            text-align: center;
        }
        
        .calendar-today-btn {
            padding: 0.5rem 1rem;
            border: 1px solid #e5e7eb;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
        }
        
        .calendar-today-btn:hover {
            background: #f3f4f6;
        }
        
        /* Day View */
        .calendar-day-view {
            background: white;
            border-radius: 12px;
            box-shadow: var(--shadow);
            overflow: hidden;
        }
        
        .calendar-day-header {
            display: flex;
            border-bottom: 1px solid #e5e7eb;
            background: #f9fafb;
        }
        
        .calendar-time-gutter {
            width: 60px;
            flex-shrink: 0;
            border-right: 1px solid #e5e7eb;
        }
        
        .calendar-day-column-header {
            flex: 1;
            padding: 0.75rem;
            text-align: center;
            font-weight: 500;
        }
        
        .calendar-day-column-header .day-name {
            font-size: 0.75rem;
            color: var(--gray);
            text-transform: uppercase;
        }
        
        .calendar-day-column-header .day-number {
            font-size: 1.5rem;
            font-weight: 600;
            margin-top: 0.25rem;
        }
        
        .calendar-day-column-header.today .day-number {
            background: var(--primary);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        
        .calendar-day-body {
            display: flex;
            position: relative;
            max-height: calc(100vh - 300px);
            overflow-y: auto;
        }
        
        .calendar-time-slots {
            width: 60px;
            flex-shrink: 0;
            border-right: 1px solid #e5e7eb;
        }
        
        .calendar-time-slot {
            height: 60px;
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            color: var(--gray);
            text-align: right;
            border-bottom: 1px solid #f3f4f6;
        }
        
        .calendar-events-container {
            flex: 1;
            position: relative;
        }
        
        .calendar-hour-row {
            height: 60px;
            border-bottom: 1px solid #f3f4f6;
            position: relative;
        }
        
        .calendar-hour-row:hover {
            background: rgba(102, 126, 234, 0.08);
        }
        
        /* Hint on hover - desktop only */
        @media (min-width: 768px) {
            .calendar-hour-row:hover::after {
                content: '+ Додати';
                position: absolute;
                right: 8px;
                top: 50%;
                transform: translateY(-50%);
                font-size: 0.75rem;
                color: var(--primary);
                opacity: 0.7;
                pointer-events: none;
            }
        }
        
        .calendar-event {
            position: absolute;
            left: 4px;
            right: 4px;
            border-radius: 6px;
            padding: 0.35rem 0.5rem;
            font-size: 0.8rem;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.2s;
            z-index: 1;
            border-left: 3px solid;
        }
        
        .calendar-event:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 2;
        }
        
        .calendar-event.status-new {
            background: #dbeafe;
            border-color: #3b82f6;
            color: #1e40af;
        }
        
        .calendar-event.status-progress {
            background: #fef3c7;
            border-color: #f59e0b;
            color: #92400e;
        }
        
        .calendar-event.status-review {
            background: #e0e7ff;
            border-color: #6366f1;
            color: #3730a3;
        }
        
        .calendar-event.status-done {
            background: #d1fae5;
            border-color: #10b981;
            color: #065f46;
            opacity: 0.7;
        }
        
        .calendar-event-title {
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .calendar-event-time {
            font-size: 0.7rem;
            opacity: 0.8;
            margin-top: 2px;
        }
        
        .calendar-event-done-mark {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 16px;
            height: 16px;
            background: #10b981;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .calendar-event-done-mark svg {
            width: 10px;
            height: 10px;
            color: white;
        }
        
        /* Mobile Week Strip (Google Calendar Style) */
        .mobile-week-strip {
            display: none;
        }
        
        @media (max-width: 767px) {
            .mobile-week-strip {
                display: block;
                background: white;
                padding: 12px 0 8px;
                margin: 0 -0.5rem;
                border-bottom: 1px solid #e5e7eb;
            }
            
            .week-strip-days {
                display: flex;
                justify-content: space-around;
                padding: 0 8px;
            }
            
            .week-strip-day {
                display: flex;
                flex-direction: column;
                align-items: center;
                padding: 4px;
                border-radius: 16px;
                cursor: pointer;
                min-width: 40px;
                transition: all 0.15s ease;
                -webkit-tap-highlight-color: transparent;
            }
            
            .week-strip-day:active {
                transform: scale(0.92);
                background: rgba(0,0,0,0.05);
            }
            
            .week-strip-day .day-label {
                font-size: 0.65rem;
                color: #8e8e93;
                font-weight: 600;
                text-transform: uppercase;
                letter-spacing: 0.5px;
                margin-bottom: 6px;
            }
            
            .week-strip-day .day-num {
                width: 34px;
                height: 34px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 1.1rem;
                font-weight: 400;
                border-radius: 50%;
                color: #1c1c1e;
                position: relative;
                transition: all 0.2s ease;
            }
            
            .week-strip-day.today .day-label {
                color: #007aff;
            }
            
            .week-strip-day.today .day-num {
                background: #007aff;
                color: white;
                font-weight: 500;
            }
            
            .week-strip-day.selected:not(.today) .day-num {
                background: rgba(0, 122, 255, 0.12);
                color: #007aff;
                font-weight: 500;
            }
            
            .week-strip-day.today.selected .day-num {
                box-shadow: none;
            }
            
            /* Task dots under day number - Apple style */
            .week-strip-day .task-dots {
                display: flex;
                gap: 3px;
                margin-top: 6px;
                min-height: 6px;
                justify-content: center;
            }
            
            .week-strip-day .task-dot {
                width: 5px;
                height: 5px;
                border-radius: 50%;
                background: #c7c7cc;
            }
            
            .week-strip-day .task-dot.status-new { background: #007aff; }
            .week-strip-day .task-dot.status-in_progress { background: #ff9500; }
            .week-strip-day .task-dot.status-review { background: #af52de; }
            .week-strip-day .task-dot.status-done { background: #34c759; }
        }
        
        /* Task Quick Menu / Bottom Sheet */
        .task-quick-menu {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            z-index: 10000;
            min-width: 180px;
            overflow: hidden;
            animation: fadeInMenu 0.15s ease;
        }
        
        @keyframes fadeInMenu {
            from { opacity: 0; transform: translateY(-5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Mobile Bottom Sheet */
        @media (max-width: 767px) {
            .task-quick-menu {
                position: fixed !important;
                left: 0 !important;
                right: 0 !important;
                bottom: 0 !important;
                top: auto !important;
                max-width: 100%;
                min-width: 100%;
                border-radius: 20px 20px 0 0;
                box-shadow: 0 -4px 30px rgba(0,0,0,0.2);
                animation: slideUpSheet 0.25s ease-out;
                padding-bottom: env(safe-area-inset-bottom);
            }
            
            @keyframes slideUpSheet {
                from { transform: translateY(100%); }
                to { transform: translateY(0); }
            }
            
            .task-bottom-sheet-overlay {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.4);
                z-index: 9999;
                animation: fadeIn 0.2s ease;
            }
            
            @keyframes fadeIn {
                from { opacity: 0; }
                to { opacity: 1; }
            }
            
            .task-quick-menu::before {
                content: '';
                display: block;
                width: 40px;
                height: 4px;
                background: #ddd;
                border-radius: 2px;
                margin: 12px auto 8px;
            }
            
            .task-quick-menu-header {
                padding: 12px 20px 16px;
                font-size: 1.1rem;
                max-width: 100%;
                border-bottom: 1px solid #f0f0f0;
            }
            
            .task-quick-menu-item {
                padding: 16px 20px;
                font-size: 1rem;
            }
            
            .task-quick-menu-item svg {
                width: 22px;
                height: 22px;
            }
        }
        
        .task-quick-menu-header {
            padding: 12px 16px;
            font-weight: 600;
            font-size: 0.9rem;
            background: #f9fafb;
            border-bottom: 1px solid #e5e7eb;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 200px;
        }
        
        .task-quick-menu-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 16px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background 0.15s;
        }
        
        .task-quick-menu-item:hover {
            background: #f3f4f6;
        }
        
        .task-quick-menu-item.complete {
            color: #059669;
        }
        
        .task-quick-menu-item.complete:hover {
            background: #ecfdf5;
        }
        
        .task-quick-menu-item.delete {
            color: #dc2626;
        }
        
        .task-quick-menu-item.delete:hover {
            background: #fef2f2;
        }
        
        .task-quick-menu-item svg {
            flex-shrink: 0;
        }
        
        /* Drag & Drop */
        .calendar-hour-row {
            cursor: pointer;
            transition: background 0.15s;
        }
        
        .calendar-hour-row:hover {
            background: rgba(102, 126, 234, 0.05);
        }
        
        .calendar-hour-row.drag-over {
            background: rgba(102, 126, 234, 0.15);
            box-shadow: inset 0 0 0 2px var(--primary);
        }
        
        .calendar-event[draggable="true"] {
            cursor: grab;
        }
        
        .calendar-event[draggable="true"]:active {
            cursor: grabbing;
        }
        
        /* Week View */
        .calendar-week-view {
            background: white;
            border-radius: 12px;
            box-shadow: var(--shadow);
            overflow: hidden;
        }
        
        .calendar-week-header {
            display: flex;
            border-bottom: 1px solid #e5e7eb;
            background: #f9fafb;
        }
        
        .calendar-week-day-header {
            flex: 1;
            padding: 0.5rem;
            text-align: center;
            border-right: 1px solid #e5e7eb;
            min-width: 0;
        }
        
        .calendar-week-day-header:last-child {
            border-right: none;
        }
        
        .calendar-week-body {
            display: flex;
            max-height: calc(100vh - 300px);
            overflow-y: auto;
        }
        
        .calendar-week-day-column {
            flex: 1;
            border-right: 1px solid #e5e7eb;
            position: relative;
            min-width: 0;
        }
        
        .calendar-week-day-column:last-child {
            border-right: none;
        }
        
        .calendar-week-event {
            margin: 2px 4px;
            padding: 0.25rem 0.4rem;
            border-radius: 4px;
            font-size: 0.75rem;
            cursor: pointer;
            border-left: 3px solid;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        /* Month View */
        .calendar-month-view {
            background: white;
            border-radius: 12px;
            box-shadow: var(--shadow);
            overflow: hidden;
        }
        
        .calendar-month-header {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            background: #f9fafb;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .calendar-month-day-name {
            padding: 0.75rem;
            text-align: center;
            font-size: 0.75rem;
            font-weight: 500;
            color: var(--gray);
            text-transform: uppercase;
        }
        
        .calendar-month-body {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
        }
        
        .calendar-month-day {
            min-height: 100px;
            border-right: 1px solid #e5e7eb;
            border-bottom: 1px solid #e5e7eb;
            padding: 0.25rem;
        }
        
        .calendar-month-day:nth-child(7n) {
            border-right: none;
        }
        
        .calendar-month-day.other-month {
            background: #f9fafb;
        }
        
        .calendar-month-day.other-month .month-day-number {
            color: #d1d5db;
        }
        
        .calendar-month-day.today .month-day-number {
            background: var(--primary);
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        
        .month-day-number {
            font-size: 0.85rem;
            font-weight: 500;
            margin-bottom: 0.25rem;
        }
        
        .calendar-month-event {
            padding: 0.15rem 0.35rem;
            margin-bottom: 2px;
            border-radius: 3px;
            font-size: 0.7rem;
            cursor: pointer;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .calendar-month-more {
            font-size: 0.7rem;
            color: var(--gray);
            padding: 0.15rem 0.35rem;
            cursor: pointer;
        }
        
        .calendar-month-more:hover {
            color: var(--primary);
        }
        
        /* All-day events / No time tasks */
        .calendar-allday-section {
            border-bottom: 1px solid #e5e7eb;
            padding: 0.5rem;
            background: #fefce8;
            min-height: 40px;
        }
        
        .calendar-allday-label {
            font-size: 0.7rem;
            color: var(--gray);
            margin-bottom: 0.25rem;
        }
        
        .calendar-allday-event {
            display: inline-block;
            padding: 0.2rem 0.5rem;
            margin: 2px;
            border-radius: 4px;
            font-size: 0.75rem;
            cursor: pointer;
        }
        
        /* Current time indicator */
        .calendar-current-time {
            position: absolute;
            left: 0;
            right: 0;
            height: 2px;
            background: #ef4444;
            z-index: 10;
        }
        
        .calendar-current-time::before {
            content: '';
            position: absolute;
            left: -5px;
            top: -4px;
            width: 10px;
            height: 10px;
            background: #ef4444;
            border-radius: 50%;
        }
        
        /* List View (existing) */
        .calendar-list-view {
            /* existing table/card styles */
        }
        
        /* Mobile Calendar Styles - Google Calendar Style */
        @media (max-width: 767px) {
            .calendar-header {
                flex-wrap: nowrap;
                gap: 0.5rem;
                padding: 0.6rem 0.75rem;
                margin: 0 -0.5rem 0 -0.5rem;
                border-radius: 0;
                background: white;
                border-bottom: none;
                justify-content: space-between;
            }
            
            .calendar-view-switcher {
                display: none;
            }
            
            .calendar-nav {
                order: 1;
                gap: 0;
            }
            
            .calendar-nav-btn {
                width: 36px;
                height: 36px;
                background: transparent;
            }
            
            .calendar-title {
                order: 2;
                min-width: auto;
                font-size: 1.1rem;
                font-weight: 500;
                flex: 1;
                text-align: left;
                margin-left: 4px;
            }
            
            .calendar-today-btn {
                display: inline-flex;
                order: 3;
                padding: 0.4rem 0.8rem;
                font-size: 0.85rem;
                border: 1px solid #e5e7eb;
                background: white;
            }
            
            /* Hide add button in header on mobile - use FAB instead */
            .calendar-header .btn-success {
                display: none;
            }
            
            /* Hide day header on mobile - use week strip instead */
            .calendar-day-header {
                display: none;
            }
            
            .calendar-day-view {
                border-radius: 0;
                margin: 0 -0.5rem;
                box-shadow: none;
                border-top: none;
            }
            
            .calendar-time-gutter,
            .calendar-time-slots {
                width: 48px;
            }
            
            .calendar-time-slot {
                font-size: 0.75rem;
                padding: 0.2rem 0.4rem;
                text-align: right;
                color: #6b7280;
            }
            
            .calendar-day-body {
                max-height: calc(100vh - 260px);
                min-height: 400px;
            }
            
            .calendar-hour-row {
                height: 48px;
                cursor: pointer;
                transition: background 0.1s ease;
                -webkit-tap-highlight-color: transparent;
            }
            
            .calendar-hour-row:active {
                background: rgba(0, 122, 255, 0.15) !important;
            }
            
            /* Hint text on empty hours */
            .calendar-hour-row:empty::after {
                content: '';
            }
            
            /* Hide desktop day column header */
            .calendar-day-column-header {
                display: none;
            }
            
            .calendar-allday-section {
                margin: 0;
                padding: 8px 12px;
                background: #f9fafb;
                border-bottom: 1px solid #e5e7eb;
            }
            
            .calendar-event {
                font-size: 0.85rem;
                padding: 6px 8px;
                left: 2px;
                right: 2px;
                border-radius: 8px;
                border-left-width: 4px;
                min-height: 26px;
            }
            
            .calendar-event-title {
                font-size: 0.85rem;
                font-weight: 600;
            }
            
            .calendar-event-time {
                display: block;
                font-size: 0.75rem;
                opacity: 0.85;
                margin-top: 2px;
            }
            
            .calendar-allday-event {
                font-size: 0.85rem;
                padding: 8px 10px;
                border-radius: 8px;
                margin-bottom: 4px;
            }
            
            /* Week view on mobile */
            .calendar-week-view {
                border-radius: 0;
                margin: 0 -0.5rem;
            }
            
            .calendar-week-header {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                display: flex;
            }
            
            .calendar-week-day-header {
                min-width: 90px;
                flex-shrink: 0;
                padding: 0.5rem 0.25rem;
            }
            
            .calendar-week-body {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                display: flex;
            }
            
            .calendar-week-day-column {
                min-width: 90px;
                flex-shrink: 0;
            }
            
            /* Month view on mobile */
            .calendar-month-view {
                border-radius: 0;
                margin: 0 -0.5rem;
            }
            
            .calendar-month-day {
                min-height: 55px;
                padding: 0.15rem;
            }
            
            .month-day-number {
                font-size: 0.75rem;
            }
            
            .calendar-month-event {
                font-size: 0.6rem;
                padding: 0.1rem 0.15rem;
            }
            
            .calendar-month-more {
                font-size: 0.6rem;
            }
            
            /* Regular calendar mobile */
            .regular-week-view {
                border-radius: 0;
                margin: 0 -0.5rem;
            }
            
            .regular-week-header {
                display: flex;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .regular-week-day-header {
                min-width: 120px;
                flex-shrink: 0;
                padding: 0.6rem 0.3rem;
            }
            
            .regular-week-day-header .day-name {
                font-size: 0.85rem;
            }
            
            .regular-week-body {
                display: flex;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                scroll-snap-type: x mandatory;
                padding-bottom: 8px;
            }
            
            .regular-week-day-column {
                min-width: 85%;
                max-width: 85%;
                flex-shrink: 0;
                padding: 0.5rem;
                scroll-snap-align: start;
            }
            
            .regular-task-card {
                padding: 0.75rem;
                padding-right: 50px;
                margin-bottom: 0.75rem;
            }
            
            .regular-task-card .task-title {
                font-size: 0.9rem;
                line-height: 1.3;
            }
            
            .regular-task-card .task-time {
                font-size: 0.8rem;
            }
            
            .regular-task-complete-btn {
                width: 36px;
                height: 36px;
            }
            
            .regular-day-empty {
                padding: 2rem 0.5rem;
                font-size: 0.85rem;
            }
            
            /* Scroll indicator */
            .regular-week-body::after {
                content: '';
                min-width: 15%;
                flex-shrink: 0;
            }
        }
        
        /* iOS Safe Areas */
        @supports (padding-bottom: env(safe-area-inset-bottom)) {
            .bottom-nav {
                padding-bottom: calc(0.5rem + env(safe-area-inset-bottom));
            }
            
            .calendar-day-body {
                max-height: calc(100vh - 280px - env(safe-area-inset-bottom));
            }
        }
        
        /* Mobile Regular Tasks Day Tabs */
        .mobile-regular-tabs {
            display: none;
        }
        
        .mobile-regular-day-view {
            display: none;
        }
        
        @media (max-width: 767px) {
            .mobile-regular-tabs {
                display: block;
                background: white;
                padding: 12px 8px;
                margin: 0 -0.5rem;
                border-bottom: 1px solid #e5e7eb;
            }
            
            .regular-day-tabs {
                display: flex;
                justify-content: space-between;
                gap: 4px;
            }
            
            .regular-day-tab {
                flex: 1;
                padding: 10px 4px;
                border: none;
                background: #f3f4f6;
                border-radius: 10px;
                font-size: 0.85rem;
                font-weight: 600;
                color: #6b7280;
                cursor: pointer;
                transition: all 0.2s;
                -webkit-tap-highlight-color: transparent;
            }
            
            .regular-day-tab:active {
                transform: scale(0.95);
            }
            
            .regular-day-tab.active {
                background: var(--primary);
                color: white;
            }
            
            .regular-day-tab.today:not(.active) {
                background: #e0e7ff;
                color: var(--primary);
            }
            
            .regular-day-tab.has-tasks::after {
                content: '';
                display: block;
                width: 5px;
                height: 5px;
                background: currentColor;
                border-radius: 50%;
                margin: 4px auto 0;
                opacity: 0.6;
            }
            
            .mobile-regular-day-view {
                display: block;
                background: #f9fafb;
                min-height: calc(100vh - 350px);
                padding: 12px;
                margin: 0 -0.5rem;
            }
            
            .mobile-regular-day-content {
                max-height: calc(100vh - 380px);
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .mobile-regular-empty {
                text-align: center;
                padding: 60px 20px;
                color: #9ca3af;
            }
            
            .mobile-regular-empty-icon {
                font-size: 3rem;
                margin-bottom: 12px;
                opacity: 0.5;
            }
            
            .mobile-regular-empty-text {
                font-size: 1rem;
                font-weight: 500;
            }
            
            .mobile-regular-section-header {
                display: flex;
                align-items: center;
                gap: 8px;
                font-size: 0.85rem;
                font-weight: 600;
                color: #6b7280;
                padding: 16px 4px 8px;
                margin-top: 8px;
                border-top: 1px solid #e5e7eb;
            }
            
            .mobile-regular-section-header:first-child {
                border-top: none;
                margin-top: 0;
                padding-top: 0;
            }
            
            /* Hide desktop week view on mobile */
            .regular-calendar-container {
                display: none !important;
            }
            
            /* Bigger task cards on mobile */
            .mobile-regular-day-view .regular-task-card {
                padding: 16px;
                padding-right: 56px;
                margin-bottom: 12px;
                border-radius: 12px;
            }
            
            .mobile-regular-day-view .regular-task-card .task-title {
                font-size: 1rem;
                margin-bottom: 6px;
            }
            
            .mobile-regular-day-view .regular-task-card .task-time {
                font-size: 0.85rem;
                margin-bottom: 6px;
            }
            
            .mobile-regular-day-view .regular-task-card .task-assignee {
                font-size: 0.8rem;
            }
            
            .mobile-regular-day-view .regular-task-card .task-function {
                font-size: 0.75rem;
                padding: 4px 8px;
            }
            
            .mobile-regular-day-view .regular-task-complete-btn {
                width: 40px;
                height: 40px;
                right: 12px;
            }
            
            .mobile-regular-day-view .regular-task-complete-btn svg {
                width: 20px;
                height: 20px;
            }
            
            /* Hide regular header view switcher on mobile */
            #regularCalendarHeader .calendar-view-switcher {
                display: none;
            }
            
            #regularCalendarHeader h3 {
                font-size: 1rem !important;
            }
        }
        
        /* Demo Data Options */
        .demo-option-btn {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
            width: 100%;
        }
        
        .demo-option-btn:hover {
            border-color: var(--primary);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
        }
        
        .demo-option-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .demo-option-info {
            flex: 1;
            min-width: 0;
        }
        
        .demo-option-info strong {
            display: block;
            font-size: 1rem;
            color: var(--dark);
            margin-bottom: 0.25rem;
        }
        
        .demo-option-info span {
            font-size: 0.8rem;
            color: var(--gray);
        }
        
        /* Hide calendar on desktop when list is active */
        .calendar-container {
            display: none;
        }
        
        .calendar-container.active {
            display: block;
        }
        
        .list-container {
            display: none;
        }
        
        .list-container.active {
            display: block;
        }
        
        /* ===================== */
        /* REGULAR CALENDAR      */
        /* ===================== */
        
        .regular-calendar-container {
            display: none;
        }
        
        .regular-calendar-container.active {
            display: block;
        }
        
        .regular-list-container {
            display: none;
        }
        
        .regular-list-container.active {
            display: block;
        }
        
        .regular-week-view {
            background: white;
            border-radius: 12px;
            box-shadow: var(--shadow);
            overflow: hidden;
        }
        
        .regular-week-header {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            background: #f9fafb;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .regular-week-day-header {
            padding: 1rem 0.5rem;
            text-align: center;
            border-right: 1px solid #e5e7eb;
        }
        
        .regular-week-day-header:last-child {
            border-right: none;
        }
        
        .regular-week-day-header .day-name {
            font-weight: 600;
            color: var(--dark);
            font-size: 0.9rem;
        }
        
        .regular-week-day-header.today {
            background: #ecfdf5;
        }
        
        .regular-week-day-header.today .day-name {
            color: var(--success);
        }
        
        .regular-week-body {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            min-height: 400px;
        }
        
        .regular-week-day-column {
            border-right: 1px solid #e5e7eb;
            padding: 0.5rem;
            min-height: 300px;
        }
        
        .regular-week-day-column:last-child {
            border-right: none;
        }
        
        .regular-week-day-column.today {
            background: #f0fdf4;
        }
        
        .regular-task-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-left: 4px solid var(--primary);
            border-radius: 8px;
            padding: 0.6rem;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        
        .regular-task-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-1px);
        }
        
        .regular-task-card .task-time {
            font-size: 0.75rem;
            color: var(--gray);
            margin-bottom: 0.25rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
        
        .regular-task-card .task-title {
            font-weight: 500;
            font-size: 0.85rem;
            color: var(--dark);
            margin-bottom: 0.25rem;
            padding-right: 40px;
        }
        
        .regular-task-card .task-assignee {
            font-size: 0.7rem;
            color: var(--gray);
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
        
        .regular-task-card .task-function {
            font-size: 0.65rem;
            background: #e0e7ff;
            color: #4338ca;
            padding: 0.15rem 0.4rem;
            border-radius: 4px;
            display: inline-block;
            margin-top: 0.25rem;
        }
        
        /* Complete button for regular tasks */
        .regular-task-complete-btn {
            position: absolute;
            top: 50%;
            right: 8px;
            transform: translateY(-50%);
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 2px solid #d1d5db;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            z-index: 5;
        }
        
        .regular-task-complete-btn:hover {
            border-color: var(--success);
            background: #f0fdf4;
        }
        
        .regular-task-complete-btn:active {
            transform: translateY(-50%) scale(0.9);
        }
        
        .regular-task-complete-btn svg {
            width: 16px;
            height: 16px;
            color: #d1d5db;
            transition: color 0.2s;
        }
        
        .regular-task-complete-btn:hover svg {
            color: var(--success);
        }
        
        .regular-task-complete-btn.completed {
            border-color: var(--success);
            background: var(--success);
        }
        
        .regular-task-complete-btn.completed svg {
            color: white;
        }
        
        .regular-task-card.completed {
            opacity: 0.6;
            border-left-color: var(--success);
        }
        
        .regular-task-card.completed .task-title {
            text-decoration: line-through;
            color: var(--gray);
        }
        
        /* Empty day placeholder */
        .regular-day-empty {
            text-align: center;
            color: #d1d5db;
            font-size: 0.8rem;
            padding: 2rem 0.5rem;
        }
        
        /* ===================== */
        /* IMPROVED LIST VIEW    */
        /* ===================== */
        
        .task-list-card {
            background: white;
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            border-left: 4px solid var(--gray);
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .task-list-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .task-list-card.priority-high { border-left-color: var(--danger); }
        .task-list-card.priority-medium { border-left-color: var(--warning); }
        .task-list-card.priority-low { border-left-color: var(--success); }
        
        .task-list-card.status-done {
            opacity: 0.6;
            border-left-color: var(--success);
        }
        
        .task-list-checkbox {
            width: 22px;
            height: 22px;
            border: 2px solid #d1d5db;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: all 0.2s;
        }
        
        .task-list-checkbox:hover {
            border-color: var(--success);
            background: #ecfdf5;
        }
        
        .task-list-checkbox.checked {
            background: var(--success);
            border-color: var(--success);
        }
        
        .task-list-checkbox.checked svg {
            color: white;
        }
        
        .task-list-content {
            flex: 1;
            min-width: 0;
        }
        
        .task-list-title {
            font-weight: 500;
            font-size: 1rem;
            color: var(--dark);
            margin-bottom: 0.35rem;
        }
        
        .task-list-card.status-done .task-list-title {
            text-decoration: line-through;
            color: var(--gray);
        }
        
        .task-list-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            font-size: 0.8rem;
            color: var(--gray);
        }
        
        .task-list-meta-item {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
        
        .task-list-meta-item.overdue {
            color: var(--danger);
            font-weight: 500;
        }
        
        .task-list-actions {
            display: flex;
            gap: 0.5rem;
            flex-shrink: 0;
        }
        
        /* Mobile Regular Calendar */
        @media (max-width: 767px) {
            .regular-week-header {
                display: flex;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .regular-week-day-header {
                min-width: 80px;
                flex-shrink: 0;
            }
            
            .regular-week-body {
                display: flex;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .regular-week-day-column {
                min-width: 150px;
                flex-shrink: 0;
            }
            
            .task-list-card {
                flex-direction: column;
                gap: 0.75rem;
            }
            
            .task-list-actions {
                width: 100%;
                justify-content: flex-end;
            }
        }
        
        /* ===================== */
        /* COMMENTS SYSTEM       */
        /* ===================== */
        
        .comments-section {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 2px solid #e5e7eb;
        }
        
        .comments-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
            color: var(--dark);
            font-weight: 600;
            font-size: 0.95rem;
        }
        
        .comments-header .comment-count {
            background: var(--primary);
            color: white;
            font-size: 0.75rem;
            padding: 0.15rem 0.5rem;
            border-radius: 10px;
            font-weight: 600;
        }
        
        .comments-list {
            max-height: 250px;
            overflow-y: auto;
            margin-bottom: 1rem;
            padding-right: 0.5rem;
        }
        
        .comments-list::-webkit-scrollbar {
            width: 6px;
        }
        
        .comments-list::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }
        
        .comments-list::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }
        
        .comment-item {
            background: #f9fafb;
            border-radius: 12px;
            padding: 0.75rem 1rem;
            margin-bottom: 0.75rem;
            border-left: 3px solid var(--primary);
            animation: slideIn 0.2s ease-out;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .comment-item.own-comment {
            background: #ecfdf5;
            border-left-color: var(--success);
        }
        
        .comment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.4rem;
        }
        
        .comment-author {
            font-weight: 600;
            font-size: 0.85rem;
            color: var(--dark);
        }
        
        .comment-time {
            font-size: 0.75rem;
            color: var(--gray);
        }
        
        .comment-text {
            font-size: 0.9rem;
            color: #374151;
            line-height: 1.5;
            white-space: pre-wrap;
            word-break: break-word;
        }
        
        .comment-input-wrapper {
            display: flex;
            gap: 0.5rem;
            align-items: flex-end;
        }
        
        .comment-input {
            flex: 1;
            min-height: 44px;
            max-height: 120px;
            padding: 0.6rem 0.9rem;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 0.9rem;
            resize: none;
            font-family: inherit;
            transition: border-color 0.2s;
        }
        
        .comment-input:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        .comment-send-btn {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            background: var(--primary);
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            flex-shrink: 0;
        }
        
        .comment-send-btn:hover {
            background: var(--primary-dark);
        }
        
        .comment-send-btn:disabled {
            background: #d1d5db;
            cursor: not-allowed;
        }
        
        .comments-empty {
            text-align: center;
            padding: 1.5rem;
            color: var(--gray);
            font-size: 0.9rem;
        }
        
        .comments-section.hidden { display: none; }
        
        @media (max-width: 767px) {
            .comments-list { max-height: 200px; }
            .comment-input { font-size: 16px; }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <i data-lucide="rocket" class="icon"></i> TALKO System
                <span class="company-badge" id="companyBadge" style="display:none;"></span>
            </div>
            <div class="header-actions">
                <a href="https://chatgpt.com/g/g-684bb075301481918669f787231e1af7-radar-ai-alex-talko" target="_blank" class="header-ai-btn" title="Питання до керівника">
                    <i data-lucide="target" class="icon"></i> <span data-i18n="radarAI">Керівник</span>
                </a>
                <a href="https://chatgpt.com/g/g-685640bc592881918743da9332b83f31-ai-alex-talko-technical-lead" target="_blank" class="header-ai-btn tech" title="Помічник">
                    <i data-lucide="wrench" class="icon"></i> <span data-i18n="techAI">Помічник</span>
                </a>
                <div class="lang-switcher">
                    <button class="lang-btn active" onclick="setLanguage('ua')" id="langUA">UA</button>
                    <button class="lang-btn" onclick="setLanguage('ru')" id="langRU">RU</button>
                </div>
                <div class="user-info" id="currentUserInfo" onclick="openProfileModal()" style="cursor:pointer;" title="Мій профіль">
                    <span><i data-lucide="user" class="icon"></i> <span id="currentUserName">...</span></span>
                    <span id="currentUserRole" style="opacity:0.8;font-size:0.8rem;"></span>
                </div>
                <button class="header-btn" onclick="logout()" id="logoutBtn" style="display:none;"><i data-lucide="log-out" class="icon"></i> <span data-i18n="logout">Вийти</span></button>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- LOADING -->
        <div id="loadingPage" class="loading">
            <div class="spinner"></div>
        </div>

        <!-- AUTH PAGE -->
        <div id="authPage" class="auth-container" style="display:none;">
            <div class="auth-card">
                <div class="auth-header">
                    <h2><i data-lucide="rocket" class="icon icon-lg"></i> TALKO System</h2>
                    <p data-i18n="authSubtitle">Управління завданнями для бізнесу</p>
                </div>
                <div class="auth-body">
                    <div id="authMessage" class="auth-message" style="display:none;"></div>
                    
                    <!-- NO ACCESS -->
                    <div id="noAccessCard" class="no-access-card" style="display:none;">
                        <h3 data-i18n="noAccessTitle"><i data-lucide="ban" class="icon"></i> Доступ відсутній</h3>
                        <p data-i18n="noAccessText">Ваш email не зареєстровано в системі.<br>Зверніться до адміністратора для отримання доступу.</p>
                        <a href="https://alextalko.com" target="_blank" class="btn btn-success"><i data-lucide="phone" class="icon"></i> <span data-i18n="contactSupport">Зв'язатися з підтримкою</span></a>
                        <button onclick="logout()" class="btn" style="margin-top:0.5rem;"><i data-lucide="refresh-cw" class="icon"></i> <span data-i18n="tryAnotherEmail">Спробувати інший email</span></button>
                    </div>
                    
                    <!-- LOGIN FORM -->
                    <div id="loginForm">
                        <div class="form-group">
                            <label class="form-label">Email:</label>
                            <input type="email" id="loginEmail" class="form-input" placeholder="your@email.com">
                        </div>
                        <div class="form-group" style="margin-top:0.75rem;">
                            <label class="form-label" data-i18n="password">Пароль:</label>
                            <div class="input-wrapper">
                                <input type="password" id="loginPassword" class="form-input" placeholder="••••••••">
                                <button type="button" class="password-toggle" onclick="togglePassword('loginPassword', this)"><i data-lucide="eye" class="icon icon-sm"></i></button>
                            </div>
                        </div>
                        <button onclick="signInWithEmail()" class="btn btn-success" style="width:100%;margin-top:1rem;">
                            <i data-lucide="log-in" class="icon"></i> <span data-i18n="signIn">Увійти</span>
                        </button>
                        <p style="text-align:center;margin-top:0.75rem;font-size:0.85rem;">
                            <a href="#" onclick="resetPassword()" style="color:var(--info);" data-i18n="forgotPassword">Забули пароль?</a>
                        </p>
                        <div class="auth-divider"><span data-i18n="haveInvite">Є запрошення?</span></div>
                        <button onclick="showRegisterForm()" class="btn" style="width:100%;background:#9b59b6;">
                            <i data-lucide="user-plus" class="icon"></i> <span data-i18n="registerBtn">Зареєструватися</span>
                        </button>
                        <p style="text-align:center;margin-top:1rem;font-size:0.8rem;color:var(--gray);">
                            <span data-i18n="noAccess">Немає доступу?</span> <a href="https://alextalko.com" target="_blank" style="color:var(--info);" data-i18n="contactUs">Зв'яжіться з нами</a>
                        </p>
                    </div>
                    
                    <!-- REGISTER FORM -->
                    <div id="registerForm" style="display:none;">
                        <h3 style="text-align:center;margin-bottom:1rem;color:var(--dark);"><i data-lucide="user-plus" class="icon"></i> <span data-i18n="registerTitle">Реєстрація за запрошенням</span></h3>
                        <div class="form-group">
                            <label class="form-label">Email:</label>
                            <input type="email" id="registerEmail" class="form-input" placeholder="your@email.com">
                        </div>
                        <div class="form-group" style="margin-top:0.75rem;">
                            <label class="form-label" data-i18n="createPassword">Придумайте пароль:</label>
                            <div class="input-wrapper">
                                <input type="password" id="registerPassword" class="form-input" placeholder="мінімум 6 символів">
                                <button type="button" class="password-toggle" onclick="togglePassword('registerPassword', this)"><i data-lucide="eye" class="icon icon-sm"></i></button>
                            </div>
                        </div>
                        <div class="form-group" style="margin-top:0.75rem;">
                            <label class="form-label" data-i18n="confirmPassword">Підтвердіть пароль:</label>
                            <div class="input-wrapper">
                                <input type="password" id="registerPasswordConfirm" class="form-input" placeholder="••••••••">
                                <button type="button" class="password-toggle" onclick="togglePassword('registerPasswordConfirm', this)"><i data-lucide="eye" class="icon icon-sm"></i></button>
                            </div>
                        </div>
                        <button onclick="registerWithInvite()" class="btn btn-success" style="width:100%;margin-top:1rem;">
                            <i data-lucide="check" class="icon"></i> <span data-i18n="registerSubmit">Зареєструватися</span>
                        </button>
                        <p style="text-align:center;margin-top:1rem;">
                            <a href="#" onclick="showLoginForm()" style="color:var(--info);" data-i18n="backToLogin">← Повернутися до входу</a>
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- MAIN INTERFACE -->
        <div id="mainInterface" class="main-interface">
            <div class="tab-navigation">
                <button class="tab-btn active" onclick="switchTab('tasks')"><i data-lucide="clipboard-list" class="icon"></i> <span data-i18n="tabTasks">Завдання</span></button>
                <button class="tab-btn" onclick="switchTab('control')"><i data-lucide="layout-dashboard" class="icon"></i> <span data-i18n="tabControl">Контроль</span></button>
                <button class="tab-btn" onclick="switchTab('regular')"><i data-lucide="repeat" class="icon"></i> <span data-i18n="tabRegular">Регулярні</span></button>
                <button class="tab-btn" onclick="switchTab('functions')"><i data-lucide="settings" class="icon"></i> <span data-i18n="tabFunctions">Функції</span></button>
                <button class="tab-btn" onclick="switchTab('users')"><i data-lucide="users" class="icon"></i> <span data-i18n="tabUsers">Співробітники</span></button>
                <button class="tab-btn" onclick="switchTab('analytics')"><i data-lucide="bar-chart-3" class="icon"></i> <span data-i18n="tabAnalytics">Аналітика</span></button>
                <button class="tab-btn" onclick="switchTab('admin')" id="adminTabBtn" style="display:none;background:#fee2e2;color:#dc2626;"><i data-lucide="shield" class="icon"></i> <span data-i18n="tabAdmin">Адмін</span></button>
            </div>

            <!-- TASKS -->
            <div id="tasksTab" class="tab-content active">
                
                <!-- Calendar Header with Navigation -->
                <div class="calendar-header" id="calendarHeader">
                    <div class="calendar-nav">
                        <button class="calendar-nav-btn" onclick="calendarPrev()">
                            <i data-lucide="chevron-left" class="icon"></i>
                        </button>
                        <button class="calendar-today-btn" onclick="calendarToday()">Сьогодні</button>
                        <button class="calendar-nav-btn" onclick="calendarNext()">
                            <i data-lucide="chevron-right" class="icon"></i>
                        </button>
                    </div>
                    
                    <div class="calendar-title" id="calendarTitle">Грудень 2024</div>
                    
                    <div style="display:flex;align-items:center;gap:0.5rem;">
                        <div class="calendar-view-switcher">
                            <button class="calendar-view-btn active" data-view="day" onclick="setCalendarView('day')">День</button>
                            <button class="calendar-view-btn" data-view="week" onclick="setCalendarView('week')">Тиждень</button>
                            <button class="calendar-view-btn" data-view="month" onclick="setCalendarView('month')">Місяць</button>
                            <button class="calendar-view-btn" data-view="list" onclick="setCalendarView('list')">Список</button>
                        </div>
                        <button class="btn btn-success" onclick="openTaskModal()">
                            <i data-lucide="plus" class="icon"></i> <span class="hide-mobile">Додати</span>
                        </button>
                    </div>
                </div>
                
                <!-- Mobile Week Strip (Google Calendar style) -->
                <div class="mobile-week-strip" id="mobileWeekStrip">
                    <div class="week-strip-days" id="weekStripDays">
                        <!-- Generated by JS -->
                    </div>
                </div>
                
                <!-- Calendar Container -->
                <div class="calendar-container active" id="calendarContainer">
                    <!-- Day View -->
                    <div class="calendar-day-view" id="calendarDayView">
                        <div class="calendar-day-header">
                            <div class="calendar-time-gutter"></div>
                            <div class="calendar-day-column-header today" id="dayColumnHeader">
                                <div class="day-name">Середа</div>
                                <div class="day-number">25</div>
                            </div>
                        </div>
                        <div class="calendar-allday-section" id="calendarAllday">
                            <div class="calendar-allday-label">Без часу</div>
                        </div>
                        <div class="calendar-day-body" id="calendarDayBody">
                            <div class="calendar-time-slots" id="calendarTimeSlots"></div>
                            <div class="calendar-events-container" id="calendarEventsContainer">
                                <div class="calendar-current-time" id="currentTimeLine" style="display:none;"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Week View -->
                    <div class="calendar-week-view" id="calendarWeekView" style="display:none;">
                        <div class="calendar-week-header" id="weekHeader"></div>
                        <div class="calendar-week-body" id="weekBody"></div>
                    </div>
                    
                    <!-- Month View -->
                    <div class="calendar-month-view" id="calendarMonthView" style="display:none;">
                        <div class="calendar-month-header">
                            <div class="calendar-month-day-name">Нд</div>
                            <div class="calendar-month-day-name">Пн</div>
                            <div class="calendar-month-day-name">Вт</div>
                            <div class="calendar-month-day-name">Ср</div>
                            <div class="calendar-month-day-name">Чт</div>
                            <div class="calendar-month-day-name">Пт</div>
                            <div class="calendar-month-day-name">Сб</div>
                        </div>
                        <div class="calendar-month-body" id="monthBody"></div>
                    </div>
                </div>
                
                <!-- List Container (existing table view) -->
                <div class="list-container" id="listContainer">
                    <!-- Mobile filter bar -->
                    <div class="mobile-filter-bar" id="mobileFilterBar">
                        <button class="mobile-filter-btn" onclick="setMobileQuickFilter('my')">
                            <i data-lucide="user" class="icon icon-sm"></i> Мої
                        </button>
                        <button class="mobile-filter-btn" onclick="setMobileQuickFilter('today')">
                            <i data-lucide="calendar" class="icon icon-sm"></i> Сьогодні
                        </button>
                        <button class="mobile-filter-btn" onclick="openFilterModal()">
                            <i data-lucide="sliders" class="icon icon-sm"></i> Фільтри
                            <span class="filter-count" id="activeFilterCount" style="display:none;">0</span>
                        </button>
                    </div>
                    
                    <div class="controls">
                        <div class="controls-row">
                            <button class="btn btn-success" onclick="openTaskModal()"><i data-lucide="plus" class="icon"></i> <span data-i18n="addTask">Додати завдання</span></button>
                            <button class="btn" style="background:#2ecc71;" onclick="exportTasksCSV()"><i data-lucide="download" class="icon"></i> Експорт CSV</button>
                        </div>
                        <div class="filters-row">
                            <button class="btn btn-clear" onclick="clearTaskFilters()"><i data-lucide="x" class="icon"></i> <span data-i18n="clear">Очистити</span></button>
                            <select class="filter-select" id="taskTypeFilter" onchange="renderTasks()">
                                <option value="" data-i18n="allTasks">Всі завдання</option>
                                <option value="my" data-i18n="myTasks">Мої завдання</option>
                                <option value="created" data-i18n="createdByMe">Створені мною</option>
                            </select>
                            <select class="filter-select" id="dateFilter" onchange="handleDateFilter()">
                                <option value="" data-i18n="allDates">Всі дати</option>
                                <option value="today" data-i18n="today">Сьогодні</option>
                                <option value="week" data-i18n="thisWeek">Цей тиждень</option>
                                <option value="month" data-i18n="thisMonth">Цей місяць</option>
                                <option value="overdue" data-i18n="overdue">Прострочені</option>
                                <option value="custom" data-i18n="customPeriod">Обрати період</option>
                            </select>
                            <div id="customDateRange" style="display:none;gap:0.5rem;align-items:center;">
                                <input type="date" id="dateFrom" class="form-input" style="width:auto;padding:0.4rem;" onchange="renderTasks()">
                                <span>—</span>
                                <input type="date" id="dateTo" class="form-input" style="width:auto;padding:0.4rem;" onchange="renderTasks()">
                            </div>
                            <select class="filter-select" id="statusFilter" onchange="renderTasks()">
                                <option value="" data-i18n="statuses">Статуси</option>
                                <option value="new" data-i18n="statusNew">Нові</option>
                                <option value="progress" data-i18n="statusProgress">В роботі</option>
                                <option value="review" data-i18n="statusReview">Перевірка</option>
                                <option value="done" data-i18n="statusDone">Готово</option>
                            </select>
                            <select class="filter-select" id="functionFilter" onchange="renderTasks()"><option value="" data-i18n="functions">Функції</option></select>
                            <select class="filter-select" id="assigneeFilter" onchange="renderTasks()"><option value="" data-i18n="assignees">Виконавці</option></select>
                        </div>
                    </div>
                    <div id="totalTimeInfo" class="total-time-container"></div>
                    <div class="table-container" id="tasksContainer">
                        <div class="loading"><div class="spinner"></div></div>
                    </div>
                </div>
            </div>

            <!-- CONTROL -->
            <div id="controlTab" class="tab-content">
                <div class="controls">
                    <h2 style="font-size:1.2rem;margin-bottom:0;" data-i18n="controlPanelTitle">Панель контролю завдань</h2>
                </div>
                <div class="filters-row" style="background:white;padding:1rem;border-radius:12px;margin-bottom:1rem;box-shadow:var(--shadow);">
                    <span style="display:flex;align-items:center;gap:0.3rem;"><i data-lucide="user" class="icon icon-sm"></i> <span data-i18n="assigneeLabel">Виконавець:</span></span>
                    <select class="filter-select" id="controlAssigneeFilter" onchange="renderControl()"><option value="" data-i18n="allAssignees">Всі виконавці</option></select>
                    <span style="display:flex;align-items:center;gap:0.3rem;"><i data-lucide="tag" class="icon icon-sm"></i> <span data-i18n="functionLabel">Функція:</span></span>
                    <select class="filter-select" id="controlFunctionFilter" onchange="renderControl()"><option value="" data-i18n="allFunctions">Всі функції</option></select>
                    <span style="display:flex;align-items:center;gap:0.3rem;"><i data-lucide="calendar" class="icon"></i> <span data-i18n="periodLabel">Період:</span></span>
                    <select class="filter-select" id="controlPeriodFilter" onchange="renderControl()">
                        <option value="" data-i18n="allTime">Весь час</option>
                        <option value="today" data-i18n="today">Сьогодні</option>
                        <option value="week" data-i18n="thisWeek">Цей тиждень</option>
                        <option value="month" data-i18n="thisMonth">Цей місяць</option>
                    </select>
                    <button class="btn btn-clear" onclick="clearControlFilters()"><i data-lucide="x" class="icon"></i> <span data-i18n="clear">Очистити</span></button>
                </div>
                <div style="background:white;border-radius:12px;padding:1rem;box-shadow:var(--shadow);">
                    <div class="dashboard-cards">
                        <div class="dashboard-card urgent">
                            <h3><i data-lucide="alert-triangle" class="icon"></i> <span data-i18n="critical">Критичні</span></h3>
                            <div class="dashboard-number" id="urgentCount">0</div>
                            <div class="dashboard-subtitle" data-i18n="overdueLabel">Прострочені</div>
                        </div>
                        <div class="dashboard-card warning">
                            <h3><i data-lucide="alert-circle" class="icon"></i> <span data-i18n="attention">Увага</span></h3>
                            <div class="dashboard-number" id="warningCount">0</div>
                            <div class="dashboard-subtitle" data-i18n="todayTomorrow">Сьогодні-завтра</div>
                        </div>
                        <div class="dashboard-card active">
                            <h3><i data-lucide="loader" class="icon"></i> <span data-i18n="active">Активні</span></h3>
                            <div class="dashboard-number" id="activeCount">0</div>
                            <div class="dashboard-subtitle" data-i18n="inWork">В роботі</div>
                        </div>
                        <div class="dashboard-card completed">
                            <h3><i data-lucide="check-circle" class="icon"></i> <span data-i18n="completed">Готово</span></h3>
                            <div class="dashboard-number" id="completedCount">0</div>
                            <div class="dashboard-subtitle" data-i18n="completedLabel">Завершені</div>
                        </div>
                    </div>
                    <div style="margin-top:1rem;padding:1rem;background:#f8f9fa;border-radius:8px;">
                        <div style="display:flex;align-items:center;gap:0.5rem;margin-bottom:0.5rem;">
                            <span data-i18n="viewLabel">Перегляд:</span>
                            <select class="filter-select" id="controlViewType" onchange="renderControlContent()" style="min-width:150px;">
                                <option value="workload" data-i18n="workload">Навантаження</option>
                                <option value="functions" data-i18n="byFunctions">По функціях</option>
                            </select>
                        </div>
                    </div>
                    <div id="controlContent" style="margin-top:1rem;"></div>
                </div>
            </div>

            <!-- REGULAR -->
            <div id="regularTab" class="tab-content">
                <!-- Regular Tasks Calendar Header -->
                <div class="calendar-header" id="regularCalendarHeader">
                    <div style="display:flex;align-items:center;gap:1rem;">
                        <h3 style="margin:0;font-size:1.1rem;"><i data-lucide="repeat" class="icon"></i> Регулярні завдання</h3>
                    </div>
                    
                    <div style="display:flex;align-items:center;gap:0.5rem;">
                        <div class="calendar-view-switcher">
                            <button class="calendar-view-btn active" data-view="week" onclick="setRegularView('week')">Тиждень</button>
                            <button class="calendar-view-btn" data-view="list" onclick="setRegularView('list')">Список</button>
                        </div>
                        <button class="btn btn-success" onclick="openRegularTaskModal()">
                            <i data-lucide="plus" class="icon"></i> <span class="hide-mobile">Додати</span>
                        </button>
                    </div>
                </div>
                
                <!-- Mobile Day Tabs for Regular Tasks -->
                <div class="mobile-regular-tabs" id="mobileRegularTabs">
                    <div class="regular-day-tabs" id="regularDayTabs">
                        <button class="regular-day-tab" data-day="0" onclick="selectRegularDay(0)">Нд</button>
                        <button class="regular-day-tab" data-day="1" onclick="selectRegularDay(1)">Пн</button>
                        <button class="regular-day-tab" data-day="2" onclick="selectRegularDay(2)">Вт</button>
                        <button class="regular-day-tab" data-day="3" onclick="selectRegularDay(3)">Ср</button>
                        <button class="regular-day-tab" data-day="4" onclick="selectRegularDay(4)">Чт</button>
                        <button class="regular-day-tab" data-day="5" onclick="selectRegularDay(5)">Пт</button>
                        <button class="regular-day-tab" data-day="6" onclick="selectRegularDay(6)">Сб</button>
                    </div>
                </div>
                
                <!-- Mobile Single Day View -->
                <div class="mobile-regular-day-view" id="mobileRegularDayView">
                    <div class="mobile-regular-day-content" id="mobileRegularDayContent">
                        <!-- Generated by JS -->
                    </div>
                </div>
                
                <!-- Regular Calendar View (Week) - Desktop only -->
                <div class="regular-calendar-container active" id="regularCalendarContainer">
                    <div class="regular-week-view" id="regularWeekView">
                        <div class="regular-week-header" id="regularWeekHeader"></div>
                        <div class="regular-week-body" id="regularWeekBody"></div>
                    </div>
                </div>
                
                <!-- Regular List View -->
                <div class="regular-list-container" id="regularListContainer" style="display:none;">
                    <div class="filters-row" style="background:white;padding:1rem;border-radius:12px;margin-bottom:1rem;box-shadow:var(--shadow);">
                        <button class="btn btn-success" onclick="filterRegularToday()" id="regularTodayBtn"><i data-lucide="calendar-check" class="icon"></i> <span data-i18n="todaysTasks">Сьогодні</span></button>
                        <select class="filter-select" id="regularDayFilter" onchange="renderRegularTasks()">
                            <option value="" data-i18n="allDays">Всі дні</option>
                            <option value="1" data-i18n="monday">Понеділок</option>
                            <option value="2" data-i18n="tuesday">Вівторок</option>
                            <option value="3" data-i18n="wednesday">Середа</option>
                            <option value="4" data-i18n="thursday">Четвер</option>
                            <option value="5" data-i18n="friday">П'ятниця</option>
                            <option value="6" data-i18n="saturday">Субота</option>
                            <option value="0" data-i18n="sunday">Неділя</option>
                        </select>
                        <select class="filter-select" id="regularFunctionFilter" onchange="renderRegularTasks()"><option value="" data-i18n="allFunctions">Всі функції</option></select>
                        <select class="filter-select" id="regularAssigneeFilter" onchange="renderRegularTasks()"><option value="" data-i18n="allAssignees">Всі виконавці</option></select>
                        <button class="btn btn-clear" onclick="clearRegularFilters()"><i data-lucide="x" class="icon"></i> <span data-i18n="clear">Очистити</span></button>
                    </div>
                    <div class="table-container" id="regularTasksContainer">
                        <div class="loading"><div class="spinner"></div></div>
                    </div>
                </div>
            </div>

            <!-- FUNCTIONS -->
            <div id="functionsTab" class="tab-content">
                <div class="controls">
                    <button class="btn btn-success" onclick="openFunctionModal()" data-i18n="addFunction">+ Функція</button>
                </div>
                <div id="functionsContainer" class="cards-grid">
                    <div class="loading"><div class="spinner"></div></div>
                </div>
            </div>

            <!-- USERS -->
            <div id="usersTab" class="tab-content">
                <div class="controls">
                    <button class="btn btn-success" onclick="openInviteModal()" id="inviteBtn"><i data-lucide="user-plus" class="icon"></i> <span data-i18n="invite">Запросити</span></button>
                </div>
                <div id="usersContainer" class="cards-grid">
                    <div class="loading"><div class="spinner"></div></div>
                </div>
            </div>

            <!-- ANALYTICS -->
            <div id="analyticsTab" class="tab-content">
                <div class="controls" style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:1rem;">
                    <h2 style="font-size:1.2rem;margin:0;" data-i18n="analytics"><i data-lucide="trending-up" class="icon"></i> Аналітика</h2>
                    <button class="btn" onclick="openDemoDataModal()" id="demoDataBtnDesktop" style="display:none;">
                        <i data-lucide="database" class="icon"></i> Демо-дані
                    </button>
                </div>
                <div style="background:white;border-radius:12px;padding:1.5rem;box-shadow:var(--shadow);margin-top:1rem;">
                    <div class="analytics-grid">
                        <div class="analytics-card">
                            <h3 data-i18n="totalTasks">Всього завдань</h3>
                            <div class="analytics-number" id="analyticsTotalTasks">0</div>
                        </div>
                        <div class="analytics-card">
                            <h3 data-i18n="completedTasks">Виконано</h3>
                            <div class="analytics-number green" id="analyticsCompletedTasks">0</div>
                        </div>
                        <div class="analytics-card">
                            <h3 data-i18n="completionRate">Виконання %</h3>
                            <div class="analytics-number blue" id="analyticsCompletionRate">0%</div>
                        </div>
                        <div class="analytics-card">
                            <h3 data-i18n="avgTime">Сер. час</h3>
                            <div class="analytics-number orange" id="analyticsAvgTime">-</div>
                        </div>
                    </div>
                    <div id="analyticsContent" style="margin-top:1.5rem;"></div>
                </div>
            </div>

            <!-- ADMIN (only for superadmin) -->
            <div id="adminTab" class="tab-content">
                <div class="controls" style="background:linear-gradient(135deg,#fee2e2,#fecaca);">
                    <h2 style="font-size:1.1rem;color:#dc2626;"><i data-lucide="shield" class="icon"></i> <span data-i18n="adminPanel">Адмін-панель TALKO</span></h2>
                </div>
                <div style="background:white;border-radius:12px;padding:1rem;box-shadow:var(--shadow);margin-bottom:1rem;">
                    <h3 style="margin-bottom:1rem;"><i data-lucide="plus" class="icon"></i> <span data-i18n="createCompany">Створити нову компанію</span></h3>
                    <form id="adminCreateForm" onsubmit="adminCreateCompany(event)">
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label" data-i18n="ownerEmail">Email власника *</label>
                                <input type="email" id="adminOwnerEmail" class="form-input" placeholder="client@email.com" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label" data-i18n="passwordLabel">Пароль *</label>
                                <input type="text" id="adminOwnerPassword" class="form-input" placeholder="мін. 6 символів" required minlength="6">
                            </div>
                            <div class="form-group">
                                <label class="form-label" data-i18n="ownerName">Ім'я власника *</label>
                                <input type="text" id="adminOwnerName" class="form-input" placeholder="Іван Петренко" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label" data-i18n="companyName">Назва компанії *</label>
                                <input type="text" id="adminCompanyName" class="form-input" placeholder="ТОВ Компанія" required>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-success" style="margin-top:1rem;" id="adminCreateBtn"><i data-lucide="rocket" class="icon"></i> <span data-i18n="createCompanyBtn">Створити компанію та Owner</span></button>
                    </form>
                </div>
                
                <!-- Інструкції для адміна -->
                <div style="display:grid;gap:1rem;grid-template-columns:repeat(auto-fit, minmax(300px, 1fr));">
                    
                    <!-- Інструкція: Додавання Owner -->
                    <div style="background:white;border-radius:12px;padding:1.25rem;box-shadow:var(--shadow);border-left:4px solid #3b82f6;">
                        <h4 style="display:flex;align-items:center;gap:0.5rem;margin-bottom:1rem;color:#3b82f6;">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                            1. Додавання Owner (Власника)
                        </h4>
                        <ol style="margin:0;padding-left:1.25rem;color:#4b5563;font-size:0.9rem;line-height:1.7;">
                            <li>Заповни форму вище і натисни <b>"Створити компанію та Owner"</b></li>
                            <li>Система автоматично створить:
                                <ul style="margin:0.3rem 0;padding-left:1rem;">
                                    <li>Компанію в Firebase</li>
                                    <li>Користувача з роллю Owner</li>
                                    <li>Акаунт в Firebase Auth</li>
                                </ul>
                            </li>
                            <li>Надішли клієнту:
                                <ul style="margin:0.3rem 0;padding-left:1rem;">
                                    <li>Посилання: <code style="background:#f3f4f6;padding:0.15rem 0.4rem;border-radius:4px;font-size:0.85rem;">taskmanagerai-vert.vercel.app</code></li>
                                    <li>Email та пароль</li>
                                </ul>
                            </li>
                        </ol>
                    </div>
                    
                    <!-- Інструкція: Додавання співробітників -->
                    <div style="background:white;border-radius:12px;padding:1.25rem;box-shadow:var(--shadow);border-left:4px solid #10b981;">
                        <h4 style="display:flex;align-items:center;gap:0.5rem;margin-bottom:1rem;color:#10b981;">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="19" x2="19" y1="8" y2="14"/><line x1="22" x2="16" y1="11" y2="11"/></svg>
                            2. Додавання співробітників
                        </h4>
                        <ol style="margin:0;padding-left:1.25rem;color:#4b5563;font-size:0.9rem;line-height:1.7;">
                            <li><b>Owner сам додає</b> співробітників через вкладку "Співробітники"</li>
                            <li>Owner натискає <b>"+ Додати співробітника"</b></li>
                            <li>Вводить email і створює запрошення</li>
                            <li>Система генерує посилання для реєстрації</li>
                            <li>Співробітник переходить по посиланню і створює пароль</li>
                        </ol>
                        <div style="margin-top:0.75rem;padding:0.75rem;background:#f0fdf4;border-radius:8px;font-size:0.85rem;color:#166534;">
                            <b>Важливо:</b> Адмін не додає співробітників напряму — це робить Owner компанії
                        </div>
                    </div>
                    
                    <!-- Інструкція: Google Calendar -->
                    <div style="background:white;border-radius:12px;padding:1.25rem;box-shadow:var(--shadow);border-left:4px solid #f59e0b;">
                        <h4 style="display:flex;align-items:center;gap:0.5rem;margin-bottom:1rem;color:#f59e0b;">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></svg>
                            3. Інтеграція Google Calendar
                        </h4>
                        <div style="color:#4b5563;font-size:0.9rem;line-height:1.7;">
                            <p style="margin:0 0 0.75rem;"><b>Поточний режим:</b> Testing (до 100 користувачів)</p>
                            <p style="margin:0 0 0.5rem;"><b>Щоб клієнт міг підключити календар:</b></p>
                            <ol style="margin:0;padding-left:1.25rem;">
                                <li>Відкрий <a href="https://console.cloud.google.com/apis/credentials/consent?project=stats-tracker-ai" target="_blank" style="color:#f59e0b;">Google Cloud Console → Audience</a></li>
                                <li>Натисни <b>"+ Add users"</b></li>
                                <li>Введи email клієнта (той самий що в TALKO)</li>
                                <li>Натисни <b>"Save"</b></li>
                            </ol>
                            <div style="margin-top:0.75rem;padding:0.75rem;background:#fefce8;border-radius:8px;font-size:0.85rem;color:#854d0e;">
                                <b>Ліміт:</b> 100 Test Users. Після цього потрібна верифікація Google (1-4 тижні)
                            </div>
                        </div>
                    </div>
                    
                </div>
            </div>
        </div>
    </div>

    <!-- MODALS -->
    <div id="taskModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><span class="close" onclick="closeModal('taskModal')">&times;</span><h2 id="taskModalTitle" data-i18n="newTask">Нове завдання</h2></div>
            <div class="modal-body">
                <form id="taskForm" onsubmit="saveTask(event)">
                    <div class="form-grid">
                        <div class="form-group full-width"><label class="form-label" data-i18n="title">Назва *</label><input type="text" id="taskTitle" class="form-input" required></div>
                        <div class="form-group"><label class="form-label" data-i18n="function">Функція</label><select id="taskFunction" class="form-select"><option value="" data-i18n="noFunction">Без функції</option></select></div>
                        <div class="form-group"><label class="form-label" data-i18n="assignee">Виконавець *</label><select id="taskAssignee" class="form-select" required><option value="" data-i18n="select">Оберіть</option></select></div>
                        <div class="form-group"><label class="form-label" data-i18n="deadlineDate">Дедлайн (дата) *</label><input type="date" id="taskDeadlineDate" class="form-input" required></div>
                        <div class="form-group"><label class="form-label" data-i18n="deadlineTime">Дедлайн (час) *</label><input type="time" id="taskDeadlineTime" class="form-input" required></div>
                        <div class="form-group"><label class="form-label" data-i18n="estimatedTime">Орієнтовний час</label><select id="taskEstimatedTime" class="form-select"><option value="" data-i18n="notSpecified">Не вказано</option><option value="15">15 хв</option><option value="30">30 хв</option><option value="45">45 хв</option><option value="60">1 год</option><option value="90">1.5 год</option><option value="120">2 год</option><option value="180">3 год</option><option value="240">4 год</option><option value="480">8 год</option></select></div>
                        <div class="form-group"><label class="form-label" data-i18n="priority">Пріоритет</label><select id="taskPriority" class="form-select"><option value="low" data-i18n="priorityLow">Низький</option><option value="medium" selected data-i18n="priorityMedium">Середній</option><option value="high" data-i18n="priorityHigh">Високий</option></select></div>
                        <div class="form-group"><label class="form-label" data-i18n="status">Статус</label><select id="taskStatus" class="form-select"><option value="new" data-i18n="statusNew">Нове</option><option value="progress" data-i18n="statusProgress">В роботі</option><option value="review" data-i18n="statusReview">Перевірка</option><option value="done" data-i18n="statusDone">Готово</option></select></div>
                        <div class="form-group full-width"><label class="form-label" data-i18n="expectedResult">Очікуваний результат</label><textarea id="taskExpectedResult" class="form-textarea" placeholder="Що конкретно має бути зроблено?"></textarea></div>
                        <div class="form-group full-width"><label class="form-label" data-i18n="reportFormat">Формат звіту</label><input type="text" id="taskReportFormat" class="form-input" placeholder="Скрін / Посилання / Фото / Документ"></div>
                        <div class="form-group full-width"><label class="form-label" data-i18n="description">Опис</label><textarea id="taskDescription" class="form-textarea"></textarea></div>
                    </div>
                    <div class="form-actions"><button type="button" class="btn" onclick="closeModal('taskModal')" data-i18n="cancel">Скасувати</button><button type="submit" class="btn btn-success" data-i18n="save">Зберегти</button></div>
                </form>
                
                <!-- COMMENTS SECTION -->
                <div id="taskCommentsSection" class="comments-section hidden">
                    <div class="comments-header">
                        <i data-lucide="message-circle" class="icon"></i>
                        <span data-i18n="comments">Коментарі</span>
                        <span id="commentCount" class="comment-count">0</span>
                    </div>
                    <div id="commentsList" class="comments-list">
                        <div class="comments-empty">
                            <div class="comments-empty-icon">💬</div>
                            <span data-i18n="noComments">Ще немає коментарів</span>
                        </div>
                    </div>
                    <div class="comment-input-wrapper">
                        <textarea id="commentInput" class="comment-input" placeholder="Написати коментар..." rows="1" onkeydown="handleCommentKeydown(event)"></textarea>
                        <button type="button" class="comment-send-btn" onclick="sendComment()" id="sendCommentBtn">
                            <i data-lucide="send" class="icon"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="functionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><span class="close" onclick="closeModal('functionModal')">&times;</span><h2 id="functionModalTitle" data-i18n="newFunction">Нова функція</h2></div>
            <div class="modal-body">
                <form id="functionForm" onsubmit="saveFunction(event)">
                    <div class="form-grid">
                        <div class="form-group"><label class="form-label" data-i18n="title">Назва *</label><input type="text" id="functionName" class="form-input" required></div>
                        <div class="form-group"><label class="form-label"><i data-lucide="crown" class="icon icon-sm"></i> <span data-i18n="head">Головний *</span></label><select id="functionHead" class="form-select" required><option value="" data-i18n="select">Оберіть</option></select></div>
                        <div class="form-group full-width"><label class="form-label" data-i18n="description">Опис</label><textarea id="functionDescription" class="form-textarea"></textarea></div>
                        <div class="form-group full-width"><label class="form-label"><i data-lucide="users" class="icon icon-sm"></i> <span data-i18n="members">Учасники</span></label><div id="functionAssignees" style="display:flex;flex-wrap:wrap;gap:0.4rem;margin-top:0.4rem;"></div></div>
                    </div>
                    <div class="form-actions"><button type="button" class="btn" onclick="closeModal('functionModal')" data-i18n="cancel">Скасувати</button><button type="submit" class="btn btn-success" data-i18n="save">Зберегти</button></div>
                </form>
            </div>
        </div>
    </div>

    <div id="regularTaskModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><span class="close" onclick="closeModal('regularTaskModal')">&times;</span><h2 data-i18n="regularTask">Регулярне завдання</h2></div>
            <div class="modal-body">
                <form id="regularTaskForm" onsubmit="saveRegularTask(event)">
                    <div class="form-grid">
                        <div class="form-group full-width"><label class="form-label" data-i18n="title">Назва *</label><input type="text" id="regularTaskTitle" class="form-input" required></div>
                        <div class="form-group"><label class="form-label" data-i18n="function">Функція *</label><select id="regularTaskFunction" class="form-select" required><option value="" data-i18n="select">Оберіть</option></select></div>
                        <div class="form-group"><label class="form-label" data-i18n="periodicity">Періодичність *</label><select id="regularTaskPeriod" class="form-select" onchange="updatePeriodOptions()"><option value="weekly" data-i18n="weekly">Щотижня</option><option value="monthly" data-i18n="monthly">Щомісяця</option><option value="quarterly" data-i18n="quarterly">Щокварталу</option></select></div>
                        <div class="form-group" id="dayOfWeekGroup"><label class="form-label" data-i18n="dayOfWeek">День тижня *</label><select id="regularTaskDayOfWeek" class="form-select"><option value="1" data-i18n="monday">Понеділок</option><option value="2" data-i18n="tuesday">Вівторок</option><option value="3" data-i18n="wednesday">Середа</option><option value="4" data-i18n="thursday">Четвер</option><option value="5" data-i18n="friday">П'ятниця</option><option value="6" data-i18n="saturday">Субота</option><option value="0" data-i18n="sunday">Неділя</option></select></div>
                        <div class="form-group" id="dayOfMonthGroup" style="display:none;"><label class="form-label" data-i18n="dayOfMonth">День місяця *</label><select id="regularTaskDayOfMonth" class="form-select"><option value="1">1</option><option value="5">5</option><option value="10">10</option><option value="15">15</option><option value="20">20</option><option value="25">25</option><option value="last" data-i18n="lastDay">Останній день</option></select></div>
                        <div class="form-group"><label class="form-label" data-i18n="timeOfDay">Час виконання *</label><input type="time" id="regularTaskTime" class="form-input" value="10:00" required></div>
                        <div class="form-group full-width"><label class="form-label" data-i18n="expectedResult">Очікуваний результат</label><textarea id="regularTaskExpectedResult" class="form-textarea" placeholder="Що конкретно має бути зроблено?"></textarea></div>
                        <div class="form-group full-width"><label class="form-label" data-i18n="reportFormat">Формат звіту</label><input type="text" id="regularTaskReportFormat" class="form-input" placeholder="Скрін / Посилання / Фото / Документ"></div>
                        <div class="form-group full-width"><label class="form-label"><i data-lucide="file-text" class="icon icon-sm"></i> <span data-i18n="instruction">Інструкція (необов'язково)</span></label><textarea id="regularTaskInstruction" class="form-textarea" style="min-height:100px;" placeholder="Детальна інструкція як виконувати це завдання..."></textarea></div>
                        <div class="form-group full-width">
                            <div class="info-box" style="background:#e8f5e9;padding:0.75rem;border-radius:8px;font-size:0.85rem;">
                                <i data-lucide="lightbulb" class="icon icon-sm" style="color:#f59e0b;"></i> <span data-i18n="functionAssigneeHint">Виконавці беруться автоматично з обраної функції. Хто в функції — той і виконує.</span>
                            </div>
                        </div>
                    </div>
                    <div class="form-actions"><button type="button" class="btn" onclick="closeModal('regularTaskModal')" data-i18n="cancel">Скасувати</button><button type="submit" class="btn btn-success" data-i18n="save">Зберегти</button></div>
                </form>
            </div>
        </div>
    </div>

    <div id="inviteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><span class="close" onclick="closeModal('inviteModal')">&times;</span><h2 data-i18n="inviteTitle">Запрошення</h2></div>
            <div class="modal-body">
                <form id="inviteForm" onsubmit="sendInvite(event)">
                    <div class="form-group">
                        <label class="form-label" data-i18n="employeeEmail">Email співробітника *</label>
                        <input type="email" id="inviteEmail" class="form-input" required>
                    </div>
                    <div class="form-group" style="margin-top:0.75rem;">
                        <label class="form-label" data-i18n="role">Роль</label>
                        <select id="inviteRole" class="form-select"><option value="employee" data-i18n="roleEmployee">Співробітник</option><option value="manager" data-i18n="roleManager">Менеджер</option></select>
                    </div>
                    <div id="inviteLink" style="margin-top:1rem;padding:1rem;background:#e3f2fd;border-radius:8px;display:none;">
                        <p style="font-size:0.85rem;margin-bottom:0.5rem;"><strong data-i18n="inviteLinkLabel">Посилання для входу:</strong></p>
                        <input type="text" id="inviteLinkText" class="form-input" readonly style="font-size:0.8rem;">
                        <button type="button" onclick="copyInviteLink()" class="btn btn-small" style="margin-top:0.5rem;"><i data-lucide="copy" class="icon icon-sm"></i> <span data-i18n="copy">Копіювати</span></button>
                    </div>
                    <div class="form-actions"><button type="button" class="btn" onclick="closeModal('inviteModal')" data-i18n="close">Закрити</button><button type="submit" class="btn btn-success"><i data-lucide="send" class="icon"></i> <span data-i18n="createInvite">Створити запрошення</span></button></div>
                </form>
            </div>
        </div>
    </div>

    <div id="userModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><span class="close" onclick="closeModal('userModal')">&times;</span><h2 id="userModalTitle" data-i18n="editEmployee">Редагувати співробітника</h2></div>
            <div class="modal-body">
                <form id="userForm" onsubmit="saveUser(event)">
                    <div class="form-grid">
                        <div class="form-group full-width">
                            <label class="form-label" data-i18n="name">Ім'я *</label>
                            <input type="text" id="userName" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Email</label>
                            <input type="email" id="userEmail" class="form-input" readonly style="background:#f0f0f0;">
                        </div>
                        <div class="form-group">
                            <label class="form-label" data-i18n="role">Роль</label>
                            <select id="userRole" class="form-select">
                                <option value="employee" data-i18n="roleEmployee">Співробітник</option>
                                <option value="manager" data-i18n="roleManager">Менеджер</option>
                            </select>
                        </div>
                        <div class="form-group full-width">
                            <label class="form-label" data-i18n="position">Посада</label>
                            <input type="text" id="userPosition" class="form-input" placeholder="Менеджер з продажу">
                        </div>
                        <div class="form-group full-width">
                            <label class="form-label" data-i18n="userFunctions">Функції співробітника</label>
                            <div id="userFunctions" style="display:flex;flex-wrap:wrap;gap:0.4rem;margin-top:0.4rem;padding:0.8rem;background:#f8f9fa;border-radius:8px;"></div>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn" onclick="closeModal('userModal')" data-i18n="cancel">Скасувати</button>
                        <button type="submit" class="btn btn-success" data-i18n="save">Зберегти</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Profile Modal -->
    <div id="profileModal" class="modal">
        <div class="modal-content" style="max-width:500px;">
            <div class="modal-header">
                <h3><i data-lucide="user" class="icon"></i> Мій профіль</h3>
                <button class="close-btn" onclick="closeModal('profileModal')">&times;</button>
            </div>
            <div style="padding:1.5rem;">
                <!-- User Info -->
                <div style="display:flex;align-items:center;gap:1rem;margin-bottom:1.5rem;padding-bottom:1.5rem;border-bottom:1px solid #e5e7eb;">
                    <div style="width:60px;height:60px;background:linear-gradient(135deg, var(--primary), var(--primary-dark));border-radius:50%;display:flex;align-items:center;justify-content:center;color:white;font-size:1.5rem;font-weight:600;" id="profileAvatar">U</div>
                    <div>
                        <div style="font-weight:600;font-size:1.1rem;" id="profileName">Користувач</div>
                        <div style="color:var(--gray);font-size:0.9rem;" id="profileEmail"><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="92f7fff3fbfed2f7eaf3ffe2fef7bcf1fdff">[email&#160;protected]</a></div>
                        <div style="margin-top:0.25rem;"><span class="status-badge" style="background:#e0e7ff;color:#4338ca;" id="profileRole">Роль</span></div>
                    </div>
                </div>
                
                <!-- Google Calendar Integration -->
                <div style="background:#f9fafb;border-radius:12px;padding:1rem;margin-bottom:1rem;">
                    <div style="display:flex;align-items:center;gap:0.75rem;margin-bottom:0.75rem;">
                        <div style="width:40px;height:40px;background:white;border-radius:8px;display:flex;align-items:center;justify-content:center;box-shadow:0 1px 3px rgba(0,0,0,0.1);">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                                <path d="M18 4H6C4.9 4 4 4.9 4 6v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2z" fill="#4285F4"/>
                                <path d="M18 4H6C4.9 4 4 4.9 4 6v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2z" fill="none" stroke="#4285F4" stroke-width="0"/>
                                <rect x="6" y="8" width="12" height="2" fill="white"/>
                                <rect x="6" y="12" width="5" height="2" fill="#EA4335"/>
                                <rect x="13" y="12" width="5" height="2" fill="#FBBC04"/>
                                <rect x="6" y="16" width="5" height="2" fill="#34A853"/>
                                <rect x="13" y="16" width="5" height="2" fill="#4285F4"/>
                            </svg>
                        </div>
                        <div>
                            <div style="font-weight:600;">Google Calendar</div>
                            <div style="font-size:0.8rem;color:var(--gray);">Синхронізація завдань з календарем</div>
                        </div>
                    </div>
                    
                    <div id="gcalStatus">
                        <div id="gcalNotConnected">
                            <p style="font-size:0.85rem;color:#666;margin-bottom:0.75rem;">
                                Підключіть Google Calendar щоб бачити завдання у своєму календарі
                            </p>
                            <button class="btn btn-success" onclick="connectGoogleCalendar()" style="width:100%;">
                                <i data-lucide="link" class="icon"></i> Підключити Google Calendar
                            </button>
                        </div>
                        <div id="gcalConnected" style="display:none;">
                            <div style="display:flex;align-items:center;gap:0.5rem;padding:0.75rem;background:#ecfdf5;border-radius:8px;margin-bottom:0.75rem;">
                                <i data-lucide="check-circle" class="icon" style="color:#10b981;"></i>
                                <span style="color:#065f46;font-weight:500;">Календар підключено</span>
                            </div>
                            <p style="font-size:0.8rem;color:#666;margin-bottom:0.5rem;" id="gcalEmail"></p>
                            <button class="btn" onclick="disconnectGoogleCalendar()" style="width:100%;background:#fee2e2;color:#991b1b;">
                                <i data-lucide="unlink" class="icon"></i> Відключити
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Info -->
                <div style="font-size:0.8rem;color:#888;text-align:center;">
                    <i data-lucide="info" class="icon icon-sm"></i>
                    Нові завдання автоматично з'являться у вашому Google Calendar
                </div>
            </div>
        </div>
    </div>

    <a href="https://chatgpt.com/g/g-69382bfa841881918aff7b50aa25a4f9-talko-task-manager-support" target="_blank" class="support-btn">
        <i data-lucide="bot" class="icon"></i> <span data-i18n="aiSupport">AI Підтримка</span>
    </a>

    <footer class="footer">
        <p>Powered by <strong style="color:#3498db;">TALKO System</strong></p>
    </footer>

    <script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>
        // =====================
        // TRANSLATIONS
        // =====================
        const translations = {
            ua: {
                // Auth
                authSubtitle: 'Управління завданнями для бізнесу',
                signInGoogle: 'Увійти через Google',
                or: 'або',
                password: 'Пароль:',
                signIn: '🔐 Увійти',
                forgotPassword: 'Забули пароль?',
                noAccess: 'Немає доступу?',
                contactUs: "Зв'яжіться з нами",
                noAccessTitle: '🚫 Доступ відсутній',
                noAccessText: "Ваш email не зареєстровано в системі.<br>Зверніться до адміністратора для отримання доступу.",
                contactSupport: "📞 Зв'язатися з підтримкою",
                tryAnotherEmail: 'Спробувати інший email',
                haveInvite: 'Є запрошення?',
                registerBtn: 'Зареєструватися',
                registerTitle: 'Реєстрація за запрошенням',
                createPassword: 'Придумайте пароль:',
                confirmPassword: 'Підтвердіть пароль:',
                registerSubmit: 'Зареєструватися',
                backToLogin: '← Повернутися до входу',
                logout: 'Вийти',
                
                // Tabs
                tabTasks: 'Завдання',
                tabControl: 'Контроль',
                tabRegular: 'Регулярні',
                tabFunctions: 'Функції',
                tabTeam: 'Команда',
                tabAdmin: 'Адмін',
                
                // Tasks
                addTask: '+ Завдання',
                allStatuses: 'Всі статуси',
                allFunctions: 'Всі функції',
                allDates: 'Всі дати',
                today: 'Сьогодні',
                thisWeek: 'Цей тиждень',
                thisMonth: 'Цей місяць',
                customPeriod: 'Обрати період',
                overdue: 'Прострочені',
                all: 'Всі',
                newTask: 'Нове завдання',
                editTask: 'Редагувати',
                title: 'Назва *',
                function: 'Функція',
                noFunction: 'Без функції',
                assignee: 'Виконавець *',
                select: 'Оберіть',
                deadlineDate: 'Дедлайн (дата) *',
                deadlineTime: 'Дедлайн (час) *',
                estimatedTime: 'Орієнтовний час',
                notSpecified: 'Не вказано',
                expectedResult: 'Очікуваний результат',
                reportFormat: 'Формат звіту',
                priority: 'Пріоритет',
                status: 'Статус',
                description: 'Опис',
                cancel: 'Скасувати',
                save: 'Зберегти',
                close: 'Закрити',
                
                // Comments
                comments: 'Коментарі',
                noComments: 'Ще немає коментарів',
                writeComment: 'Написати коментар...',
                
                // Statuses
                statusNew: 'Нове',
                statusProgress: 'В роботі',
                statusReview: 'Перевірка',
                statusDone: 'Готово',
                
                // Priorities
                priorityLow: 'Низький',
                priorityMedium: 'Середній',
                priorityHigh: 'Високий',
                
                // Control
                controlPanel: 'Панель контролю',
                critical: 'Критичні',
                attention: 'Увага',
                active: 'Активні',
                completed: 'Готово',
                workload: 'Навантаження',
                noActiveTasks: 'Немає активних завдань',
                
                // Regular
                addRegular: '+ Регулярне',
                regularTask: 'Регулярне завдання',
                periodicity: 'Періодичність *',
                weekly: 'Щотижня',
                monthly: 'Щомісяця',
                quarterly: 'Щокварталу',
                dayOfWeek: 'День тижня *',
                dayOfMonth: 'День місяця *',
                timeOfDay: 'Час виконання *',
                lastDay: 'Останній день',
                monday: 'Понеділок',
                tuesday: 'Вівторок',
                wednesday: 'Середа',
                thursday: 'Четвер',
                friday: "П'ятниця",
                saturday: 'Субота',
                sunday: 'Неділя',
                instruction: 'Інструкція (необов\'язково)',
                allPeriods: 'Всі періоди',
                assignees: 'Виконавці',
                selectFunctionFirst: 'Спочатку оберіть функцію',
                noMembers: 'Немає учасників',
                create: 'Створити',
                radarAI: 'Керівник',
                techAI: 'Помічник',
                
                // Functions
                addFunction: '+ Функція',
                newFunction: 'Нова функція',
                head: 'Головний *',
                members: 'Учасники',
                tasks: 'завдань',
                
                // Team
                invite: 'Запросити',
                inviteTitle: 'Запрошення',
                employeeEmail: 'Email співробітника *',
                role: 'Роль',
                roleOwner: 'Власник',
                roleManager: 'Менеджер',
                roleEmployee: 'Співробітник',
                inviteLinkLabel: 'Посилання для входу:',
                copy: 'Копіювати',
                createInvite: 'Створити запрошення',
                
                // Admin
                adminPanel: 'Адмін-панель TALKO',
                createCompany: 'Створити нову компанію',
                ownerEmail: 'Email власника *',
                passwordLabel: 'Пароль *',
                ownerName: "Ім'я власника *",
                companyName: 'Назва компанії *',
                createCompanyBtn: 'Створити компанію та Owner',
                allCompanies: 'Всі компанії',
                users: 'користувачів',
                
                // Empty states
                noTasks: 'Завдань немає',
                createFirstTask: 'Створіть перше завдання',
                noFunctions: 'Функцій немає',
                functionAssigneeHint: 'Виконавці беруться автоматично з обраної функції. Хто в функції — той і виконує.',
                people: 'осіб',
                createFirstFunction: 'Створіть першу функцію',
                noRegular: 'Регулярних завдань немає',
                noRegularForDay: 'На цей день регулярних завдань немає',
                todaysTasks: 'Мої на сьогодні',
                allDays: 'Всі дні',
                createRegular: 'Створіть регулярне завдання',
                noUsers: 'Немає користувачів',
                noCompanies: 'Немає компаній',
                
                // Other
                support: 'Підтримка',
                aiSupport: 'AI Підтримка',
                footerSupport: '🛟 Підтримка',
                notAssigned: 'Не призначено',
                deleteConfirm: 'Видалити?',
                error: 'Помилка',
                created: 'створено',
                copied: 'Посилання скопійовано!',
                
                // New filters & analytics
                clear: 'Очистити',
                allTasks: 'Всі завдання',
                myTasks: 'Мої завдання',
                createdByMe: 'Створені мною',
                statuses: 'Статуси',
                functions: 'Функції',
                task: 'Завдання',
                createdBy: 'Створив',
                deadline: 'Дедлайн',
                type: 'Тип',
                actions: 'Дії',
                schedule: 'Розклад',
                statusPeriod: 'Статус',
                createAgain: 'Створити ще раз',
                markDone: 'Позначити виконаним',
                noTasksFound: 'Завдань не знайдено',
                changeFilters: 'Змініть фільтри або додайте нове завдання',
                edit: 'Редагувати',
                delete: 'Видалити',
                
                // Control panel
                controlPanelTitle: 'Панель контролю завдань',
                assigneeLabel: 'Виконавець:',
                functionLabel: 'Функція:',
                periodLabel: 'Період:',
                allAssignees: 'Всі виконавці',
                allTime: 'Весь час',
                thisMonth: 'Цей місяць',
                overdueLabel: 'Прострочені',
                todayTomorrow: 'Сьогодні-завтра',
                inWork: 'В роботі',
                completedLabel: 'Завершені',
                viewLabel: 'Перегляд:',
                employeeWorkload: 'Навантаження співробітників',
                byFunctions: 'По функціях',
                
                // Analytics
                tabAnalytics: 'Аналітика',
                analytics: 'Аналітика',
                totalTasks: 'Всього завдань',
                completedTasks: 'Виконано',
                completionRate: 'Виконання %',
                avgTime: 'Сер. час',
                byStatus: 'По статусах',
                topPerformers: 'Топ виконавців',
                noCompletedTasks: 'Немає виконаних завдань',
                
                // Users
                tabUsers: 'Співробітники',
                addEmployee: '+ Додати співробітника',
                editEmployee: 'Редагувати співробітника',
                name: "Ім'я *",
                position: 'Посада',
                userFunctions: 'Функції співробітника',
                inviteFirst: 'Запросіть першого співробітника',
                noEmployees: 'Немає співробітників',
                
                // Regular
                addRegularTask: '+ Регулярне завдання',
                
                // Mobile menu
                menu: 'Меню',
                aiAssistants: 'AI Асистенти',
                aiManager: 'Керівник',
                aiTechnical: 'Технічний',
                aiSupport: 'AI Помічник (Підтримка)',
                profile: 'Профіль',
                enableNotifications: 'Увімкнути сповіщення',
                disableNotifications: 'Вимкнути сповіщення',
                loadDemoData: 'Завантажити демо-дані',
            },
            ru: {
                // Auth
                authSubtitle: 'Управление задачами для бизнеса',
                signInGoogle: 'Войти через Google',
                or: 'или',
                password: 'Пароль:',
                signIn: '🔐 Войти',
                forgotPassword: 'Забыли пароль?',
                noAccess: 'Нет доступа?',
                contactUs: 'Свяжитесь с нами',
                noAccessTitle: '🚫 Доступ отсутствует',
                noAccessText: 'Ваш email не зарегистрирован в системе.<br>Обратитесь к администратору для получения доступа.',
                contactSupport: '📞 Связаться с поддержкой',
                tryAnotherEmail: 'Попробовать другой email',
                haveInvite: 'Есть приглашение?',
                registerBtn: 'Зарегистрироваться',
                registerTitle: 'Регистрация по приглашению',
                createPassword: 'Придумайте пароль:',
                confirmPassword: 'Подтвердите пароль:',
                registerSubmit: 'Зарегистрироваться',
                backToLogin: '← Вернуться ко входу',
                logout: 'Выйти',
                
                // Tabs
                tabTasks: 'Задачи',
                tabControl: 'Контроль',
                tabRegular: 'Регулярные',
                tabFunctions: 'Функции',
                tabTeam: 'Команда',
                tabAdmin: 'Админ',
                
                // Tasks
                addTask: '+ Задача',
                allStatuses: 'Все статусы',
                allFunctions: 'Все функции',
                allDates: 'Все даты',
                today: 'Сегодня',
                thisWeek: 'Эта неделя',
                thisMonth: 'Этот месяц',
                customPeriod: 'Выбрать период',
                overdue: 'Просроченные',
                all: 'Все',
                newTask: 'Новая задача',
                editTask: 'Редактировать',
                title: 'Название *',
                function: 'Функция',
                noFunction: 'Без функции',
                assignee: 'Исполнитель *',
                select: 'Выберите',
                deadlineDate: 'Дедлайн (дата) *',
                deadlineTime: 'Дедлайн (время) *',
                estimatedTime: 'Ориентировочное время',
                notSpecified: 'Не указано',
                expectedResult: 'Ожидаемый результат',
                reportFormat: 'Формат отчета',
                priority: 'Приоритет',
                status: 'Статус',
                description: 'Описание',
                cancel: 'Отмена',
                save: 'Сохранить',
                close: 'Закрыть',
                
                // Comments
                comments: 'Комментарии',
                noComments: 'Пока нет комментариев',
                writeComment: 'Написать комментарий...',
                
                // Statuses
                statusNew: 'Новое',
                statusProgress: 'В работе',
                statusReview: 'Проверка',
                statusDone: 'Готово',
                
                // Priorities
                priorityLow: 'Низкий',
                priorityMedium: 'Средний',
                priorityHigh: 'Высокий',
                
                // Control
                controlPanel: 'Панель контроля',
                critical: 'Критические',
                attention: 'Внимание',
                active: 'Активные',
                completed: 'Готово',
                workload: 'Нагрузка',
                noActiveTasks: 'Нет активных задач',
                
                // Regular
                addRegular: '+ Регулярное',
                regularTask: 'Регулярная задача',
                periodicity: 'Периодичность *',
                weekly: 'Еженедельно',
                monthly: 'Ежемесячно',
                quarterly: 'Ежеквартально',
                dayOfWeek: 'День недели *',
                dayOfMonth: 'День месяца *',
                timeOfDay: 'Время выполнения *',
                lastDay: 'Последний день',
                monday: 'Понедельник',
                tuesday: 'Вторник',
                wednesday: 'Среда',
                thursday: 'Четверг',
                friday: 'Пятница',
                saturday: 'Суббота',
                sunday: 'Воскресенье',
                instruction: 'Инструкция (необязательно)',
                allPeriods: 'Все периоды',
                assignees: 'Исполнители',
                selectFunctionFirst: 'Сначала выберите функцию',
                noMembers: 'Нет участников',
                create: 'Создать',
                radarAI: 'Руководитель',
                techAI: 'Помощник',
                
                // Functions
                addFunction: '+ Функция',
                newFunction: 'Новая функция',
                head: 'Главный *',
                members: 'Участники',
                tasks: 'задач',
                
                // Team
                invite: 'Пригласить',
                inviteTitle: 'Приглашение',
                employeeEmail: 'Email сотрудника *',
                role: 'Роль',
                roleOwner: 'Владелец',
                roleManager: 'Менеджер',
                roleEmployee: 'Сотрудник',
                inviteLinkLabel: 'Ссылка для входа:',
                copy: 'Копировать',
                createInvite: 'Создать приглашение',
                
                // Admin
                adminPanel: 'Админ-панель TALKO',
                createCompany: 'Создать новую компанию',
                ownerEmail: 'Email владельца *',
                passwordLabel: 'Пароль *',
                ownerName: 'Имя владельца *',
                companyName: 'Название компании *',
                createCompanyBtn: 'Создать компанию и Owner',
                allCompanies: 'Все компании',
                users: 'пользователей',
                
                // Empty states
                noTasks: 'Задач нет',
                createFirstTask: 'Создайте первую задачу',
                noFunctions: 'Функций нет',
                functionAssigneeHint: 'Исполнители берутся автоматически из выбранной функции. Кто в функции — тот и выполняет.',
                people: 'чел.',
                createFirstFunction: 'Создайте первую функцию',
                noRegular: 'Регулярных задач нет',
                noRegularForDay: 'На этот день регулярных задач нет',
                todaysTasks: 'Мои на сегодня',
                allDays: 'Все дни',
                createRegular: 'Создайте регулярную задачу',
                noUsers: 'Нет пользователей',
                noCompanies: 'Нет компаний',
                
                // Other
                support: 'Поддержка',
                aiSupport: 'AI Поддержка',
                footerSupport: '🛟 Поддержка',
                notAssigned: 'Не назначено',
                deleteConfirm: 'Удалить?',
                error: 'Ошибка',
                created: 'создано',
                copied: 'Ссылка скопирована!',
                
                // New filters & analytics
                clear: 'Очистить',
                allTasks: 'Все задачи',
                myTasks: 'Мои задачи',
                createdByMe: 'Созданные мной',
                statuses: 'Статусы',
                functions: 'Функции',
                task: 'Задача',
                createdBy: 'Создал',
                deadline: 'Дедлайн',
                type: 'Тип',
                actions: 'Действия',
                schedule: 'Расписание',
                statusPeriod: 'Статус',
                createAgain: 'Создать ещё раз',
                markDone: 'Отметить выполненным',
                noTasksFound: 'Задач не найдено',
                changeFilters: 'Измените фильтры или добавьте новую задачу',
                edit: 'Редактировать',
                delete: 'Удалить',
                
                // Control panel
                controlPanelTitle: 'Панель контроля задач',
                assigneeLabel: 'Исполнитель:',
                functionLabel: 'Функция:',
                periodLabel: 'Период:',
                allAssignees: 'Все исполнители',
                allTime: 'Все время',
                thisMonth: 'Этот месяц',
                overdueLabel: 'Просроченные',
                todayTomorrow: 'Сегодня-завтра',
                inWork: 'В работе',
                completedLabel: 'Завершенные',
                viewLabel: 'Просмотр:',
                employeeWorkload: 'Нагрузка сотрудников',
                byFunctions: 'По функциям',
                
                // Analytics
                tabAnalytics: 'Аналитика',
                analytics: 'Аналитика',
                totalTasks: 'Всего задач',
                completedTasks: 'Выполнено',
                completionRate: 'Выполнение %',
                avgTime: 'Сред. время',
                byStatus: 'По статусам',
                topPerformers: 'Топ исполнителей',
                noCompletedTasks: 'Нет выполненных задач',
                
                // Users
                tabUsers: 'Сотрудники',
                addEmployee: '+ Добавить сотрудника',
                editEmployee: 'Редактировать сотрудника',
                name: 'Имя *',
                position: 'Должность',
                userFunctions: 'Функции сотрудника',
                inviteFirst: 'Пригласите первого сотрудника',
                noEmployees: 'Нет сотрудников',
                
                // Regular
                addRegularTask: '+ Регулярная задача',
                
                // Mobile menu
                menu: 'Меню',
                aiAssistants: 'AI Ассистенты',
                aiManager: 'Руководитель',
                aiTechnical: 'Технический',
                aiSupport: 'AI Помощник (Поддержка)',
                profile: 'Профиль',
                enableNotifications: 'Включить уведомления',
                disableNotifications: 'Отключить уведомления',
                loadDemoData: 'Загрузить демо-данные',
            }
        };

        let currentLang = localStorage.getItem('talko_lang') || 'ua';

        function t(key) {
            return translations[currentLang][key] || translations['ua'][key] || key;
        }

        function setLanguage(lang) {
            currentLang = lang;
            localStorage.setItem('talko_lang', lang);
            
            // Update desktop buttons
            document.getElementById('langUA')?.classList.toggle('active', lang === 'ua');
            document.getElementById('langRU')?.classList.toggle('active', lang === 'ru');
            
            // Update mobile buttons
            document.getElementById('mLangUA')?.classList.toggle('active', lang === 'ua');
            document.getElementById('mLangRU')?.classList.toggle('active', lang === 'ru');
            
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (translations[lang] && translations[lang][key]) {
                    if (el.tagName === 'INPUT' && el.type !== 'text' && el.type !== 'email') {
                        el.value = translations[lang][key];
                    } else {
                        el.innerHTML = translations[lang][key];
                    }
                }
            });
            
            // Re-render dynamic content
            if (currentCompany || isSuperAdmin) {
                // Find active tab from either desktop tabs or bottom nav
                let tabName = 'tasks';
                const activeBottomBtn = document.querySelector('.bottom-nav-btn.active');
                const activeTabBtn = document.querySelector('.tab-btn.active');
                
                if (activeBottomBtn && activeBottomBtn.dataset.tab) {
                    tabName = activeBottomBtn.dataset.tab;
                } else if (activeTabBtn) {
                    const match = activeTabBtn.getAttribute('onclick')?.match(/switchTab\('(\w+)'\)/);
                    if (match) tabName = match[1];
                }
                
                switchTab(tabName);
            }
        }

        // =====================
        // FIREBASE CONFIG
        // =====================
        const firebaseConfig = {
            apiKey: "AIzaSyD1oBJuuFiVVo4HHjjeb81IhGEt1oz4Ydc",
            authDomain: "task-manager-44e84.firebaseapp.com",
            projectId: "task-manager-44e84",
            storageBucket: "task-manager-44e84.firebasestorage.app",
            messagingSenderId: "181519398491",
            appId: "1:181519398491:web:baa17a9a88f637ee94717e"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const googleProvider = new firebase.auth.GoogleAuthProvider();

        // =====================
        // APP STATE
        // =====================
        const SUPERADMIN_EMAIL = 'management.talco@gmail.com';
        let currentUser = null;
        let currentCompany = null;
        let currentUserData = null;
        let isSuperAdmin = false;
        let tasks = [];
        let users = [];
        let functions = [];
        let regularTasks = [];
        let editingId = null;
        
        // =====================
        // GOOGLE CALENDAR CONFIG
        // =====================
        const GOOGLE_CLIENT_ID = '373376418182-1bc6pfp3qo54n2rt8l0sqjtqaqj6ari3.apps.googleusercontent.com';
        const GOOGLE_SCOPES = 'https://www.googleapis.com/auth/calendar.events https://www.googleapis.com/auth/userinfo.email';
        let googleAccessToken = null;
        let tokenClient = null;

        // =====================
        // AUTH FUNCTIONS
        // =====================
        function showAuthMessage(msg, type = 'info') {
            const el = document.getElementById('authMessage');
            el.textContent = msg;
            el.className = 'auth-message ' + type;
            el.style.display = 'block';
        }

        function hideAuthMessage() {
            document.getElementById('authMessage').style.display = 'none';
        }

        function togglePassword(inputId, btn) {
            const input = document.getElementById(inputId);
            if (input.type === 'password') {
                input.type = 'text';
                btn.innerHTML = '<i data-lucide="eye-off" class="icon icon-sm"></i>';
            } else {
                input.type = 'password';
                btn.innerHTML = '<i data-lucide="eye" class="icon icon-sm"></i>';
            }
            refreshIcons();
        }

        function showNoAccess() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('registerForm').style.display = 'none';
            document.getElementById('noAccessCard').style.display = 'block';
        }

        let currentInviteData = null; // Дані поточного інвайту з URL
        
        // Перевірка інвайту в URL
        async function checkInviteUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            const inviteId = urlParams.get('invite');
            
            if (!inviteId) {
                currentInviteData = null;
                return false;
            }
            
            try {
                const inviteDoc = await db.collection('invites').doc(inviteId).get();
                
                if (!inviteDoc.exists) {
                    showAuthMessage(currentLang === 'ua' ? 'Запрошення не знайдено або застаріло' : 'Приглашение не найдено или устарело', 'error');
                    currentInviteData = null;
                    return false;
                }
                
                const invite = inviteDoc.data();
                
                if (invite.accepted) {
                    currentInviteData = null;
                    // Не показуємо помилку тут - покажемо форму входу з підказкою
                    return 'already_used';
                }
                
                currentInviteData = { id: inviteId, ...invite };
                return true;
            } catch (e) {
                console.error('Error checking invite:', e);
                currentInviteData = null;
                return false;
            }
        }
        
        function showLoginForm() {
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('registerForm').style.display = 'none';
            document.getElementById('noAccessCard').style.display = 'none';
            hideAuthMessage();
            
            // Скидаємо поля реєстрації
            const emailField = document.getElementById('registerEmail');
            emailField.value = '';
            emailField.readOnly = false;
            emailField.style.background = '';
            document.getElementById('registerPassword').value = '';
            document.getElementById('registerPasswordConfirm').value = '';
        }
        
        function showRegisterForm() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('registerForm').style.display = 'block';
            document.getElementById('noAccessCard').style.display = 'none';
            hideAuthMessage();
            
            // Скидаємо поля входу
            document.getElementById('loginEmail').value = '';
            document.getElementById('loginPassword').value = '';
            
            const emailField = document.getElementById('registerEmail');
            
            // Якщо є інвайт в URL — автозаповнюємо email
            if (currentInviteData && currentInviteData.email) {
                emailField.value = currentInviteData.email;
                emailField.readOnly = true;
                emailField.style.background = '#f0f0f0';
            } else {
                emailField.value = '';
                emailField.readOnly = false;
                emailField.style.background = '';
            }
        }
        
        // Реєстрація за запрошенням
        async function registerWithInvite() {
            const email = document.getElementById('registerEmail').value.trim().toLowerCase();
            const password = document.getElementById('registerPassword').value;
            const passwordConfirm = document.getElementById('registerPasswordConfirm').value;
            
            // Валідація
            if (!email) {
                showAuthMessage(currentLang === 'ua' ? 'Введіть email' : 'Введите email', 'error');
                return;
            }
            
            if (!password || password.length < 6) {
                showAuthMessage(currentLang === 'ua' ? 'Пароль має бути мінімум 6 символів' : 'Пароль должен быть минимум 6 символов', 'error');
                return;
            }
            
            if (password !== passwordConfirm) {
                showAuthMessage(currentLang === 'ua' ? 'Паролі не співпадають' : 'Пароли не совпадают', 'error');
                return;
            }
            
            try {
                let inviteData = currentInviteData;
                
                // Якщо немає інвайту в URL, шукаємо по email
                if (!inviteData) {
                    const invitesQuery = await db.collection('invites')
                        .where('email', '==', email)
                        .where('accepted', '==', false)
                        .limit(1)
                        .get();
                    
                    if (invitesQuery.empty) {
                        showAuthMessage(currentLang === 'ua' ? 'Запрошення для цього email не знайдено' : 'Приглашение для этого email не найдено', 'error');
                        return;
                    }
                    
                    inviteData = { id: invitesQuery.docs[0].id, ...invitesQuery.docs[0].data() };
                }
                
                // Перевіряємо що email співпадає з інвайтом
                if (inviteData.email.toLowerCase() !== email.toLowerCase()) {
                    showAuthMessage(currentLang === 'ua' ? 'Email не співпадає з запрошенням' : 'Email не совпадает с приглашением', 'error');
                    return;
                }
                
                showAuthMessage(currentLang === 'ua' ? 'Реєстрація...' : 'Регистрация...', 'info');
                
                // Створюємо користувача в Firebase Auth
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;
                
                // Invite буде оброблено в onAuthStateChanged через findUserCompany
                // (там же додається користувач в компанію з правильною роллю)
                
                // Очищаємо URL від параметра invite
                window.history.replaceState({}, document.title, window.location.pathname);
                currentInviteData = null;
                
                showAuthMessage(currentLang === 'ua' ? 'Успішно зареєстровано!' : 'Успешно зарегистрировано!', 'success');
                
            } catch (e) {
                let msg = currentLang === 'ua' ? 'Помилка реєстрації' : 'Ошибка регистрации';
                if (e.code === 'auth/email-already-in-use') {
                    msg = currentLang === 'ua' ? 'Цей email вже зареєстровано. Спробуйте увійти.' : 'Этот email уже зарегистрирован. Попробуйте войти.';
                }
                if (e.code === 'auth/invalid-email') {
                    msg = currentLang === 'ua' ? 'Невірний формат email' : 'Неверный формат email';
                }
                if (e.code === 'auth/weak-password') {
                    msg = currentLang === 'ua' ? 'Занадто простий пароль' : 'Слишком простой пароль';
                }
                showAuthMessage(msg, 'error');
            }
        }

        // Google Sign-In
        async function signInWithGoogle() {
            try {
                // На мобільних використовуємо redirect замість popup
                const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
                if (isMobile) {
                    await auth.signInWithRedirect(googleProvider);
                } else {
                    await auth.signInWithPopup(googleProvider);
                }
            } catch (e) {
                showAuthMessage(t('error') + ': ' + e.message, 'error');
            }
        }
        
        // Обробка результату redirect
        auth.getRedirectResult().then((result) => {
            if (result.user) {
                // Користувач увійшов через redirect
                console.log('Redirect login success');
            }
        }).catch((e) => {
            if (e.code) {
                showAuthMessage(t('error') + ': ' + e.message, 'error');
            }
        });

        // Email + Password Sign In
        async function signInWithEmail() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            if (!email || !password) {
                showAuthMessage(currentLang === 'ua' ? 'Введіть email і пароль' : 'Введите email и пароль', 'error');
                return;
            }
            
            try {
                await auth.signInWithEmailAndPassword(email, password);
            } catch (e) {
                let msg = currentLang === 'ua' ? 'Помилка входу' : 'Ошибка входа';
                if (e.code === 'auth/user-not-found') msg = currentLang === 'ua' ? 'Користувача не знайдено' : 'Пользователь не найден';
                if (e.code === 'auth/wrong-password') msg = currentLang === 'ua' ? 'Невірний пароль' : 'Неверный пароль';
                if (e.code === 'auth/invalid-email') msg = currentLang === 'ua' ? 'Невірний формат email' : 'Неверный формат email';
                if (e.code === 'auth/invalid-credential') msg = currentLang === 'ua' ? 'Невірний email або пароль' : 'Неверный email или пароль';
                showAuthMessage(msg, 'error');
            }
        }

        // Password Reset
        async function resetPassword() {
            const email = document.getElementById('loginEmail').value.trim();
            if (!email) {
                showAuthMessage(currentLang === 'ua' ? 'Введіть email для відновлення пароля' : 'Введите email для восстановления пароля', 'error');
                return;
            }
            
            try {
                await auth.sendPasswordResetEmail(email);
                showAuthMessage(currentLang === 'ua' ? 'Посилання надіслано на ' + email : 'Ссылка отправлена на ' + email, 'success');
            } catch (e) {
                showAuthMessage(t('error') + ': ' + e.message, 'error');
            }
        }

        async function findUserCompany(userId, email) {
            const userDoc = await db.collection('users').doc(userId).get();
            if (userDoc.exists) {
                return userDoc.data().companyId;
            }
            
            const invitesQuery = await db.collection('invites')
                .where('email', '==', email.toLowerCase())
                .where('accepted', '==', false)
                .limit(1)
                .get();
            
            if (!invitesQuery.empty) {
                const invite = invitesQuery.docs[0];
                const inviteData = invite.data();
                const companyId = inviteData.companyId;
                const isOwnerInvite = inviteData.role === 'owner';
                
                await db.collection('companies').doc(companyId).collection('users').doc(userId).set({
                    name: inviteData.ownerName || email.split('@')[0],
                    email: email.toLowerCase(),
                    role: inviteData.role || 'employee',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                await db.collection('users').doc(userId).set({
                    email: email.toLowerCase(),
                    companyId: companyId,
                    role: inviteData.role || 'employee'
                });
                
                if (isOwnerInvite) {
                    await db.collection('companies').doc(companyId).update({
                        ownerId: userId
                    });
                }
                
                await invite.ref.update({ accepted: true, acceptedAt: firebase.firestore.FieldValue.serverTimestamp() });
                
                return companyId;
            }
            
            return null;
        }

        function logout() {
            auth.signOut().then(() => {
                showLoginForm();
                hideAuthMessage();
            });
        }

        // =====================
        // AUTH STATE LISTENER
        // =====================
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                isSuperAdmin = user.email.toLowerCase() === SUPERADMIN_EMAIL.toLowerCase();
                
                if (isSuperAdmin) {
                    document.getElementById('adminTabBtn').style.display = 'block';
                }
                
                const companyId = await findUserCompany(user.uid, user.email);
                
                if (!companyId && !isSuperAdmin) {
                    document.getElementById('loadingPage').style.display = 'none';
                    document.getElementById('authPage').style.display = 'flex';
                    document.getElementById('mainInterface').style.display = 'none';
                    showNoAccess();
                    return;
                }
                
                if (!companyId && isSuperAdmin) {
                    currentCompany = null;
                    currentUserData = { id: user.uid, email: user.email, role: 'superadmin', name: 'Super Admin' };
                    document.getElementById('currentUserName').textContent = 'Super Admin';
                    document.getElementById('currentUserRole').textContent = currentLang === 'ua' ? '(Адміністратор)' : '(Администратор)';
                    document.getElementById('companyBadge').textContent = 'TALKO System';
                    document.getElementById('companyBadge').style.display = 'inline';
                    showMainInterface();
                    return;
                }
                
                currentCompany = companyId;
                
                const userDoc = await db.collection('companies').doc(companyId).collection('users').doc(user.uid).get();
                currentUserData = userDoc.exists ? { id: user.uid, ...userDoc.data() } : { id: user.uid, email: user.email, role: 'employee' };
                
                const companyDoc = await db.collection('companies').doc(companyId).get();
                const companyData = companyDoc.data();
                
                document.getElementById('currentUserName').textContent = currentUserData.name || user.displayName || user.email;
                document.getElementById('currentUserRole').textContent = `(${getRoleText(currentUserData.role)})`;
                document.getElementById('companyBadge').textContent = companyData?.name || '';
                document.getElementById('companyBadge').style.display = 'inline';
                
                if (currentUserData.role === 'employee') {
                    document.getElementById('inviteBtn').style.display = 'none';
                    document.getElementById('demoDataBtn').style.display = 'none';
                }
                
                // Show demo data button for owner/manager
                if (currentUserData.role === 'owner' || currentUserData.role === 'manager') {
                    document.getElementById('demoDataBtnDesktop').style.display = 'flex';
                }
                
                showMainInterface();
                initCalendar();
                initRegularView();
                initGoogleCalendar();
                loadAllData();
            } else {
                document.getElementById('loadingPage').style.display = 'none';
                document.getElementById('authPage').style.display = 'flex';
                document.getElementById('mainInterface').style.display = 'none';
                document.getElementById('logoutBtn').style.display = 'none';
                document.getElementById('adminTabBtn').style.display = 'none';
                
                // Перевіряємо чи є інвайт в URL
                const urlParams = new URLSearchParams(window.location.search);
                const inviteId = urlParams.get('invite');
                
                if (inviteId) {
                    // Є invite в URL — перевіряємо валідність і показуємо форму реєстрації
                    checkInviteUrl().then(result => {
                        if (result === true) {
                            showRegisterForm(); // Тепер currentInviteData вже заповнено
                        } else if (result === 'already_used') {
                            showLoginForm();
                            showAuthMessage(currentLang === 'ua' ? 'Це запрошення вже використано. Увійдіть з вашим email та паролем.' : 'Это приглашение уже использовано. Войдите с вашим email и паролем.', 'info');
                        } else {
                            showRegisterForm(); // Показуємо форму все одно, нехай вводить email вручну
                            showAuthMessage(currentLang === 'ua' ? 'Запрошення не знайдено. Введіть email з якого вас запрошували.' : 'Приглашение не найдено. Введите email с которого вас приглашали.', 'error');
                        }
                    });
                } else {
                    showLoginForm();
                }
            }
        });

        function showMainInterface() {
            document.getElementById('loadingPage').style.display = 'none';
            document.getElementById('authPage').style.display = 'none';
            document.getElementById('mainInterface').style.display = 'block';
            document.getElementById('logoutBtn').style.display = 'block';
            document.getElementById('currentUserInfo').style.display = 'flex';
        }

        function getRoleText(role) {
            if (currentLang === 'ua') {
                return { owner: 'Власник', manager: 'Менеджер', employee: 'Співробітник', superadmin: 'Адміністратор' }[role] || role;
            } else {
                return { owner: 'Владелец', manager: 'Менеджер', employee: 'Сотрудник', superadmin: 'Администратор' }[role] || role;
            }
        }

        // =====================
        // DATA LOADING
        // =====================
        async function loadAllData() {
            if (!currentCompany) return;
            
            const usersSnap = await db.collection('companies').doc(currentCompany).collection('users').get();
            users = usersSnap.docs.map(d => ({ id: d.id, ...d.data() }));
            
            const funcsSnap = await db.collection('companies').doc(currentCompany).collection('functions').get();
            functions = funcsSnap.docs.map(d => ({ id: d.id, ...d.data() }));
            
            const tasksSnap = await db.collection('companies').doc(currentCompany).collection('tasks').orderBy('createdAt', 'desc').get();
            tasks = tasksSnap.docs.map(d => ({ id: d.id, ...d.data() }));
            
            const regSnap = await db.collection('companies').doc(currentCompany).collection('regularTasks').get();
            regularTasks = regSnap.docs.map(d => ({ id: d.id, ...d.data() }));
            
            updateSelects();
            
            // Render based on current view
            if (currentCalendarView === 'list') {
                renderTasks();
            } else {
                renderCalendar();
            }
            
            // Render regular tasks view
            if (currentRegularView === 'list') {
                renderRegularTasks();
            } else {
                renderRegularWeekView();
            }
        }

        // =====================
        // TASKS
        // =====================
        function openTaskModal(id = null) {
            document.getElementById('taskModal').style.display = 'block';
            updateSelects();
            
            // Initialize comments section
            initTaskComments(id);
            
            if (id) {
                editingId = id;
                const task = tasks.find(x => x.id === id);
                if (task) {
                    document.getElementById('taskModalTitle').textContent = t('editTask');
                    document.getElementById('taskTitle').value = task.title || '';
                    document.getElementById('taskFunction').value = task.function || '';
                    document.getElementById('taskAssignee').value = task.assigneeId || '';
                    // Розбиваємо deadline на дату і час
                    if (task.deadlineDate) {
                        document.getElementById('taskDeadlineDate').value = task.deadlineDate;
                        document.getElementById('taskDeadlineTime').value = task.deadlineTime || '18:00';
                    } else if (task.deadline) {
                        // Сумісність зі старими завданнями
                        const dt = task.deadline.split('T');
                        document.getElementById('taskDeadlineDate').value = dt[0] || '';
                        document.getElementById('taskDeadlineTime').value = dt[1]?.slice(0,5) || '18:00';
                    } else {
                        document.getElementById('taskDeadlineDate').value = '';
                        document.getElementById('taskDeadlineTime').value = '';
                    }
                    document.getElementById('taskEstimatedTime').value = task.estimatedTime || '';
                    document.getElementById('taskPriority').value = task.priority || 'medium';
                    document.getElementById('taskStatus').value = task.status || 'new';
                    document.getElementById('taskExpectedResult').value = task.expectedResult || '';
                    document.getElementById('taskReportFormat').value = task.reportFormat || '';
                    document.getElementById('taskDescription').value = task.description || '';
                }
            } else {
                editingId = null;
                document.getElementById('taskModalTitle').textContent = t('newTask');
                document.getElementById('taskForm').reset();
                // Встановлюємо дефолтний час
                document.getElementById('taskDeadlineTime').value = '18:00';
            }
        }

        async function saveTask(e) {
            e.preventDefault();
            
            const assigneeId = document.getElementById('taskAssignee').value;
            const assignee = users.find(u => u.id === assigneeId);
            const deadlineDate = document.getElementById('taskDeadlineDate').value;
            const deadlineTime = document.getElementById('taskDeadlineTime').value;
            
            const data = {
                title: document.getElementById('taskTitle').value.trim(),
                function: document.getElementById('taskFunction').value,
                assigneeId: assigneeId,
                assigneeName: assignee?.name || assignee?.email || '',
                deadlineDate: deadlineDate,
                deadlineTime: deadlineTime,
                deadline: deadlineDate + 'T' + deadlineTime, // для сумісності
                estimatedTime: document.getElementById('taskEstimatedTime').value,
                priority: document.getElementById('taskPriority').value,
                status: document.getElementById('taskStatus').value,
                expectedResult: document.getElementById('taskExpectedResult').value.trim(),
                reportFormat: document.getElementById('taskReportFormat').value.trim(),
                description: document.getElementById('taskDescription').value.trim(),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            try {
                if (editingId) {
                    // Update existing task
                    const existingTask = tasks.find(t => t.id === editingId);
                    await db.collection('companies').doc(currentCompany).collection('tasks').doc(editingId).update(data);
                    
                    // Sync with Google Calendar
                    if (existingTask?.calendarEventId && googleAccessToken) {
                        updateCalendarEvent(existingTask.calendarEventId, data);
                    }
                } else {
                    // Create new task
                    data.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                    data.createdDate = new Date().toISOString().split('T')[0];
                    data.creatorId = currentUser.uid;
                    data.creatorName = currentUserData?.name || currentUser.email;
                    data.pinned = false;
                    
                    const docRef = await db.collection('companies').doc(currentCompany).collection('tasks').add(data);
                    
                    // Sync with Google Calendar (only if date is set)
                    if (deadlineDate && googleAccessToken) {
                        const calendarEventId = await createCalendarEvent(data);
                        if (calendarEventId) {
                            await docRef.update({ calendarEventId: calendarEventId });
                        }
                    }
                }
                
                closeModal('taskModal');
                loadAllData();
            } catch (e) {
                alert(t('error') + ': ' + e.message);
            }
        }

        async function deleteTask(id) {
            if (!confirm(t('deleteConfirm'))) return;
            
            // Delete from Google Calendar if connected
            const task = tasks.find(t => t.id === id);
            if (task?.calendarEventId && googleAccessToken) {
                deleteCalendarEvent(task.calendarEventId);
            }
            
            await db.collection('companies').doc(currentCompany).collection('tasks').doc(id).delete();
            loadAllData();
        }

        async function togglePin(id) {
            const task = tasks.find(x => x.id === id);
            if (task) {
                await db.collection('companies').doc(currentCompany).collection('tasks').doc(id).update({ pinned: !task.pinned });
                loadAllData();
            }
        }

        // Mobile quick complete
        async function quickCompleteTask(id) {
            try {
                // Delete from Google Calendar when completed
                const task = tasks.find(t => t.id === id);
                if (task?.calendarEventId && googleAccessToken) {
                    deleteCalendarEvent(task.calendarEventId);
                }
                
                await db.collection('companies').doc(currentCompany).collection('tasks').doc(id).update({ 
                    status: 'done',
                    completedAt: new Date().toISOString()
                });
                loadAllData();
            } catch (e) {
                alert(t('error') + ': ' + e.message);
            }
        }
        
        // Reopen completed task
        async function reopenTask(id) {
            try {
                await db.collection('companies').doc(currentCompany).collection('tasks').doc(id).update({ 
                    status: 'progress',
                    completedAt: null
                });
                loadAllData();
            } catch (e) {
                alert(t('error') + ': ' + e.message);
            }
        }

        // =====================
        // CALENDAR VIEW
        // =====================
        
        let currentCalendarView = 'day'; // day, week, month, list
        let calendarDate = new Date(); // Currently displayed date
        
        const dayNames = ['Неділя', 'Понеділок', 'Вівторок', 'Середа', 'Четвер', 'Пʼятниця', 'Субота'];
        const dayNamesShort = ['Нд', 'Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб'];
        const monthNames = ['Січень', 'Лютий', 'Березень', 'Квітень', 'Травень', 'Червень', 
                           'Липень', 'Серпень', 'Вересень', 'Жовтень', 'Листопад', 'Грудень'];
        
        function setCalendarView(view) {
            currentCalendarView = view;
            
            // Update buttons
            document.querySelectorAll('.calendar-view-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.view === view);
            });
            
            // Show/hide containers
            const calendarContainer = document.getElementById('calendarContainer');
            const listContainer = document.getElementById('listContainer');
            
            if (view === 'list') {
                calendarContainer.classList.remove('active');
                listContainer.classList.add('active');
                renderTasks();
            } else {
                calendarContainer.classList.add('active');
                listContainer.classList.remove('active');
                renderCalendar();
            }
            
            // Save preference
            localStorage.setItem('calendarView', view);
        }
        
        function calendarPrev() {
            if (currentCalendarView === 'day') {
                calendarDate.setDate(calendarDate.getDate() - 1);
            } else if (currentCalendarView === 'week') {
                calendarDate.setDate(calendarDate.getDate() - 7);
            } else if (currentCalendarView === 'month') {
                calendarDate.setMonth(calendarDate.getMonth() - 1);
            }
            renderCalendar();
        }
        
        function calendarNext() {
            if (currentCalendarView === 'day') {
                calendarDate.setDate(calendarDate.getDate() + 1);
            } else if (currentCalendarView === 'week') {
                calendarDate.setDate(calendarDate.getDate() + 7);
            } else if (currentCalendarView === 'month') {
                calendarDate.setMonth(calendarDate.getMonth() + 1);
            }
            renderCalendar();
        }
        
        function calendarToday() {
            calendarDate = new Date();
            renderCalendar();
        }
        
        function renderCalendar() {
            updateCalendarTitle();
            renderWeekStrip(); // Mobile week strip
            
            if (currentCalendarView === 'day') {
                renderDayView();
            } else if (currentCalendarView === 'week') {
                renderWeekView();
            } else if (currentCalendarView === 'month') {
                renderMonthView();
            }
            
            refreshIcons();
        }
        
        // Mobile Week Strip (Google Calendar style)
        function renderWeekStrip() {
            const container = document.getElementById('weekStripDays');
            if (!container) return;
            
            const today = new Date();
            const todayStr = today.toDateString();
            const selectedStr = calendarDate.toDateString();
            
            // Get start of current week
            const weekStart = new Date(calendarDate);
            weekStart.setDate(calendarDate.getDate() - calendarDate.getDay());
            
            const shortDays = ['Нд', 'Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб'];
            
            let html = '';
            
            for (let i = 0; i < 7; i++) {
                const day = new Date(weekStart);
                day.setDate(weekStart.getDate() + i);
                const dayStr = day.toISOString().split('T')[0];
                
                const isToday = day.toDateString() === todayStr;
                const isSelected = day.toDateString() === selectedStr;
                
                // Get tasks for this day
                const dayTasks = tasks.filter(task => {
                    if (!task.deadline) return false;
                    const taskDate = task.deadline.toDate ? task.deadline.toDate() : new Date(task.deadline);
                    return taskDate.toISOString().split('T')[0] === dayStr;
                });
                
                // Generate task dots (max 3)
                const taskDots = dayTasks.slice(0, 3).map(t => 
                    `<div class="task-dot status-${t.status}"></div>`
                ).join('');
                
                const classes = ['week-strip-day'];
                if (isToday) classes.push('today');
                if (isSelected) classes.push('selected');
                if (dayTasks.length > 0) classes.push('has-tasks');
                
                html += `
                    <div class="${classes.join(' ')}" onclick="selectWeekStripDay('${dayStr}')">
                        <div class="day-label">${shortDays[i]}</div>
                        <div class="day-num">${day.getDate()}</div>
                        <div class="task-dots">${taskDots}</div>
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }
        
        function selectWeekStripDay(dateStr) {
            calendarDate = new Date(dateStr);
            renderCalendar();
        }
        
        function updateCalendarTitle() {
            const titleEl = document.getElementById('calendarTitle');
            const isMobile = window.innerWidth <= 767;
            
            if (currentCalendarView === 'day') {
                if (isMobile) {
                    // Mobile: just month and year like Google Calendar
                    titleEl.textContent = `${monthNames[calendarDate.getMonth()]} ${calendarDate.getFullYear()}`;
                } else {
                    titleEl.textContent = `${calendarDate.getDate()} ${monthNames[calendarDate.getMonth()]} ${calendarDate.getFullYear()}`;
                }
            } else if (currentCalendarView === 'week') {
                const weekStart = new Date(calendarDate);
                weekStart.setDate(calendarDate.getDate() - calendarDate.getDay());
                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekStart.getDate() + 6);
                
                if (weekStart.getMonth() === weekEnd.getMonth()) {
                    titleEl.textContent = `${weekStart.getDate()} - ${weekEnd.getDate()} ${monthNames[weekStart.getMonth()]} ${weekStart.getFullYear()}`;
                } else {
                    titleEl.textContent = `${weekStart.getDate()} ${monthNames[weekStart.getMonth()].slice(0,3)} - ${weekEnd.getDate()} ${monthNames[weekEnd.getMonth()].slice(0,3)} ${weekEnd.getFullYear()}`;
                }
            } else if (currentCalendarView === 'month') {
                titleEl.textContent = `${monthNames[calendarDate.getMonth()]} ${calendarDate.getFullYear()}`;
            }
        }
        
        // Mobile Agenda View (Apple Calendar Style)
        function renderMobileAgenda() {
            const agendaList = document.getElementById('agendaList');
            const agendaHeader = document.getElementById('agendaHeader');
            const agendaSubheader = document.getElementById('agendaSubheader');
            
            if (!agendaList) return;
            
            const today = new Date();
            const todayStr = today.toDateString();
            const selectedStr = calendarDate.toDateString();
            const dayStr = calendarDate.toISOString().split('T')[0];
            
            // Set header
            const isToday = selectedStr === todayStr;
            const isTomorrow = calendarDate.toDateString() === new Date(today.getTime() + 86400000).toDateString();
            const isYesterday = calendarDate.toDateString() === new Date(today.getTime() - 86400000).toDateString();
            
            if (isToday) {
                agendaHeader.textContent = 'Сьогодні';
            } else if (isTomorrow) {
                agendaHeader.textContent = 'Завтра';
            } else if (isYesterday) {
                agendaHeader.textContent = 'Вчора';
            } else {
                agendaHeader.textContent = calendarDate.toLocaleDateString('uk-UA', { weekday: 'long', day: 'numeric', month: 'long' });
            }
            
            // Subheader with full date
            agendaSubheader.textContent = calendarDate.toLocaleDateString('uk-UA', { day: 'numeric', month: 'long', year: 'numeric' });
            
            // Get tasks for selected day
            const dayTasks = tasks.filter(task => {
                if (!task.deadline) return false;
                const taskDate = task.deadline.toDate ? task.deadline.toDate() : new Date(task.deadline);
                return taskDate.toISOString().split('T')[0] === dayStr;
            }).sort((a, b) => {
                const aDate = a.deadline?.toDate ? a.deadline.toDate() : new Date(a.deadline);
                const bDate = b.deadline?.toDate ? b.deadline.toDate() : new Date(b.deadline);
                return aDate - bDate;
            });
            
            if (dayTasks.length === 0) {
                agendaList.innerHTML = `
                    <div class="agenda-empty">
                        <div class="agenda-empty-icon">📅</div>
                        <div class="agenda-empty-text">Немає завдань</div>
                    </div>
                `;
                return;
            }
            
            let html = '';
            
            dayTasks.forEach(task => {
                const deadline = task.deadline?.toDate ? task.deadline.toDate() : new Date(task.deadline);
                const timeStr = deadline.toLocaleTimeString('uk-UA', { hour: '2-digit', minute: '2-digit' });
                const isDone = task.status === 'done';
                const durationStr = task.estimatedTime ? formatDuration(parseInt(task.estimatedTime)) : '';
                
                html += `
                    <div class="agenda-item ${isDone ? 'done' : ''}" onclick="showTaskQuickMenu(event, '${task.id}')">
                        <div class="agenda-item-color status-${task.status}"></div>
                        <div class="agenda-item-content">
                            <div class="agenda-item-title">${task.title}</div>
                            <div class="agenda-item-meta">
                                <span class="agenda-item-time">${timeStr}</span>
                                ${durationStr ? ` • ${durationStr}` : ''}
                                ${task.assigneeName ? ` • ${task.assigneeName}` : ''}
                            </div>
                        </div>
                        <div class="agenda-item-check" onclick="event.stopPropagation();toggleTaskFromAgenda('${task.id}')">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>
                        </div>
                    </div>
                `;
            });
            
            agendaList.innerHTML = html;
        }
        
        // Toggle task completion from agenda
        async function toggleTaskFromAgenda(taskId) {
            // Haptic feedback
            if (navigator.vibrate) navigator.vibrate(10);
            
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;
            
            const newStatus = task.status === 'done' ? 'in_progress' : 'done';
            
            if (newStatus === 'done' && task.calendarEventId && googleAccessToken) {
                deleteCalendarEvent(task.calendarEventId);
            }
            
            await db.collection('companies').doc(currentCompany).collection('tasks').doc(taskId).update({
                status: newStatus,
                completedAt: newStatus === 'done' ? new Date().toISOString() : null
            });
            
            loadAllData();
        }
        
        function renderDayView() {
            // Hide other views
            document.getElementById('calendarDayView').style.display = 'block';
            document.getElementById('calendarWeekView').style.display = 'none';
            document.getElementById('calendarMonthView').style.display = 'none';
            
            // Render mobile agenda
            renderMobileAgenda();
            
            const today = new Date();
            const isToday = calendarDate.toDateString() === today.toDateString();
            
            // Update header
            const headerEl = document.getElementById('dayColumnHeader');
            headerEl.className = 'calendar-day-column-header' + (isToday ? ' today' : '');
            headerEl.innerHTML = `
                <div class="day-name">${dayNames[calendarDate.getDay()]}</div>
                <div class="day-number">${calendarDate.getDate()}</div>
            `;
            
            // Build time slots
            const timeSlotsEl = document.getElementById('calendarTimeSlots');
            const eventsContainerEl = document.getElementById('calendarEventsContainer');
            
            const dayStr = calendarDate.toISOString().split('T')[0];
            
            let timeSlotsHTML = '';
            let hoursHTML = '';
            
            for (let hour = 0; hour < 24; hour++) {
                const timeStr = hour.toString().padStart(2, '0') + ':00';
                timeSlotsHTML += `<div class="calendar-time-slot">${timeStr}</div>`;
                hoursHTML += `<div class="calendar-hour-row" data-hour="${hour}" data-date="${dayStr}" onclick="openTaskAtTime('${dayStr}', ${hour})" ondragover="onHourDragOver(event)" ondragleave="onHourDragLeave(event)" ondrop="onHourDrop(event, '${dayStr}', ${hour})"></div>`;
            }
            
            timeSlotsEl.innerHTML = timeSlotsHTML;
            
            // Keep current time line
            const currentTimeLineHTML = '<div class="calendar-current-time" id="currentTimeLine" style="display:none;"></div>';
            eventsContainerEl.innerHTML = hoursHTML + currentTimeLineHTML;
            
            // Filter tasks for this day
            const dayTasks = tasks.filter(task => {
                if (!task.deadline) return false;
                const taskDate = task.deadline.toDate ? task.deadline.toDate() : new Date(task.deadline);
                return taskDate.toISOString().split('T')[0] === dayStr;
            });
            
            // Separate all-day and timed tasks
            const allDayTasks = [];
            const timedTasks = [];
            
            dayTasks.forEach(task => {
                const deadline = task.deadline.toDate ? task.deadline.toDate() : new Date(task.deadline);
                const hours = deadline.getHours();
                const minutes = deadline.getMinutes();
                
                // If task has no specific time (00:00) and no estimated time, treat as all-day
                if (hours === 0 && minutes === 0 && !task.estimatedTime) {
                    allDayTasks.push(task);
                } else {
                    timedTasks.push({ ...task, deadlineDate: deadline });
                }
            });
            
            // Render all-day section
            const alldayEl = document.getElementById('calendarAllday');
            if (allDayTasks.length > 0) {
                alldayEl.style.display = 'block';
                alldayEl.innerHTML = `
                    <div class="calendar-allday-label">Без часу (${allDayTasks.length})</div>
                    ${allDayTasks.map(task => `
                        <div class="calendar-allday-event calendar-event status-${task.status}" onclick="showTaskQuickMenu(event, '${task.id}')">
                            ${task.status === 'done' ? '<span style="margin-right:4px;">✓</span>' : ''}
                            ${task.title}
                        </div>
                    `).join('')}
                `;
            } else {
                alldayEl.style.display = 'none';
            }
            
            // Render timed events
            timedTasks.forEach(task => {
                const deadline = task.deadlineDate;
                const startHour = deadline.getHours();
                const startMinute = deadline.getMinutes();
                
                // Calculate duration (use estimatedTime or default to 60 min)
                const durationMinutes = task.estimatedTime ? parseInt(task.estimatedTime) : 60;
                
                // Calculate position and height
                const topOffset = startHour * 60 + startMinute;
                const height = Math.max(durationMinutes, 20); // Minimum 20px height
                
                const eventHTML = `
                    <div class="calendar-event status-${task.status}" 
                         style="top: ${topOffset}px; height: ${height}px;"
                         onclick="showTaskQuickMenu(event, '${task.id}')"
                         draggable="true"
                         ondragstart="onTaskDragStart(event, '${task.id}')"
                         title="${task.title}">
                        ${task.status === 'done' ? '<div class="calendar-event-done-mark"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"></polyline></svg></div>' : ''}
                        <div class="calendar-event-title">${task.title}</div>
                        <div class="calendar-event-time">${startHour.toString().padStart(2,'0')}:${startMinute.toString().padStart(2,'0')} • ${formatDuration(durationMinutes)}</div>
                    </div>
                `;
                eventsContainerEl.insertAdjacentHTML('beforeend', eventHTML);
            });
            
            // Show current time line if viewing today
            if (isToday) {
                updateCurrentTimeLine();
            }
        }
        
        function formatDuration(minutes) {
            if (minutes < 60) return `${minutes} хв`;
            const hours = Math.floor(minutes / 60);
            const mins = minutes % 60;
            return mins > 0 ? `${hours} год ${mins} хв` : `${hours} год`;
        }
        
        function updateCurrentTimeLine() {
            const now = new Date();
            const today = new Date();
            
            if (calendarDate.toDateString() !== today.toDateString()) {
                document.getElementById('currentTimeLine').style.display = 'none';
                return;
            }
            
            const line = document.getElementById('currentTimeLine');
            if (line) {
                const topOffset = now.getHours() * 60 + now.getMinutes();
                line.style.display = 'block';
                line.style.top = topOffset + 'px';
            }
        }
        
        function renderWeekView() {
            document.getElementById('calendarDayView').style.display = 'none';
            document.getElementById('calendarWeekView').style.display = 'block';
            document.getElementById('calendarMonthView').style.display = 'none';
            
            const weekStart = new Date(calendarDate);
            weekStart.setDate(calendarDate.getDate() - calendarDate.getDay());
            
            const today = new Date();
            const todayStr = today.toDateString();
            
            // Build header
            const headerEl = document.getElementById('weekHeader');
            let headerHTML = '<div class="calendar-time-gutter"></div>';
            
            for (let i = 0; i < 7; i++) {
                const day = new Date(weekStart);
                day.setDate(weekStart.getDate() + i);
                const isToday = day.toDateString() === todayStr;
                
                headerHTML += `
                    <div class="calendar-week-day-header ${isToday ? 'today' : ''}">
                        <div class="day-name">${dayNamesShort[i]}</div>
                        <div class="day-number" ${isToday ? 'style="background:var(--primary);color:white;border-radius:50%;width:28px;height:28px;display:inline-flex;align-items:center;justify-content:center;"' : ''}>${day.getDate()}</div>
                    </div>
                `;
            }
            headerEl.innerHTML = headerHTML;
            
            // Build body with time slots
            const bodyEl = document.getElementById('weekBody');
            let bodyHTML = '<div class="calendar-time-slots">';
            
            for (let hour = 0; hour < 24; hour++) {
                bodyHTML += `<div class="calendar-time-slot">${hour.toString().padStart(2, '0')}:00</div>`;
            }
            bodyHTML += '</div>';
            
            // Build columns for each day
            for (let i = 0; i < 7; i++) {
                const day = new Date(weekStart);
                day.setDate(weekStart.getDate() + i);
                const dayStr = day.toISOString().split('T')[0];
                
                bodyHTML += `<div class="calendar-week-day-column" data-date="${dayStr}">`;
                
                // Hour rows
                for (let hour = 0; hour < 24; hour++) {
                    bodyHTML += `<div class="calendar-hour-row" data-hour="${hour}" onclick="openTaskAtTime('${dayStr}', ${hour})" ondragover="onHourDragOver(event)" ondragleave="onHourDragLeave(event)" ondrop="onHourDrop(event, '${dayStr}', ${hour})"></div>`;
                }
                
                // Get tasks for this day
                const dayTasks = tasks.filter(task => {
                    if (!task.deadline) return false;
                    const taskDate = task.deadline.toDate ? task.deadline.toDate() : new Date(task.deadline);
                    return taskDate.toISOString().split('T')[0] === dayStr;
                });
                
                // Render events
                dayTasks.forEach(task => {
                    const deadline = task.deadline.toDate ? task.deadline.toDate() : new Date(task.deadline);
                    const startHour = deadline.getHours();
                    const startMinute = deadline.getMinutes();
                    const durationMinutes = task.estimatedTime ? parseInt(task.estimatedTime) : 60;
                    
                    const topOffset = startHour * 60 + startMinute;
                    const height = Math.max(durationMinutes, 20);
                    
                    bodyHTML += `
                        <div class="calendar-event status-${task.status}" 
                             style="position:absolute; top:${topOffset}px; height:${height}px; left:2px; right:2px;"
                             onclick="showTaskQuickMenu(event, '${task.id}')"
                             draggable="true"
                             ondragstart="onTaskDragStart(event, '${task.id}')"
                             title="${task.title}">
                            <div class="calendar-event-title" style="font-size:0.7rem;">${task.title}</div>
                        </div>
                    `;
                });
                
                bodyHTML += '</div>';
            }
            
            bodyEl.innerHTML = bodyHTML;
        }
        
        function renderMonthView() {
            document.getElementById('calendarDayView').style.display = 'none';
            document.getElementById('calendarWeekView').style.display = 'none';
            document.getElementById('calendarMonthView').style.display = 'block';
            
            const year = calendarDate.getFullYear();
            const month = calendarDate.getMonth();
            
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDay = firstDay.getDay(); // Day of week (0 = Sunday)
            const daysInMonth = lastDay.getDate();
            
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];
            
            // Get prev month's last days
            const prevMonthLastDay = new Date(year, month, 0).getDate();
            
            const bodyEl = document.getElementById('monthBody');
            let html = '';
            
            let dayCounter = 1;
            let nextMonthDay = 1;
            
            // Calculate total cells needed (6 weeks max)
            const totalCells = 42;
            
            for (let i = 0; i < totalCells; i++) {
                let dayNum, dateStr, isOtherMonth = false;
                
                if (i < startDay) {
                    // Previous month
                    dayNum = prevMonthLastDay - startDay + i + 1;
                    const prevMonth = month === 0 ? 11 : month - 1;
                    const prevYear = month === 0 ? year - 1 : year;
                    dateStr = `${prevYear}-${(prevMonth + 1).toString().padStart(2, '0')}-${dayNum.toString().padStart(2, '0')}`;
                    isOtherMonth = true;
                } else if (dayCounter <= daysInMonth) {
                    // Current month
                    dayNum = dayCounter;
                    dateStr = `${year}-${(month + 1).toString().padStart(2, '0')}-${dayNum.toString().padStart(2, '0')}`;
                    dayCounter++;
                } else {
                    // Next month
                    dayNum = nextMonthDay;
                    const nextMonth = month === 11 ? 0 : month + 1;
                    const nextYear = month === 11 ? year + 1 : year;
                    dateStr = `${nextYear}-${(nextMonth + 1).toString().padStart(2, '0')}-${dayNum.toString().padStart(2, '0')}`;
                    nextMonthDay++;
                    isOtherMonth = true;
                }
                
                const isToday = dateStr === todayStr;
                
                // Get tasks for this day
                const dayTasks = tasks.filter(task => {
                    if (!task.deadline) return false;
                    const taskDate = task.deadline.toDate ? task.deadline.toDate() : new Date(task.deadline);
                    return taskDate.toISOString().split('T')[0] === dateStr;
                });
                
                html += `
                    <div class="calendar-month-day ${isOtherMonth ? 'other-month' : ''} ${isToday ? 'today' : ''}" 
                         data-date="${dateStr}"
                         onclick="goToDay('${dateStr}')">
                        <div class="month-day-number">${dayNum}</div>
                        ${dayTasks.slice(0, 3).map(task => `
                            <div class="calendar-month-event calendar-event status-${task.status}" 
                                 onclick="event.stopPropagation(); showTaskQuickMenu(event, '${task.id}')">
                                ${task.title}
                            </div>
                        `).join('')}
                        ${dayTasks.length > 3 ? `<div class="calendar-month-more">+${dayTasks.length - 3} ще</div>` : ''}
                    </div>
                `;
            }
            
            bodyEl.innerHTML = html;
        }
        
        function goToDay(dateStr) {
            calendarDate = new Date(dateStr);
            setCalendarView('day');
        }
        
        // Initialize calendar
        function initCalendar() {
            // Load saved view preference
            const savedView = localStorage.getItem('calendarView') || 'day';
            setCalendarView(savedView);
            
            // Generate time slots
            renderCalendar();
            
            // Update current time line every minute
            setInterval(updateCurrentTimeLine, 60000);
            
            // Setup swipe navigation for mobile
            setupCalendarSwipe();
        }
        
        // Swipe navigation for mobile calendar
        function setupCalendarSwipe() {
            const dayView = document.getElementById('calendarDayView');
            const weekView = document.getElementById('calendarWeekView');
            const weekStrip = document.getElementById('mobileWeekStrip');
            
            [dayView, weekView, weekStrip].forEach(view => {
                if (!view) return;
                
                let touchStartX = 0;
                let touchStartY = 0;
                let touchEndX = 0;
                let isSwiping = false;
                
                view.addEventListener('touchstart', (e) => {
                    touchStartX = e.changedTouches[0].screenX;
                    touchStartY = e.changedTouches[0].screenY;
                    isSwiping = true;
                }, { passive: true });
                
                view.addEventListener('touchmove', (e) => {
                    if (!isSwiping) return;
                    const diffY = Math.abs(e.changedTouches[0].screenY - touchStartY);
                    // Cancel swipe if scrolling vertically
                    if (diffY > 30) {
                        isSwiping = false;
                    }
                }, { passive: true });
                
                view.addEventListener('touchend', (e) => {
                    if (!isSwiping) return;
                    touchEndX = e.changedTouches[0].screenX;
                    handleCalendarSwipe(touchStartX, touchEndX, view === weekStrip);
                    isSwiping = false;
                }, { passive: true });
            });
        }
        
        function handleCalendarSwipe(startX, endX, isWeekStrip) {
            const swipeThreshold = 70;
            const diff = startX - endX;
            
            if (Math.abs(diff) < swipeThreshold) return;
            
            if (isWeekStrip) {
                // Swipe on week strip → change week
                if (diff > 0) {
                    calendarDate.setDate(calendarDate.getDate() + 7);
                } else {
                    calendarDate.setDate(calendarDate.getDate() - 7);
                }
                renderCalendar();
            } else {
                if (diff > 0) {
                    // Swipe left → next day/week
                    navigateCalendar(1);
                } else {
                    // Swipe right → prev day/week
                    navigateCalendar(-1);
                }
            }
        }
        
        function navigateCalendar(direction) {
            if (currentCalendarView === 'day') {
                calendarDate.setDate(calendarDate.getDate() + direction);
            } else if (currentCalendarView === 'week') {
                calendarDate.setDate(calendarDate.getDate() + (direction * 7));
            } else if (currentCalendarView === 'month') {
                calendarDate.setMonth(calendarDate.getMonth() + direction);
            }
            renderCalendar();
        }

        function handleDateFilter() {
            const df = document.getElementById('dateFilter').value;
            const customRange = document.getElementById('customDateRange');
            
            if (df === 'custom') {
                customRange.style.display = 'flex';
                // Встановлюємо значення за замовчуванням
                const today = new Date().toISOString().split('T')[0];
                const weekLater = new Date();
                weekLater.setDate(weekLater.getDate() + 7);
                document.getElementById('dateFrom').value = today;
                document.getElementById('dateTo').value = weekLater.toISOString().split('T')[0];
            } else {
                customRange.style.display = 'none';
            }
            renderTasks();
        }
        
        function renderTasks() {
            const c = document.getElementById('tasksContainer');
            const sf = document.getElementById('statusFilter')?.value;
            const ff = document.getElementById('functionFilter')?.value;
            const af = document.getElementById('assigneeFilter')?.value;
            const df = document.getElementById('dateFilter')?.value;
            const tf = document.getElementById('taskTypeFilter')?.value;
            
            const today = new Date().toISOString().split('T')[0];
            
            let f = tasks.filter(task => {
                if (sf && task.status !== sf) return false;
                if (ff && task.function !== ff) return false;
                if (af && task.assigneeId !== af) return false;
                if (tf === 'my' && task.assigneeId !== currentUser.uid) return false;
                if (tf === 'created' && task.creatorId !== currentUser.uid) return false;
                
                const taskDate = task.deadlineDate || (task.deadline ? task.deadline.split('T')[0] : '');
                
                if (df === 'today' && taskDate !== today) return false;
                if (df === 'overdue') {
                    if (taskDate >= today || task.status === 'done') return false;
                }
                if (df === 'week') {
                    const weekLater = new Date();
                    weekLater.setDate(weekLater.getDate() + 7);
                    if (taskDate > weekLater.toISOString().split('T')[0] || taskDate < today) return false;
                }
                if (df === 'month') {
                    const monthLater = new Date();
                    monthLater.setMonth(monthLater.getMonth() + 1);
                    if (taskDate > monthLater.toISOString().split('T')[0] || taskDate < today) return false;
                }
                if (df === 'custom') {
                    const dateFrom = document.getElementById('dateFrom')?.value;
                    const dateTo = document.getElementById('dateTo')?.value;
                    if (dateFrom && taskDate < dateFrom) return false;
                    if (dateTo && taskDate > dateTo) return false;
                }
                return true;
            });
            
            f.sort((a, b) => {
                if (a.pinned && !b.pinned) return -1;
                if (!a.pinned && b.pinned) return 1;
                const dateA = a.deadlineDate || (a.deadline ? a.deadline.split('T')[0] : '9999');
                const dateB = b.deadlineDate || (b.deadline ? b.deadline.split('T')[0] : '9999');
                return dateA.localeCompare(dateB);
            });
            
            // Рахуємо загальний час
            let totalMinutes = 0;
            f.filter(task => task.status !== 'done').forEach(task => {
                if (task.estimatedTime) totalMinutes += parseInt(task.estimatedTime);
            });
            const totalHours = Math.floor(totalMinutes / 60);
            const totalMins = totalMinutes % 60;
            const totalTimeStr = totalMinutes > 0 ? `⏱️ ${totalHours > 0 ? totalHours + ' год ' : ''}${totalMins > 0 ? totalMins + ' хв' : ''}` : '';
            
            document.getElementById('totalTimeInfo').innerHTML = totalTimeStr ? `<span class="total-time-badge">${totalTimeStr} (${f.filter(x=>x.status!=='done').length} ${t('tasks')})</span>` : '';
            
            if (f.length === 0) {
                c.innerHTML = `<div class="empty-table"><h3>${t('noTasksFound')}</h3><p>${t('changeFilters')}</p></div>`;
                return;
            }
            
            const st = { new: t('statusNew'), progress: t('statusProgress'), review: t('statusReview'), done: t('statusDone') };
            
            // Desktop table
            let html = `
                <table class="tasks-table">
                    <thead>
                        <tr>
                            <th>${t('task')}</th>
                            <th>${t('assignee')}</th>
                            <th>${t('createdBy')}</th>
                            <th>${t('deadline')}</th>
                            <th>${t('status')}</th>
                            <th>${t('type')}</th>
                            <th>${t('actions')}</th>
                        </tr>
                    </thead>
                    <tbody>`;
            
            f.forEach(task => {
                const taskDeadline = task.deadlineDate || (task.deadline ? task.deadline.split('T')[0] : '');
                const taskTime = task.deadlineTime || (task.deadline ? task.deadline.split('T')[1]?.slice(0,5) : '');
                const od = taskDeadline && taskDeadline < today && task.status !== 'done';
                const isToday = taskDeadline === today;
                const deadlineClass = od ? 'overdue' : (isToday ? 'today' : '');
                
                html += `
                    <tr>
                        <td class="task-title-cell">
                            <span class="task-title-text ${task.pinned ? 'pinned' : ''}">${task.pinned ? '<i data-lucide="pin" class="icon icon-sm" style="color:#e74c3c"></i> ' : ''}${task.title}</span>
                        </td>
                        <td>${task.assigneeName || '-'}</td>
                        <td>${task.creatorName || '-'}</td>
                        <td class="deadline-text ${deadlineClass}">${taskDeadline ? formatDateShort(taskDeadline) : '-'} ${taskTime || ''}</td>
                        <td><span class="status-badge status-${task.status}">${st[task.status] || task.status}</span></td>
                        <td>${task.function || '-'}</td>
                        <td>
                            <div class="action-btns">
                                <button class="action-btn" onclick="togglePin('${task.id}')" title="Pin"><i data-lucide="pin" class="icon icon-sm"></i></button>
                                <button class="action-btn" onclick="openTaskModal('${task.id}')" title="Edit"><i data-lucide="pencil" class="icon icon-sm"></i></button>
                                <button class="action-btn" onclick="deleteTask('${task.id}')" title="Delete"><i data-lucide="trash-2" class="icon icon-sm"></i></button>
                            </div>
                        </td>
                    </tr>`;
            });
            
            html += `</tbody></table>`;
            
            // Mobile cards with swipe support and date grouping
            html += `<div class="mobile-tasks-list" id="mobileTasksList">`;
            
            // Group tasks by date
            const groups = {
                overdue: [],
                today: [],
                tomorrow: [],
                thisWeek: [],
                later: [],
                noDueDate: []
            };
            
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            const tomorrowStr = tomorrow.toISOString().split('T')[0];
            
            const weekEnd = new Date();
            weekEnd.setDate(weekEnd.getDate() + 7);
            const weekEndStr = weekEnd.toISOString().split('T')[0];
            
            f.forEach(task => {
                const taskDeadline = task.deadlineDate || (task.deadline ? task.deadline.split('T')[0] : '');
                
                if (!taskDeadline) {
                    groups.noDueDate.push(task);
                } else if (taskDeadline < today && task.status !== 'done') {
                    groups.overdue.push(task);
                } else if (taskDeadline === today) {
                    groups.today.push(task);
                } else if (taskDeadline === tomorrowStr) {
                    groups.tomorrow.push(task);
                } else if (taskDeadline <= weekEndStr) {
                    groups.thisWeek.push(task);
                } else {
                    groups.later.push(task);
                }
            });
            
            const groupLabels = {
                overdue: { label: 'Прострочені', class: 'overdue' },
                today: { label: 'Сьогодні', class: 'today' },
                tomorrow: { label: 'Завтра', class: 'tomorrow' },
                thisWeek: { label: 'Цей тиждень', class: '' },
                later: { label: 'Пізніше', class: '' },
                noDueDate: { label: 'Без дати', class: '' }
            };
            
            Object.keys(groups).forEach(groupKey => {
                const group = groups[groupKey];
                if (group.length === 0) return;
                
                const { label, class: headerClass } = groupLabels[groupKey];
                
                html += `
                <div class="date-group-header ${headerClass}">
                    <span class="date-label">${label}</span>
                    <span class="task-count">${group.length}</span>
                </div>`;
                
                group.forEach(task => {
                    const taskDeadline = task.deadlineDate || (task.deadline ? task.deadline.split('T')[0] : '');
                    const taskTime = task.deadlineTime || (task.deadline ? task.deadline.split('T')[1]?.slice(0,5) : '');
                    const od = taskDeadline && taskDeadline < today && task.status !== 'done';
                    const isToday = taskDeadline === today;
                    const deadlineClass = od ? 'deadline-overdue' : (isToday ? 'deadline-today' : '');
                    const cardClass = od ? 'overdue' : (task.pinned ? 'pinned' : `status-${task.status}`);
                    const canSwipeComplete = task.status !== 'done';
                    
                    html += `
                    <div class="mobile-task-card ${cardClass}" data-task-id="${task.id}" data-can-complete="${canSwipeComplete}">
                        <!-- Swipe backgrounds -->
                        <div class="swipe-action-bg left"><i data-lucide="check" class="icon"></i> Готово</div>
                        <div class="swipe-action-bg right"><i data-lucide="trash-2" class="icon"></i> Видалити</div>
                        
                        <!-- Card content -->
                        <div class="mobile-task-content">
                            <div class="mobile-task-header">
                                <div class="mobile-task-title">
                                    ${task.pinned ? '<i data-lucide="pin" class="icon icon-sm" style="color:#e74c3c"></i> ' : ''}${task.title}
                                </div>
                                <span class="status-badge status-${task.status}">${st[task.status] || task.status}</span>
                            </div>
                            
                            <div class="mobile-task-meta">
                                ${task.assigneeName ? `<div class="mobile-task-meta-item"><i data-lucide="user" class="icon icon-sm"></i> ${task.assigneeName}</div>` : ''}
                                ${taskTime ? `<div class="mobile-task-meta-item"><i data-lucide="clock" class="icon icon-sm"></i> ${taskTime}</div>` : ''}
                                ${task.function ? `<div class="mobile-task-meta-item"><i data-lucide="tag" class="icon icon-sm"></i> ${task.function}</div>` : ''}
                            </div>
                            
                            <div class="mobile-task-actions">
                                ${task.status !== 'done' ? `
                                    <button class="mobile-action-btn complete" onclick="quickCompleteTask('${task.id}')">
                                        <i data-lucide="check" class="icon icon-sm"></i> Готово
                                    </button>
                                ` : `
                                    <button class="mobile-action-btn edit" onclick="reopenTask('${task.id}')">
                                        <i data-lucide="rotate-ccw" class="icon icon-sm"></i> Відновити
                                    </button>
                                `}
                                <button class="mobile-action-btn edit" onclick="openTaskModal('${task.id}')">
                                    <i data-lucide="pencil" class="icon icon-sm"></i>
                                </button>
                                <button class="mobile-action-btn delete" onclick="deleteTask('${task.id}')">
                                    <i data-lucide="trash-2" class="icon icon-sm"></i>
                                </button>
                            </div>
                        </div>
                    </div>`;
                });
            });
            
            html += `</div>`;
            c.innerHTML = html;
            refreshIcons();
            initSwipeHandlers();
        }
        
        function clearTaskFilters() {
            document.getElementById('taskTypeFilter').value = '';
            document.getElementById('dateFilter').value = '';
            document.getElementById('statusFilter').value = '';
            document.getElementById('functionFilter').value = '';
            document.getElementById('assigneeFilter').value = '';
            document.getElementById('customDateRange').style.display = 'none';
            document.getElementById('dateFrom').value = '';
            document.getElementById('dateTo').value = '';
            renderTasks();
        }
        
        function exportTasksCSV() {
            let csv = 'Назва,Виконавець,Створив,Дедлайн,Статус,Функція\n';
            tasks.forEach(task => {
                const deadline = task.deadlineDate || (task.deadline ? task.deadline.split('T')[0] : '');
                csv += `"${task.title}","${task.assigneeName || ''}","${task.creatorName || ''}","${deadline}","${task.status}","${task.function || ''}"\n`;
            });
            
            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'tasks_' + new Date().toISOString().split('T')[0] + '.csv';
            link.click();
        }
        
        function formatDateShort(dateStr) {
            if (!dateStr) return '-';
            const d = new Date(dateStr);
            return d.toLocaleDateString(currentLang === 'ua' ? 'uk-UA' : 'ru-RU', { day: '2-digit', month: '2-digit' });
        }

        // =====================
        // FUNCTIONS
        // =====================
        function openFunctionModal(id = null) {
            document.getElementById('functionModal').style.display = 'block';
            updateFunctionAssignees();
            
            if (id) {
                editingId = id;
                const f = functions.find(x => x.id === id);
                if (f) {
                    document.getElementById('functionModalTitle').textContent = t('editTask');
                    document.getElementById('functionName').value = f.name || '';
                    document.getElementById('functionHead').value = f.headId || '';
                    document.getElementById('functionDescription').value = f.description || '';
                    setTimeout(() => {
                        document.querySelectorAll('#functionAssignees input').forEach(cb => {
                            cb.checked = f.assigneeIds?.includes(cb.value);
                        });
                    }, 50);
                }
            } else {
                editingId = null;
                document.getElementById('functionModalTitle').textContent = t('newFunction');
                document.getElementById('functionForm').reset();
            }
        }

        function updateFunctionAssignees() {
            const c = document.getElementById('functionAssignees');
            const h = document.getElementById('functionHead');
            c.innerHTML = users.map(u => `<label class="assignee-checkbox"><input type="checkbox" value="${u.id}">${u.name || u.email}</label>`).join('');
            h.innerHTML = `<option value="">${t('select')}</option>` + users.map(u => `<option value="${u.id}">${u.name || u.email}</option>`).join('');
        }

        async function saveFunction(e) {
            e.preventDefault();
            
            const headId = document.getElementById('functionHead').value;
            const head = users.find(u => u.id === headId);
            const assigneeIds = Array.from(document.querySelectorAll('#functionAssignees input:checked')).map(cb => cb.value);
            if (!assigneeIds.includes(headId)) assigneeIds.push(headId);
            
            const data = {
                name: document.getElementById('functionName').value.trim(),
                headId: headId,
                headName: head?.name || head?.email || '',
                description: document.getElementById('functionDescription').value.trim(),
                assigneeIds: assigneeIds,
                assigneeNames: assigneeIds.map(id => users.find(u => u.id === id)?.name || users.find(u => u.id === id)?.email || '').filter(Boolean)
            };
            
            try {
                if (editingId) {
                    await db.collection('companies').doc(currentCompany).collection('functions').doc(editingId).update(data);
                } else {
                    data.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                    await db.collection('companies').doc(currentCompany).collection('functions').add(data);
                }
                closeModal('functionModal');
                loadAllData();
            } catch (e) {
                alert(t('error') + ': ' + e.message);
            }
        }

        async function deleteFunction(id) {
            if (!confirm(t('deleteConfirm'))) return;
            await db.collection('companies').doc(currentCompany).collection('functions').doc(id).delete();
            loadAllData();
        }

        function renderFunctions() {
            const c = document.getElementById('functionsContainer');
            if (functions.length === 0) {
                c.innerHTML = `<div class="empty-state" style="grid-column:1/-1;"><h3>${t('noFunctions')}</h3><p>${t('createFirstFunction')}</p></div>`;
                return;
            }
            c.innerHTML = functions.map(f => `
                <div class="function-card">
                    <div class="function-header">
                        <div class="function-title"><i data-lucide="settings" class="icon icon-sm"></i> ${f.name}</div>
                    </div>
                    ${f.description ? `<div class="function-description">${f.description}</div>` : ''}
                    <div class="function-assignees">
                        ${f.headName ? `<span class="assignee-badge head"><i data-lucide="crown" class="icon icon-sm"></i> ${f.headName}</span>` : ''}
                        ${f.assigneeNames?.filter(n => n !== f.headName).map(n => `<span class="assignee-badge">${n}</span>`).join('') || ''}
                    </div>
                    <div class="function-stats">
                        <span><i data-lucide="file-text" class="icon icon-sm"></i> ${tasks.filter(task => task.function === f.name).length} ${t('tasks')}</span>
                        <div>
                            <button class="btn btn-small" onclick="openFunctionModal('${f.id}')"><i data-lucide="pencil" class="icon icon-sm"></i></button>
                            <button class="btn btn-small btn-danger" onclick="deleteFunction('${f.id}')"><i data-lucide="trash-2" class="icon icon-sm"></i></button>
                        </div>
                    </div>
                </div>
            `).join('');
            refreshIcons();
        }

        // =====================
        // REGULAR TASKS
        // =====================
        function updatePeriodOptions() {
            const period = document.getElementById('regularTaskPeriod').value;
            const dayOfWeekGroup = document.getElementById('dayOfWeekGroup');
            const dayOfMonthGroup = document.getElementById('dayOfMonthGroup');
            
            if (period === 'weekly') {
                dayOfWeekGroup.style.display = 'block';
                dayOfMonthGroup.style.display = 'none';
            } else {
                dayOfWeekGroup.style.display = 'none';
                dayOfMonthGroup.style.display = 'block';
            }
        }
        
        function openRegularTaskModal(id = null) {
            document.getElementById('regularTaskModal').style.display = 'block';
            updateRegularTaskFunctions();
            updatePeriodOptions();
            editingId = id;
            
            if (id) {
                const rt = regularTasks.find(r => r.id === id);
                if (rt) {
                    document.getElementById('regularTaskTitle').value = rt.title;
                    document.getElementById('regularTaskFunction').value = rt.function;
                    document.getElementById('regularTaskPeriod').value = rt.period || 'weekly';
                    updatePeriodOptions();
                    document.getElementById('regularTaskDayOfWeek').value = rt.dayOfWeek || '1';
                    document.getElementById('regularTaskDayOfMonth').value = rt.dayOfMonth || '1';
                    document.getElementById('regularTaskTime').value = rt.time || '10:00';
                    document.getElementById('regularTaskExpectedResult').value = rt.expectedResult || '';
                    document.getElementById('regularTaskReportFormat').value = rt.reportFormat || '';
                    document.getElementById('regularTaskInstruction').value = rt.instruction || '';
                }
            } else {
                document.getElementById('regularTaskForm').reset();
                document.getElementById('regularTaskTime').value = '10:00';
                document.getElementById('regularTaskPeriod').value = 'weekly';
                updatePeriodOptions();
            }
        }

        function updateRegularTaskFunctions() {
            const s = document.getElementById('regularTaskFunction');
            s.innerHTML = `<option value="">${t('select')}</option>` + functions.map(f => `<option value="${f.name}">${f.name} (${f.assigneeIds?.length || 0} ${t('people')})</option>`).join('');
            
            // Оновлюємо фільтри
            const ff = document.getElementById('regularFunctionFilter');
            const af = document.getElementById('regularAssigneeFilter');
            if (ff) ff.innerHTML = `<option value="">${t('allFunctions')}</option>` + functions.map(f => `<option value="${f.name}">${f.name}</option>`).join('');
            if (af) af.innerHTML = `<option value="">${t('allAssignees')}</option>` + users.map(u => `<option value="${u.id}">${u.name || u.email}</option>`).join('');
        }

        async function saveRegularTask(e) {
            e.preventDefault();
            
            const funcName = document.getElementById('regularTaskFunction').value;
            const func = functions.find(f => f.name === funcName);
            
            if (!func || !func.assigneeIds?.length) {
                alert(currentLang === 'ua' ? 'В обраній функції немає виконавців' : 'В выбранной функции нет исполнителей');
                return;
            }
            
            const period = document.getElementById('regularTaskPeriod').value;
            
            const data = {
                title: document.getElementById('regularTaskTitle').value.trim(),
                function: funcName,
                period: period,
                dayOfWeek: period === 'weekly' ? document.getElementById('regularTaskDayOfWeek').value : null,
                dayOfMonth: period !== 'weekly' ? document.getElementById('regularTaskDayOfMonth').value : null,
                time: document.getElementById('regularTaskTime').value,
                expectedResult: document.getElementById('regularTaskExpectedResult').value.trim(),
                reportFormat: document.getElementById('regularTaskReportFormat').value.trim(),
                instruction: document.getElementById('regularTaskInstruction').value.trim()
                // assigneeIds більше не зберігаємо - беремо з функції динамічно
            };
            
            try {
                if (editingId) {
                    await db.collection('companies').doc(currentCompany).collection('regularTasks').doc(editingId).update(data);
                } else {
                    data.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                    await db.collection('companies').doc(currentCompany).collection('regularTasks').add(data);
                }
                closeModal('regularTaskModal');
                loadAllData();
            } catch (e) {
                alert(t('error') + ': ' + e.message);
            }
        }

        async function generateFromRegular(id) {
            const rt = regularTasks.find(r => r.id === id);
            if (!rt) return;
            
            // Беремо виконавців з функції
            const func = functions.find(f => f.name === rt.function);
            if (!func || !func.assigneeIds?.length) {
                alert(currentLang === 'ua' ? 'В функції немає виконавців' : 'В функции нет исполнителей');
                return;
            }
            
            const assigneeIds = func.assigneeIds;
            
            const deadline = new Date();
            deadline.setDate(deadline.getDate() + 1);
            const deadlineDate = deadline.toISOString().split('T')[0];
            
            // Визначаємо початок поточного періоду
            const now = new Date();
            let periodStart;
            if (rt.period === 'weekly') {
                // Понеділок поточного тижня
                const day = now.getDay();
                const diff = now.getDate() - day + (day === 0 ? -6 : 1);
                periodStart = new Date(now.setDate(diff)).toISOString().split('T')[0];
            } else if (rt.period === 'monthly') {
                // 1-е число поточного місяця
                periodStart = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
            } else {
                // Квартал - 1-е число першого місяця кварталу
                const quarter = Math.floor(now.getMonth() / 3);
                periodStart = new Date(now.getFullYear(), quarter * 3, 1).toISOString().split('T')[0];
            }
            
            const batch = db.batch();
            assigneeIds.forEach(assigneeId => {
                const ref = db.collection('companies').doc(currentCompany).collection('tasks').doc();
                batch.set(ref, {
                    title: rt.title,
                    function: rt.function,
                    assigneeId: assigneeId,
                    assigneeName: users.find(u => u.id === assigneeId)?.name || '',
                    deadlineDate: deadlineDate,
                    deadlineTime: rt.time || '18:00',
                    deadline: deadlineDate + 'T' + (rt.time || '18:00'),
                    expectedResult: rt.expectedResult || '',
                    reportFormat: rt.reportFormat || '',
                    description: rt.instruction || '',
                    status: 'new',
                    priority: 'medium',
                    pinned: false,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    createdDate: new Date().toISOString().split('T')[0],
                    creatorName: currentLang === 'ua' ? 'Система' : 'Система',
                    // Зв'язок з регулярним завданням
                    regularTaskId: id,
                    periodStart: periodStart
                });
            });
            
            await batch.commit();
            alert(`${currentLang === 'ua' ? 'Створено' : 'Создано'} ${assigneeIds.length} ${currentLang === 'ua' ? 'завдань' : 'задач'}`);
            loadAllData();
        }

        async function deleteRegularTask(id) {
            if (!confirm(t('deleteConfirm'))) return;
            await db.collection('companies').doc(currentCompany).collection('regularTasks').doc(id).delete();
            loadAllData();
        }
        
        // Швидке виконання регулярного завдання
        async function completeRegularTask(id) {
            const rt = regularTasks.find(r => r.id === id);
            if (!rt) return;
            
            const func = functions.find(f => f.name === rt.function);
            if (!func || !func.assigneeIds?.length) {
                alert(currentLang === 'ua' ? 'В функції немає виконавців' : 'В функции нет исполнителей');
                return;
            }
            
            // Визначаємо період
            const now = new Date();
            let periodStart;
            if (rt.period === 'weekly') {
                const day = now.getDay();
                const diff = now.getDate() - day + (day === 0 ? -6 : 1);
                periodStart = new Date(now.getFullYear(), now.getMonth(), diff).toISOString().split('T')[0];
            } else if (rt.period === 'monthly') {
                periodStart = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
            } else {
                const quarter = Math.floor(now.getMonth() / 3);
                periodStart = new Date(now.getFullYear(), quarter * 3, 1).toISOString().split('T')[0];
            }
            
            // Перевіряємо чи є вже завдання за цей період
            const existingTasks = tasks.filter(t => 
                t.regularTaskId === id && 
                t.periodStart === periodStart &&
                t.assigneeId === currentUser.uid
            );
            
            if (existingTasks.length > 0) {
                // Оновлюємо статус існуючого завдання
                const taskToUpdate = existingTasks[0];
                await db.collection('companies').doc(currentCompany).collection('tasks').doc(taskToUpdate.id).update({
                    status: 'done',
                    completedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            } else {
                // Створюємо нове і одразу виконане
                const today = new Date().toISOString().split('T')[0];
                await db.collection('companies').doc(currentCompany).collection('tasks').add({
                    title: rt.title,
                    function: rt.function,
                    assigneeId: currentUser.uid,
                    assigneeName: currentUserData?.name || currentUser.email,
                    deadlineDate: today,
                    deadlineTime: rt.time || '18:00',
                    deadline: today + 'T' + (rt.time || '18:00'),
                    expectedResult: rt.expectedResult || '',
                    reportFormat: rt.reportFormat || '',
                    description: rt.instruction || '',
                    status: 'done',
                    priority: 'medium',
                    pinned: false,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    createdDate: today,
                    creatorName: currentLang === 'ua' ? 'Система' : 'Система',
                    regularTaskId: id,
                    periodStart: periodStart,
                    completedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            }
            
            loadAllData();
        }

        function filterRegularToday() {
            const today = new Date().getDay().toString();
            document.getElementById('regularDayFilter').value = today;
            document.getElementById('regularAssigneeFilter').value = currentUser.uid; // Мої завдання
            renderRegularTasks();
        }
        
        // Отримати статус регулярного завдання за поточний період
        function getRegularTaskStatus(rt) {
            const now = new Date();
            let periodStart;
            
            if (rt.period === 'weekly') {
                const day = now.getDay();
                const diff = now.getDate() - day + (day === 0 ? -6 : 1);
                periodStart = new Date(now.getFullYear(), now.getMonth(), diff).toISOString().split('T')[0];
            } else if (rt.period === 'monthly') {
                periodStart = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
            } else {
                const quarter = Math.floor(now.getMonth() / 3);
                periodStart = new Date(now.getFullYear(), quarter * 3, 1).toISOString().split('T')[0];
            }
            
            // Знаходимо завдання створені з цього регулярного за поточний період
            const relatedTasks = tasks.filter(t => 
                t.regularTaskId === rt.id && 
                t.periodStart === periodStart
            );
            
            if (relatedTasks.length === 0) {
                return { status: 'notCreated', text: currentLang === 'ua' ? 'Не створено' : 'Не создано', color: '#9e9e9e', lucideIcon: 'circle' };
            }
            
            const allDone = relatedTasks.every(t => t.status === 'done');
            const anyInProgress = relatedTasks.some(t => t.status !== 'done');
            
            if (allDone) {
                const lastDone = relatedTasks.find(t => t.status === 'done');
                const doneDate = lastDone?.createdDate || '';
                return { status: 'done', text: `${currentLang === 'ua' ? 'Виконано' : 'Выполнено'} ${formatDateShort(doneDate)}`, color: '#4caf50', lucideIcon: 'check-circle' };
            } else {
                return { status: 'inProgress', text: currentLang === 'ua' ? 'В роботі' : 'В работе', color: '#ff9800', lucideIcon: 'clock' };
            }
        }
        
        function formatDateShort(dateStr) {
            if (!dateStr) return '';
            const d = new Date(dateStr);
            return `${d.getDate().toString().padStart(2, '0')}.${(d.getMonth() + 1).toString().padStart(2, '0')}`;
        }
        
        function renderRegularTasks() {
            const c = document.getElementById('regularTasksContainer');
            const ff = document.getElementById('regularFunctionFilter')?.value;
            const af = document.getElementById('regularAssigneeFilter')?.value;
            const dayFilter = document.getElementById('regularDayFilter')?.value;
            
            // Оновлюємо селекти
            const assigneeSelect = document.getElementById('regularAssigneeFilter');
            const functionSelect = document.getElementById('regularFunctionFilter');
            if (assigneeSelect && assigneeSelect.options.length <= 1) {
                assigneeSelect.innerHTML = `<option value="">${t('allAssignees')}</option>` + users.map(u => `<option value="${u.id}">${u.name || u.email}</option>`).join('');
            }
            if (functionSelect && functionSelect.options.length <= 1) {
                functionSelect.innerHTML = `<option value="">${t('allFunctions')}</option>` + functions.map(f => `<option value="${f.name}">${f.name}</option>`).join('');
            }
            
            // Визначаємо поточний день місяця для фільтрації місячних/квартальних
            const todayDate = new Date().getDate();
            const isLastDayOfMonth = new Date(new Date().getFullYear(), new Date().getMonth() + 1, 0).getDate() === todayDate;
            
            let filtered = regularTasks.filter(rt => {
                if (ff && rt.function !== ff) return false;
                
                // Фільтр по виконавцю - перевіряємо чи виконавець є в функції
                if (af) {
                    const func = functions.find(f => f.name === rt.function);
                    if (!func?.assigneeIds?.includes(af)) return false;
                }
                
                // Фільтр по дню
                if (dayFilter) {
                    if (rt.period === 'weekly') {
                        if (rt.dayOfWeek !== dayFilter) return false;
                    } else {
                        // Для місячних/квартальних перевіряємо день місяця
                        if (rt.dayOfMonth === 'last') {
                            if (!isLastDayOfMonth) return false;
                        } else {
                            if (parseInt(rt.dayOfMonth) !== todayDate) return false;
                        }
                    }
                }
                return true;
            });
            
            const pt = { weekly: t('weekly'), monthly: t('monthly'), quarterly: t('quarterly') };
            const days = {
                '0': currentLang === 'ua' ? 'Нд' : 'Вс',
                '1': currentLang === 'ua' ? 'Пн' : 'Пн',
                '2': currentLang === 'ua' ? 'Вт' : 'Вт',
                '3': currentLang === 'ua' ? 'Ср' : 'Ср',
                '4': currentLang === 'ua' ? 'Чт' : 'Чт',
                '5': currentLang === 'ua' ? 'Пт' : 'Пт',
                '6': currentLang === 'ua' ? 'Сб' : 'Сб'
            };
            
            // Показуємо поточний день у кнопці
            const todayDayName = days[new Date().getDay().toString()];
            const todayBtn = document.getElementById('regularTodayBtn');
            if (todayBtn) {
                todayBtn.innerHTML = `<i data-lucide="calendar-check" class="icon"></i> ${t('todaysTasks')} (${todayDayName})`;
                refreshIcons();
            }
            
            if (filtered.length === 0) {
                const noTasksMsg = dayFilter ? t('noRegularForDay') : t('noRegular');
                c.innerHTML = `<div class="empty-table"><h3>${noTasksMsg}</h3><p>${t('createRegular')}</p></div>`;
                return;
            }
            
            let html = `
                <table class="tasks-table">
                    <thead>
                        <tr>
                            <th>${t('title')}</th>
                            <th>${t('function')}</th>
                            <th>${t('schedule')}</th>
                            <th>${t('statusPeriod')}</th>
                            <th>${t('assignees')}</th>
                            <th>${t('actions')}</th>
                        </tr>
                    </thead>
                    <tbody>`;
            
            filtered.forEach(rt => {
                const scheduleText = rt.period === 'weekly' 
                    ? `${days[rt.dayOfWeek] || 'Пн'}, ${rt.time || '10:00'}`
                    : `${rt.dayOfMonth || '1'}-го, ${rt.time || '10:00'}`;
                
                // Беремо виконавців з функції динамічно
                const func = functions.find(f => f.name === rt.function);
                const assigneeNames = func?.assigneeIds?.map(id => {
                    const u = users.find(x => x.id === id);
                    return u?.name || u?.email || '';
                }).filter(Boolean) || [];
                
                // Статус за поточний період
                const statusInfo = getRegularTaskStatus(rt);
                
                html += `
                    <tr>
                        <td>
                            <div style="font-weight:500;">${rt.title}</div>
                            ${rt.expectedResult ? `<div style="font-size:0.75rem;color:#7f8c8d;margin-top:2px;"><i data-lucide="target" class="icon icon-sm"></i> ${rt.expectedResult.substring(0, 50)}${rt.expectedResult.length > 50 ? '...' : ''}</div>` : ''}
                        </td>
                        <td>${rt.function || '-'}</td>
                        <td>
                            <span class="status-badge" style="background:#f3e5f5;color:#7b1fa2;">${pt[rt.period] || rt.period}</span>
                            <div style="font-size:0.8rem;margin-top:4px;">${scheduleText}</div>
                        </td>
                        <td>
                            <span class="status-badge" style="background:${statusInfo.color}20;color:${statusInfo.color};font-weight:500;">
                                <i data-lucide="${statusInfo.lucideIcon}" class="icon icon-sm" style="color:${statusInfo.color}"></i> ${statusInfo.text}
                            </span>
                        </td>
                        <td>
                            <div style="display:flex;flex-wrap:wrap;gap:2px;">
                                ${assigneeNames.slice(0, 2).map(n => `<span class="assignee-badge" style="font-size:0.7rem;">${n}</span>`).join('') || '-'}
                                ${assigneeNames.length > 2 ? `<span class="assignee-badge" style="font-size:0.7rem;">+${assigneeNames.length - 2}</span>` : ''}
                            </div>
                        </td>
                        <td>
                            <div class="action-btns">
                                ${statusInfo.status === 'notCreated' ? `
                                    <button class="action-btn" onclick="generateFromRegular('${rt.id}')" title="${t('create')}" style="background:#2196f3;color:white;"><i data-lucide="zap" class="icon icon-sm"></i></button>
                                    <button class="action-btn" onclick="completeRegularTask('${rt.id}')" title="${t('markDone')}" style="background:#4caf50;color:white;"><i data-lucide="check" class="icon icon-sm"></i></button>
                                ` : statusInfo.status === 'inProgress' ? `
                                    <button class="action-btn" onclick="completeRegularTask('${rt.id}')" title="${t('markDone')}" style="background:#4caf50;color:white;"><i data-lucide="check" class="icon icon-sm"></i></button>
                                ` : `
                                    <button class="action-btn" onclick="generateFromRegular('${rt.id}')" title="${t('createAgain')}" style="opacity:0.4;"><i data-lucide="zap" class="icon icon-sm"></i></button>
                                `}
                                ${rt.instruction ? `<button class="action-btn" onclick="showInstruction('${rt.id}')" title="${t('instruction')}"><i data-lucide="book-open" class="icon icon-sm"></i></button>` : ''}
                                <button class="action-btn" onclick="openRegularTaskModal('${rt.id}')" title="${t('edit')}"><i data-lucide="pencil" class="icon icon-sm"></i></button>
                                <button class="action-btn" onclick="deleteRegularTask('${rt.id}')" title="${t('delete')}"><i data-lucide="trash-2" class="icon icon-sm"></i></button>
                            </div>
                        </td>
                    </tr>`;
            });
            
            html += `</tbody></table>`;
            c.innerHTML = html;
            refreshIcons();
        }
        
        function showInstruction(id) {
            const rt = regularTasks.find(r => r.id === id);
            if (rt && rt.instruction) {
                alert(`${currentLang === 'ua' ? 'Інструкція' : 'Инструкция'}:\n\n${rt.instruction}`);
            }
        }
        
        // =====================
        // REGULAR CALENDAR VIEW
        // =====================
        
        let currentRegularView = 'week'; // week, list
        
        function setRegularView(view) {
            currentRegularView = view;
            
            // Update buttons
            document.querySelectorAll('#regularCalendarHeader .calendar-view-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.view === view);
            });
            
            // Show/hide containers
            const calendarContainer = document.getElementById('regularCalendarContainer');
            const listContainer = document.getElementById('regularListContainer');
            
            if (view === 'list') {
                calendarContainer.classList.remove('active');
                calendarContainer.style.display = 'none';
                listContainer.classList.add('active');
                listContainer.style.display = 'block';
                renderRegularTasks();
            } else {
                calendarContainer.classList.add('active');
                calendarContainer.style.display = 'block';
                listContainer.classList.remove('active');
                listContainer.style.display = 'none';
                renderRegularWeekView();
            }
            
            localStorage.setItem('regularView', view);
        }
        
        function renderRegularWeekView() {
            const headerEl = document.getElementById('regularWeekHeader');
            const bodyEl = document.getElementById('regularWeekBody');
            
            const today = new Date().getDay(); // 0 = Sunday
            const dayNamesFullUA = ['Неділя', 'Понеділок', 'Вівторок', 'Середа', 'Четвер', 'Пʼятниця', 'Субота'];
            
            // Build header
            let headerHTML = '';
            for (let i = 0; i < 7; i++) {
                const isToday = i === today;
                headerHTML += `
                    <div class="regular-week-day-header ${isToday ? 'today' : ''}">
                        <div class="day-name">${dayNamesFullUA[i]}</div>
                    </div>
                `;
            }
            headerEl.innerHTML = headerHTML;
            
            // Build body
            let bodyHTML = '';
            for (let i = 0; i < 7; i++) {
                const isToday = i === today;
                const dayTasks = regularTasks.filter(rt => {
                    if (rt.period === 'weekly') {
                        return rt.dayOfWeek === i.toString();
                    }
                    return false;
                });
                
                // Sort by time
                dayTasks.sort((a, b) => {
                    const timeA = a.time || '00:00';
                    const timeB = b.time || '00:00';
                    return timeA.localeCompare(timeB);
                });
                
                bodyHTML += `<div class="regular-week-day-column ${isToday ? 'today' : ''}" data-day="${i}">`;
                
                if (dayTasks.length === 0) {
                    bodyHTML += '<div class="regular-day-empty">Немає завдань</div>';
                } else {
                    dayTasks.forEach(rt => {
                        const func = functions.find(f => f.name === rt.function);
                        const assigneeNames = func?.assigneeIds?.map(id => {
                            const user = users.find(u => u.id === id);
                            return user?.name || user?.email?.split('@')[0] || '';
                        }).filter(Boolean) || [];
                        
                        // Get status
                        const statusInfo = getRegularTaskStatus(rt);
                        
                        bodyHTML += `
                            <div class="regular-task-card ${statusInfo.completedToday ? 'completed' : ''}" 
                                 onclick="openRegularTaskModal('${rt.id}')"
                                 style="border-left-color: ${statusInfo.color};">
                                <div class="task-time">
                                    <i data-lucide="clock" class="icon icon-sm"></i>
                                    ${rt.time || '--:--'}
                                    ${rt.estimatedTime ? ` • ${formatDuration(parseInt(rt.estimatedTime))}` : ''}
                                </div>
                                <div class="task-title">${rt.title}</div>
                                ${assigneeNames.length > 0 ? `
                                    <div class="task-assignee">
                                        <i data-lucide="user" class="icon icon-sm"></i>
                                        ${assigneeNames.slice(0, 2).join(', ')}${assigneeNames.length > 2 ? ` +${assigneeNames.length - 2}` : ''}
                                    </div>
                                ` : ''}
                                ${rt.function ? `<div class="task-function">${rt.function}</div>` : ''}
                                <button class="regular-task-complete-btn ${statusInfo.completedToday ? 'completed' : ''}" 
                                        onclick="event.stopPropagation();markRegularTaskComplete('${rt.id}')"
                                        title="${statusInfo.completedToday ? 'Виконано сьогодні' : 'Позначити виконаним'}">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>
                                </button>
                            </div>
                        `;
                    });
                }
                
                bodyHTML += '</div>';
            }
            
            bodyEl.innerHTML = bodyHTML;
            refreshIcons();
            
            // Also update mobile view
            updateRegularDayTabs();
            renderMobileRegularDay();
        }
        
        function getRegularTaskStatus(rt) {
            const today = new Date();
            const todayDay = today.getDay();
            const todayDateStr = today.toISOString().split('T')[0];
            
            // Check if task should run today
            let shouldRunToday = false;
            if (rt.period === 'weekly' && rt.dayOfWeek === todayDay.toString()) {
                shouldRunToday = true;
            } else if (rt.period === 'monthly') {
                const todayDate = today.getDate();
                if (rt.dayOfMonth === 'last') {
                    const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();
                    shouldRunToday = todayDate === lastDay;
                } else {
                    shouldRunToday = todayDate === parseInt(rt.dayOfMonth);
                }
            }
            
            // Check completion
            const lastCompleted = rt.lastCompleted?.toDate ? rt.lastCompleted.toDate() : null;
            const completedToday = lastCompleted && lastCompleted.toISOString().split('T')[0] === todayDateStr;
            
            // Check if task was generated today
            const generatedTasks = tasks.filter(t => 
                t.regularTaskId === rt.id && 
                t.createdAt?.toDate && 
                t.createdAt.toDate().toISOString().split('T')[0] === todayDateStr
            );
            
            if (completedToday) {
                return { status: 'completed', color: '#4caf50', text: 'Виконано', lucideIcon: 'check-circle', completedToday: true };
            } else if (generatedTasks.length > 0) {
                const allDone = generatedTasks.every(t => t.status === 'done');
                if (allDone) {
                    return { status: 'completed', color: '#4caf50', text: 'Виконано', lucideIcon: 'check-circle', completedToday: true };
                }
                return { status: 'inProgress', color: '#ff9800', text: 'В роботі', lucideIcon: 'clock', completedToday: false };
            } else if (shouldRunToday) {
                return { status: 'notCreated', color: '#2196f3', text: 'Очікує', lucideIcon: 'circle', completedToday: false };
            } else {
                return { status: 'inactive', color: '#9e9e9e', text: 'Не сьогодні', lucideIcon: 'minus-circle', completedToday: false };
            }
        }
        
        // Mark regular task as completed
        async function markRegularTaskComplete(taskId) {
            // Haptic feedback
            if (navigator.vibrate) navigator.vibrate(10);
            
            const task = regularTasks.find(t => t.id === taskId);
            if (!task) return;
            
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];
            
            // Check if already completed today
            const lastCompleted = task.lastCompleted?.toDate ? task.lastCompleted.toDate() : null;
            const completedToday = lastCompleted && lastCompleted.toISOString().split('T')[0] === todayStr;
            
            if (completedToday) {
                // Unmark as completed
                await db.collection('companies').doc(currentCompany).collection('regularTasks').doc(taskId).update({
                    lastCompleted: null
                });
            } else {
                // Mark as completed
                await db.collection('companies').doc(currentCompany).collection('regularTasks').doc(taskId).update({
                    lastCompleted: firebase.firestore.Timestamp.now()
                });
            }
            
            loadAllData();
        }
        
        // Mobile Regular Tasks - selected day
        let selectedRegularDay = new Date().getDay();
        
        function selectRegularDay(day) {
            selectedRegularDay = day;
            updateRegularDayTabs();
            renderMobileRegularDay();
        }
        
        function updateRegularDayTabs() {
            const tabs = document.querySelectorAll('.regular-day-tab');
            const today = new Date().getDay();
            
            tabs.forEach(tab => {
                const tabDay = parseInt(tab.dataset.day);
                tab.classList.remove('active', 'today', 'has-tasks');
                
                if (tabDay === selectedRegularDay) {
                    tab.classList.add('active');
                }
                if (tabDay === today) {
                    tab.classList.add('today');
                }
                
                // Check if day has tasks
                const hasTasks = regularTasks.some(rt => {
                    if (rt.period === 'weekly') {
                        return parseInt(rt.dayOfWeek) === tabDay;
                    }
                    return false;
                });
                if (hasTasks) {
                    tab.classList.add('has-tasks');
                }
            });
        }
        
        function renderMobileRegularDay() {
            const container = document.getElementById('mobileRegularDayContent');
            if (!container) return;
            
            const today = new Date();
            const todayDay = today.getDay();
            const todayDate = today.getDate();
            const todayDateStr = today.toISOString().split('T')[0];
            
            // Filter WEEKLY tasks for selected day
            const weeklyTasks = regularTasks.filter(rt => {
                if (rt.period === 'weekly') {
                    return parseInt(rt.dayOfWeek) === selectedRegularDay;
                }
                return false;
            }).sort((a, b) => (a.time || '').localeCompare(b.time || ''));
            
            // Get MONTHLY tasks (show in separate section)
            const monthlyTasks = regularTasks.filter(rt => rt.period === 'monthly')
                .sort((a, b) => {
                    const dayA = a.dayOfMonth === 'last' ? 32 : parseInt(a.dayOfMonth);
                    const dayB = b.dayOfMonth === 'last' ? 32 : parseInt(b.dayOfMonth);
                    return dayA - dayB;
                });
            
            // Get QUARTERLY tasks
            const quarterlyTasks = regularTasks.filter(rt => rt.period === 'quarterly')
                .sort((a, b) => (a.time || '').localeCompare(b.time || ''));
            
            let html = '';
            
            // Weekly tasks section
            if (weeklyTasks.length > 0) {
                weeklyTasks.forEach(rt => {
                    html += renderRegularTaskCard(rt);
                });
            } else if (monthlyTasks.length === 0 && quarterlyTasks.length === 0) {
                html += `
                    <div class="mobile-regular-empty">
                        <div class="mobile-regular-empty-icon"><svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#9ca3af" stroke-width="1.5"><path d="M9 5H7a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-2"/><rect x="9" y="3" width="6" height="4" rx="1"/><path d="M9 12h6m-6 4h6"/></svg></div>
                        <div class="mobile-regular-empty-text">Немає регулярних завдань</div>
                    </div>
                `;
            }
            
            // Monthly tasks section
            if (monthlyTasks.length > 0) {
                html += `<div class="mobile-regular-section-header">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><path d="M16 2v4M8 2v4M3 10h18"/></svg>
                    Щомісячні завдання
                </div>`;
                monthlyTasks.forEach(rt => {
                    const dayLabel = rt.dayOfMonth === 'last' ? 'Останній день' : `${rt.dayOfMonth}-го числа`;
                    html += renderRegularTaskCard(rt, dayLabel);
                });
            }
            
            // Quarterly tasks section
            if (quarterlyTasks.length > 0) {
                html += `<div class="mobile-regular-section-header">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3v18h18"/><path d="M18 17V9M13 17V5M8 17v-3"/></svg>
                    Щоквартальні завдання
                </div>`;
                quarterlyTasks.forEach(rt => {
                    html += renderRegularTaskCard(rt, 'Раз на квартал');
                });
            }
            
            container.innerHTML = html;
            refreshIcons();
        }
        
        function renderRegularTaskCard(rt, extraLabel = null) {
            const func = functions.find(f => f.name === rt.function);
            const assigneeNames = func?.assigneeIds?.map(id => {
                const user = users.find(u => u.id === id);
                return user?.name || user?.email?.split('@')[0] || '';
            }).filter(Boolean) || [];
            
            const statusInfo = getRegularTaskStatus(rt);
            
            return `
                <div class="regular-task-card ${statusInfo.completedToday ? 'completed' : ''}" 
                     onclick="openRegularTaskModal('${rt.id}')"
                     style="border-left-color: ${statusInfo.color};">
                    <div class="task-time">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>
                        ${rt.time || '--:--'}
                        ${rt.estimatedTime ? ` • ${formatDuration(parseInt(rt.estimatedTime))}` : ''}
                        ${extraLabel ? ` • <span style="color:#8b5cf6;font-weight:500;">${extraLabel}</span>` : ''}
                    </div>
                    <div class="task-title">${rt.title}</div>
                    ${assigneeNames.length > 0 ? `
                        <div class="task-assignee">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                            ${assigneeNames.slice(0, 2).join(', ')}${assigneeNames.length > 2 ? ` +${assigneeNames.length - 2}` : ''}
                        </div>
                    ` : ''}
                    ${rt.function ? `<div class="task-function">${rt.function}</div>` : ''}
                    <button class="regular-task-complete-btn ${statusInfo.completedToday ? 'completed' : ''}" 
                            onclick="event.stopPropagation();markRegularTaskComplete('${rt.id}')"
                            title="${statusInfo.completedToday ? 'Виконано сьогодні' : 'Позначити виконаним'}">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>
                    </button>
                </div>
            `;
        }
        
        function initRegularView() {
            const savedView = localStorage.getItem('regularView') || 'week';
            setRegularView(savedView);
            
            // Init mobile view
            selectedRegularDay = new Date().getDay();
            updateRegularDayTabs();
            renderMobileRegularDay();
        }

        // =====================
        // USERS & INVITES
        // =====================
        function openInviteModal() {
            document.getElementById('inviteModal').style.display = 'block';
            document.getElementById('inviteForm').reset();
            document.getElementById('inviteLink').style.display = 'none';
        }

        async function sendInvite(e) {
            e.preventDefault();
            const email = document.getElementById('inviteEmail').value.trim().toLowerCase();
            const role = document.getElementById('inviteRole').value;
            
            try {
                const inviteRef = await db.collection('invites').add({
                    email: email,
                    companyId: currentCompany,
                    role: role,
                    invitedBy: currentUser.uid,
                    accepted: false,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Унікальне посилання з ID інвайту
                const link = window.location.origin + window.location.pathname + '?invite=' + inviteRef.id;
                document.getElementById('inviteLinkText').value = link;
                document.getElementById('inviteLink').style.display = 'block';
                
                alert(currentLang === 'ua' 
                    ? `Запрошення створено!\n\nНадішліть посилання співробітнику.`
                    : `Приглашение создано!\n\nОтправьте ссылку сотруднику.`);
            } catch (e) {
                alert(t('error') + ': ' + e.message);
            }
        }

        function copyInviteLink() {
            const input = document.getElementById('inviteLinkText');
            input.select();
            document.execCommand('copy');
            alert(t('copied'));
        }

        async function deleteUser(id) {
            const u = users.find(x => x.id === id);
            if (u?.role === 'owner') { alert(currentLang === 'ua' ? 'Не можна видалити власника' : 'Нельзя удалить владельца'); return; }
            if (!confirm(t('deleteConfirm'))) return;
            await db.collection('companies').doc(currentCompany).collection('users').doc(id).delete();
            loadAllData();
        }

        function renderUsers() {
            const c = document.getElementById('usersContainer');
            if (users.length === 0) {
                c.innerHTML = `<div class="empty-state" style="grid-column:1/-1;"><h3>${t('noUsers')}</h3></div>`;
                return;
            }
            
            const canEdit = currentUserData?.role === 'owner' || currentUserData?.role === 'manager';
            
            c.innerHTML = users.map(u => {
                const userFunctions = functions.filter(f => f.assigneeIds?.includes(u.id));
                const isOwner = u.role === 'owner';
                
                return `
                <div class="user-card">
                    <div class="user-header">
                        <div class="user-name">${u.name || u.email}</div>
                        <span class="role-badge ${u.role}">${getRoleText(u.role)}</span>
                    </div>
                    <div class="user-details">
                        <div><i data-lucide="mail" class="icon icon-sm"></i> ${u.email}</div>
                        ${u.position ? `<div><i data-lucide="briefcase" class="icon icon-sm"></i> ${u.position}</div>` : ''}
                    </div>
                    ${userFunctions.length > 0 ? `
                        <div style="margin:0.5rem 0;display:flex;flex-wrap:wrap;gap:0.25rem;">
                            ${userFunctions.map(f => `<span class="badge" style="font-size:0.7rem;background:#e8f5e9;color:#2e7d32;">${f.name}</span>`).join('')}
                        </div>
                    ` : ''}
                    <div class="user-stats">
                        <span><i data-lucide="file-text" class="icon icon-sm"></i> ${tasks.filter(task => task.assigneeId === u.id).length} ${t('tasks')}</span>
                        <div style="display:flex;gap:0.25rem;">
                            ${canEdit && !isOwner ? `<button class="btn btn-small" onclick="openUserModal('${u.id}')" title="${t('edit')}"><i data-lucide="pencil" class="icon icon-sm"></i></button>` : ''}
                            ${canEdit && !isOwner ? `<button class="btn btn-small btn-danger" onclick="deleteUser('${u.id}')" title="${t('delete')}"><i data-lucide="trash-2" class="icon icon-sm"></i></button>` : ''}
                        </div>
                    </div>
                </div>
            `}).join('');
            refreshIcons();
        }
        
        let editingUserId = null;
        
        function openUserModal(userId = null) {
            editingUserId = userId;
            const modal = document.getElementById('userModal');
            
            // Заповнюємо список функцій
            const userFunctionsDiv = document.getElementById('userFunctions');
            userFunctionsDiv.innerHTML = functions.map(f => `
                <label class="assignee-checkbox">
                    <input type="checkbox" value="${f.id}" data-fname="${f.name}">
                    ${f.name}
                </label>
            `).join('') || `<p style="color:#7f8c8d;">${t('noFunctions')}</p>`;
            
            if (userId) {
                const user = users.find(u => u.id === userId);
                if (user) {
                    document.getElementById('userName').value = user.name || '';
                    document.getElementById('userEmail').value = user.email || '';
                    document.getElementById('userRole').value = user.role || 'employee';
                    document.getElementById('userPosition').value = user.position || '';
                    document.getElementById('userModalTitle').textContent = t('editEmployee');
                    
                    // Відмічаємо функції користувача
                    const userFunctions = functions.filter(f => f.assigneeIds?.includes(userId));
                    userFunctions.forEach(f => {
                        const checkbox = userFunctionsDiv.querySelector(`input[value="${f.id}"]`);
                        if (checkbox) checkbox.checked = true;
                    });
                }
            } else {
                document.getElementById('userForm').reset();
                document.getElementById('userModalTitle').textContent = t('addEmployee');
            }
            
            modal.style.display = 'block';
        }
        
        async function saveUser(e) {
            e.preventDefault();
            
            if (!editingUserId) return;
            
            const name = document.getElementById('userName').value.trim();
            const role = document.getElementById('userRole').value;
            const position = document.getElementById('userPosition').value.trim();
            
            try {
                // Оновлюємо дані користувача
                await db.collection('companies').doc(currentCompany).collection('users').doc(editingUserId).update({
                    name: name,
                    role: role,
                    position: position
                });
                
                // Оновлюємо функції
                const selectedFunctions = Array.from(document.querySelectorAll('#userFunctions input:checked')).map(cb => cb.value);
                
                // Для кожної функції перевіряємо чи потрібно додати/видалити користувача
                for (const func of functions) {
                    const funcRef = db.collection('companies').doc(currentCompany).collection('functions').doc(func.id);
                    const isSelected = selectedFunctions.includes(func.id);
                    const isCurrentlyAssigned = func.assigneeIds?.includes(editingUserId);
                    
                    if (isSelected && !isCurrentlyAssigned) {
                        await funcRef.update({
                            assigneeIds: firebase.firestore.FieldValue.arrayUnion(editingUserId)
                        });
                    } else if (!isSelected && isCurrentlyAssigned) {
                        await funcRef.update({
                            assigneeIds: firebase.firestore.FieldValue.arrayRemove(editingUserId)
                        });
                    }
                }
                
                closeModal('userModal');
                loadAllData();
            } catch (e) {
                alert(t('error') + ': ' + e.message);
            }
        }

        // =====================
        // CONTROL DASHBOARD
        // =====================
        function renderControl() {
            const af = document.getElementById('controlAssigneeFilter')?.value;
            const ff = document.getElementById('controlFunctionFilter')?.value;
            const pf = document.getElementById('controlPeriodFilter')?.value;
            
            // Оновлюємо селекти
            const assigneeSelect = document.getElementById('controlAssigneeFilter');
            const functionSelect = document.getElementById('controlFunctionFilter');
            if (assigneeSelect && assigneeSelect.options.length <= 1) {
                assigneeSelect.innerHTML = `<option value="">${t('allAssignees')}</option>` + users.map(u => `<option value="${u.id}">${u.name || u.email}</option>`).join('');
            }
            if (functionSelect && functionSelect.options.length <= 1) {
                functionSelect.innerHTML = `<option value="">${t('allFunctions')}</option>` + functions.map(f => `<option value="${f.name}">${f.name}</option>`).join('');
            }
            
            const now = new Date();
            const today = now.toISOString().split('T')[0];
            const tm = new Date(now); tm.setDate(tm.getDate() + 1);
            const tomorrow = tm.toISOString().split('T')[0];
            
            // Фільтруємо завдання
            let filteredTasks = tasks.filter(task => {
                if (af && task.assigneeId !== af) return false;
                if (ff && task.function !== ff) return false;
                if (pf === 'today') {
                    const taskDate = task.deadlineDate || (task.deadline ? task.deadline.split('T')[0] : '');
                    if (taskDate !== today) return false;
                }
                if (pf === 'week') {
                    const taskDate = task.deadlineDate || (task.deadline ? task.deadline.split('T')[0] : '');
                    const weekLater = new Date();
                    weekLater.setDate(weekLater.getDate() + 7);
                    if (taskDate > weekLater.toISOString().split('T')[0] || taskDate < today) return false;
                }
                if (pf === 'month') {
                    const taskDate = task.deadlineDate || (task.deadline ? task.deadline.split('T')[0] : '');
                    const monthLater = new Date();
                    monthLater.setMonth(monthLater.getMonth() + 1);
                    if (taskDate > monthLater.toISOString().split('T')[0] || taskDate < today) return false;
                }
                return true;
            });
            
            const urgent = filteredTasks.filter(task => {
                const taskDate = task.deadlineDate || (task.deadline ? task.deadline.split('T')[0] : '');
                return taskDate && taskDate < today && task.status !== 'done';
            }).length;
            
            const warning = filteredTasks.filter(task => {
                const taskDate = task.deadlineDate || (task.deadline ? task.deadline.split('T')[0] : '');
                return (taskDate === today || taskDate === tomorrow) && task.status !== 'done';
            }).length;
            
            const active = filteredTasks.filter(task => task.status === 'progress').length;
            const completed = filteredTasks.filter(task => task.status === 'done').length;
            
            document.getElementById('urgentCount').textContent = urgent;
            document.getElementById('warningCount').textContent = warning;
            document.getElementById('activeCount').textContent = active;
            document.getElementById('completedCount').textContent = completed;
            
            renderControlContent();
        }
        
        function renderControlContent() {
            const viewType = document.getElementById('controlViewType')?.value || 'workload';
            const af = document.getElementById('controlAssigneeFilter')?.value;
            const ff = document.getElementById('controlFunctionFilter')?.value;
            
            let filteredTasks = tasks.filter(task => {
                if (af && task.assigneeId !== af) return false;
                if (ff && task.function !== ff) return false;
                return task.status !== 'done';
            });
            
            const content = document.getElementById('controlContent');
            
            if (viewType === 'workload') {
                const wl = {};
                filteredTasks.forEach(task => { 
                    wl[task.assigneeName || t('notAssigned')] = (wl[task.assigneeName || t('notAssigned')] || 0) + 1; 
                });
                
                content.innerHTML = `
                    <h3 style="margin-bottom:1rem;">${t('employeeWorkload')}</h3>
                    ${Object.entries(wl).sort((a,b) => b[1] - a[1]).map(([n, c]) => `
                        <div style="display:flex;justify-content:space-between;padding:0.6rem;background:#f8f9fa;border-radius:8px;margin-bottom:0.4rem;">
                            <span><i data-lucide="user" class="icon icon-sm"></i> ${n}</span>
                            <span style="font-weight:600;color:${c > 5 ? '#e74c3c' : '#27ae60'};">${c} ${t('tasks')}</span>
                        </div>
                    `).join('') || `<p style="color:#7f8c8d;">${t('noActiveTasks')}</p>`}
                `;
            } else {
                const byFunc = {};
                filteredTasks.forEach(task => { 
                    const fn = task.function || t('noFunction');
                    byFunc[fn] = (byFunc[fn] || 0) + 1; 
                });
                
                content.innerHTML = `
                    <h3 style="margin-bottom:1rem;">${t('byFunctions')}</h3>
                    ${Object.entries(byFunc).sort((a,b) => b[1] - a[1]).map(([n, c]) => `
                        <div style="display:flex;justify-content:space-between;padding:0.6rem;background:#f8f9fa;border-radius:8px;margin-bottom:0.4rem;">
                            <span><i data-lucide="settings" class="icon icon-sm"></i> ${n}</span>
                            <span style="font-weight:600;color:#3498db;">${c} ${t('tasks')}</span>
                        </div>
                    `).join('') || `<p style="color:#7f8c8d;">${t('noActiveTasks')}</p>`}
                `;
            }
        }
        
        function clearControlFilters() {
            document.getElementById('controlAssigneeFilter').value = '';
            document.getElementById('controlFunctionFilter').value = '';
            document.getElementById('controlPeriodFilter').value = '';
            renderControl();
        }
        
        function clearRegularFilters() {
            document.getElementById('regularAssigneeFilter').value = '';
            document.getElementById('regularFunctionFilter').value = '';
            document.getElementById('regularDayFilter').value = '';
            renderRegularTasks();
        }

        // =====================
        // ADMIN FUNCTIONS
        // =====================
        async function renderAdminPanel() {
            // Список компаній видалено - використовуй Firebase Console
        }

        async function adminCreateCompany(e) {
            e.preventDefault();
            if (!isSuperAdmin) return;
            
            const email = document.getElementById('adminOwnerEmail').value.trim().toLowerCase();
            const password = document.getElementById('adminOwnerPassword').value;
            const name = document.getElementById('adminOwnerName').value.trim();
            const companyName = document.getElementById('adminCompanyName').value.trim();
            
            const btn = document.getElementById('adminCreateBtn');
            btn.disabled = true;
            btn.textContent = currentLang === 'ua' ? 'Створюємо...' : 'Создаем...';
            
            try {
                const companyRef = db.collection('companies').doc();
                const companyId = companyRef.id;
                
                await companyRef.set({
                    name: companyName,
                    ownerEmail: email,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    createdBy: currentUser.uid
                });
                
                await db.collection('invites').add({
                    email: email,
                    companyId: companyId,
                    role: 'owner',
                    ownerName: name,
                    tempPassword: password,
                    invitedBy: currentUser.uid,
                    accepted: false,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                alert(currentLang === 'ua'
                    ? `Компанія "${companyName}" створена!\n\nEmail: ${email}\nПароль: ${password}\n\nНадішліть ці дані клієнту.`
                    : `Компания "${companyName}" создана!\n\nEmail: ${email}\nПароль: ${password}\n\nОтправьте эти данные клиенту.`);
                
                document.getElementById('adminCreateForm').reset();
            } catch (e) {
                alert(t('error') + ': ' + e.message);
            }
            
            btn.disabled = false;
            btn.textContent = t('createCompanyBtn');
        }

        // =====================
        // HELPERS
        // =====================
        function updateSelects() {
            const tf = document.getElementById('taskFunction');
            const ta = document.getElementById('taskAssignee');
            const ff = document.getElementById('functionFilter');
            const af = document.getElementById('assigneeFilter');
            const raf = document.getElementById('regularAssigneeFilter');
            const rff = document.getElementById('regularFunctionFilter');
            
            if (tf) tf.innerHTML = `<option value="">${t('noFunction')}</option>` + functions.map(f => `<option value="${f.name}">${f.name}</option>`).join('');
            if (ta) ta.innerHTML = `<option value="">${t('select')}</option>` + users.map(u => `<option value="${u.id}">${u.name || u.email}</option>`).join('');
            if (ff) ff.innerHTML = `<option value="">${t('allFunctions')}</option>` + functions.map(f => `<option value="${f.name}">${f.name}</option>`).join('');
            if (af) af.innerHTML = `<option value="">${t('allAssignees')}</option>` + users.map(u => `<option value="${u.id}">${u.name || u.email}</option>`).join('');
            if (raf) raf.innerHTML = `<option value="">${t('allAssignees')}</option>` + users.map(u => `<option value="${u.id}">${u.name || u.email}</option>`).join('');
            if (rff) rff.innerHTML = `<option value="">${t('allFunctions')}</option>` + functions.map(f => `<option value="${f.name}">${f.name}</option>`).join('');
        }

        function formatDate(s) {
            const d = new Date(s);
            return d.toLocaleDateString(currentLang === 'ua' ? 'uk-UA' : 'ru-RU', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(x => x.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(x => x.classList.remove('active'));
            document.getElementById(tabName + 'Tab').classList.add('active');
            document.querySelector(`[onclick="switchTab('${tabName}')"]`)?.classList.add('active');
            
            // Update bottom nav
            document.querySelectorAll('.bottom-nav-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.tab === tabName) btn.classList.add('active');
            });
            
            // Update FAB
            updateFab(tabName);
            
            switch (tabName) {
                case 'tasks': renderTasks(); break;
                case 'control': renderControl(); break;
                case 'regular': renderRegularTasks(); break;
                case 'functions': renderFunctions(); break;
                case 'users': renderUsers(); break;
                case 'analytics': renderAnalytics(); break;
                case 'admin': renderAdminPanel(); break;
            }
        }
        
        function updateFab(tabName) {
            const fab = document.getElementById('fabAdd');
            if (!fab) return;
            
            if (tabName === 'tasks') {
                fab.style.display = 'flex';
                fab.onclick = () => openTaskModal();
            } else if (tabName === 'regular') {
                fab.style.display = 'flex';
                fab.onclick = () => openRegularTaskModal();
            } else {
                fab.style.display = 'none';
            }
        }
        
        function renderAnalytics() {
            const totalTasks = tasks.length;
            const completedTasks = tasks.filter(t => t.status === 'done').length;
            const completionRate = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
            
            document.getElementById('analyticsTotalTasks').textContent = totalTasks;
            document.getElementById('analyticsCompletedTasks').textContent = completedTasks;
            document.getElementById('analyticsCompletionRate').textContent = completionRate + '%';
            
            // Середній час виконання
            let totalTime = 0;
            let countWithTime = 0;
            tasks.forEach(task => {
                if (task.estimatedTime) {
                    totalTime += parseInt(task.estimatedTime);
                    countWithTime++;
                }
            });
            const avgTime = countWithTime > 0 ? Math.round(totalTime / countWithTime) : 0;
            const avgHours = Math.floor(avgTime / 60);
            const avgMins = avgTime % 60;
            document.getElementById('analyticsAvgTime').textContent = avgTime > 0 ? `${avgHours > 0 ? avgHours + 'г ' : ''}${avgMins}хв` : '-';
            
            // Статистика по статусах
            const byStatus = {
                new: tasks.filter(task => task.status === 'new').length,
                progress: tasks.filter(task => task.status === 'progress').length,
                review: tasks.filter(task => task.status === 'review').length,
                done: tasks.filter(task => task.status === 'done').length
            };
            
            // Топ виконавців
            const byAssignee = {};
            tasks.filter(task => task.status === 'done').forEach(task => {
                const name = task.assigneeName || 'Не призначено';
                byAssignee[name] = (byAssignee[name] || 0) + 1;
            });
            const topAssignees = Object.entries(byAssignee).sort((a, b) => b[1] - a[1]).slice(0, 5);
            
            // Прострочені
            const today = new Date().toISOString().split('T')[0];
            const overdue = tasks.filter(task => {
                const taskDate = task.deadlineDate || (task.deadline ? task.deadline.split('T')[0] : '');
                return taskDate && taskDate < today && task.status !== 'done';
            }).length;
            
            document.getElementById('analyticsContent').innerHTML = `
                <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(280px, 1fr));gap:1rem;">
                    <div style="background:#f8f9fa;border-radius:12px;padding:1rem;">
                        <h4 style="margin-bottom:0.75rem;">${t('byStatus')}</h4>
                        <div style="display:flex;flex-direction:column;gap:0.4rem;">
                            <div style="display:flex;justify-content:space-between;align-items:center;"><span><i data-lucide="plus-square" class="icon icon-sm" style="color:#3498db"></i> ${t('statusNew')}</span><strong>${byStatus.new}</strong></div>
                            <div style="display:flex;justify-content:space-between;align-items:center;"><span><i data-lucide="loader" class="icon icon-sm" style="color:#f39c12"></i> ${t('statusProgress')}</span><strong>${byStatus.progress}</strong></div>
                            <div style="display:flex;justify-content:space-between;align-items:center;"><span><i data-lucide="eye" class="icon icon-sm" style="color:#9b59b6"></i> ${t('statusReview')}</span><strong>${byStatus.review}</strong></div>
                            <div style="display:flex;justify-content:space-between;align-items:center;"><span><i data-lucide="check-circle" class="icon icon-sm" style="color:#27ae60"></i> ${t('statusDone')}</span><strong style="color:#27ae60;">${byStatus.done}</strong></div>
                            <div style="display:flex;justify-content:space-between;align-items:center;border-top:1px solid #ddd;padding-top:0.4rem;margin-top:0.25rem;"><span><i data-lucide="alert-triangle" class="icon icon-sm" style="color:#e74c3c"></i> ${t('overdue')}</span><strong style="color:#e74c3c;">${overdue}</strong></div>
                        </div>
                    </div>
                    
                    <div style="background:#f8f9fa;border-radius:12px;padding:1rem;">
                        <h4 style="margin-bottom:0.75rem;"><i data-lucide="trophy" class="icon icon-sm" style="color:#f39c12"></i> ${t('topPerformers')}</h4>
                        ${topAssignees.length > 0 ? topAssignees.map(([name, count], i) => `
                            <div style="display:flex;justify-content:space-between;padding:0.3rem 0;align-items:center;">
                                <span><i data-lucide="${i === 0 ? 'medal' : i === 1 ? 'award' : i === 2 ? 'star' : 'user'}" class="icon icon-sm" style="color:${i === 0 ? '#ffd700' : i === 1 ? '#c0c0c0' : i === 2 ? '#cd7f32' : '#7f8c8d'}"></i> ${name}</span>
                                <strong style="color:#27ae60;">${count} <i data-lucide="check" class="icon icon-sm"></i></strong>
                            </div>
                        `).join('') : `<p style="color:#7f8c8d;">${t('noCompletedTasks')}</p>`}
                    </div>
                </div>
            `;
            refreshIcons();
        }

        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
            editingId = null;
            editingUserId = null;
        }

        window.onclick = function(e) {
            ['taskModal', 'functionModal', 'regularTaskModal', 'inviteModal', 'userModal', 'profileModal'].forEach(id => {
                if (e.target === document.getElementById(id)) closeModal(id);
            });
        }

        // Init language on load
        // SVG Icon helper
        function icon(name, size = '') {
            const sizeClass = size ? ` icon-${size}` : '';
            return `<i data-lucide="${name}" class="icon${sizeClass}"></i>`;
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            setLanguage(currentLang);
            // Ініціалізуємо Lucide іконки
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        });
        
        // Переініціалізація іконок після динамічного контенту
        function refreshIcons() {
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }
        
        // =====================
        // SWIPE TO COMPLETE (Event Delegation)
        // =====================
        let swipeState = {
            startX: 0,
            currentX: 0,
            isDragging: false,
            activeCard: null
        };
        
        function initSwipeHandlers() {
            // Event delegation - one listener for all cards
            const container = document.getElementById('mobileTasksList');
            if (!container || container.dataset.swipeInit) return;
            
            container.dataset.swipeInit = 'true';
            
            container.addEventListener('touchstart', (e) => {
                const card = e.target.closest('.mobile-task-card');
                if (!card) return;
                
                swipeState.startX = e.touches[0].clientX;
                swipeState.isDragging = true;
                swipeState.activeCard = card;
                swipeState.currentX = 0;
                card.classList.add('swiping');
            }, { passive: true });
            
            container.addEventListener('touchmove', (e) => {
                if (!swipeState.isDragging || !swipeState.activeCard) return;
                
                const card = swipeState.activeCard;
                const content = card.querySelector('.mobile-task-content');
                const leftBg = card.querySelector('.swipe-action-bg.left');
                const rightBg = card.querySelector('.swipe-action-bg.right');
                const canComplete = card.dataset.canComplete === 'true';
                
                if (!content) return;
                
                swipeState.currentX = e.touches[0].clientX - swipeState.startX;
                
                // Limit swipe distance
                const maxSwipe = 120;
                swipeState.currentX = Math.max(-maxSwipe, Math.min(maxSwipe, swipeState.currentX));
                
                // Apply transform
                content.style.transform = `translateX(${swipeState.currentX}px)`;
                
                // Show appropriate background
                if (swipeState.currentX > 30 && canComplete) {
                    leftBg?.classList.add('visible');
                    rightBg?.classList.remove('visible');
                } else if (swipeState.currentX < -30) {
                    rightBg?.classList.add('visible');
                    leftBg?.classList.remove('visible');
                } else {
                    leftBg?.classList.remove('visible');
                    rightBg?.classList.remove('visible');
                }
            }, { passive: true });
            
            container.addEventListener('touchend', () => {
                if (!swipeState.isDragging || !swipeState.activeCard) return;
                
                const card = swipeState.activeCard;
                const content = card.querySelector('.mobile-task-content');
                const leftBg = card.querySelector('.swipe-action-bg.left');
                const rightBg = card.querySelector('.swipe-action-bg.right');
                const canComplete = card.dataset.canComplete === 'true';
                const taskId = card.dataset.taskId;
                
                swipeState.isDragging = false;
                card.classList.remove('swiping');
                
                const threshold = 80;
                
                // Complete task (swipe right)
                if (swipeState.currentX > threshold && canComplete) {
                    content.style.transform = `translateX(100%)`;
                    content.style.opacity = '0';
                    setTimeout(() => {
                        quickCompleteTask(taskId);
                    }, 200);
                    swipeState.activeCard = null;
                    return;
                }
                
                // Delete task (swipe left)
                if (swipeState.currentX < -threshold) {
                    if (confirm(t('deleteConfirm'))) {
                        content.style.transform = `translateX(-100%)`;
                        content.style.opacity = '0';
                        setTimeout(() => {
                            deleteTask(taskId);
                        }, 200);
                        swipeState.activeCard = null;
                        return;
                    }
                }
                
                // Reset position
                if (content) content.style.transform = '';
                leftBg?.classList.remove('visible');
                rightBg?.classList.remove('visible');
                swipeState.currentX = 0;
                swipeState.activeCard = null;
            });
        }
        
        // =====================
        // BROWSER NOTIFICATIONS
        // =====================
        let notificationsEnabled = localStorage.getItem('notificationsEnabled') === 'true';
        let notificationCheckInterval = null;
        let notifiedTasks = new Set(JSON.parse(localStorage.getItem('notifiedTasks') || '[]'));
        
        // Check if browser supports notifications
        function supportsNotifications() {
            return 'Notification' in window;
        }
        
        // Request permission
        async function requestNotificationPermission() {
            if (!supportsNotifications()) {
                alert('Ваш браузер не підтримує сповіщення');
                return false;
            }
            
            const permission = await Notification.requestPermission();
            
            if (permission === 'granted') {
                notificationsEnabled = true;
                localStorage.setItem('notificationsEnabled', 'true');
                startNotificationChecker();
                updateNotificationButton();
                
                // Show test notification
                new Notification('Сповіщення увімкнено', {
                    body: 'Ви отримуватимете нагадування про дедлайни',
                    icon: 'https://cdn-icons-png.flaticon.com/512/2098/2098402.png',
                    tag: 'test'
                });
                
                return true;
            } else {
                alert('Дозвіл на сповіщення не надано. Перевірте налаштування браузера.');
                return false;
            }
        }
        
        // Disable notifications
        function disableNotifications() {
            notificationsEnabled = false;
            localStorage.setItem('notificationsEnabled', 'false');
            stopNotificationChecker();
            updateNotificationButton();
        }
        
        // Toggle notifications
        async function toggleNotifications() {
            if (notificationsEnabled) {
                disableNotifications();
            } else {
                await requestNotificationPermission();
            }
        }
        
        // Check deadlines and send notifications
        function checkDeadlinesAndNotify() {
            if (!notificationsEnabled || !tasks.length) return;
            
            const now = new Date();
            const today = now.toISOString().split('T')[0];
            const currentHour = now.getHours();
            const currentMinute = now.getMinutes();
            
            tasks.forEach(task => {
                if (task.status === 'done') return;
                
                const taskDeadline = task.deadlineDate || (task.deadline ? task.deadline.split('T')[0] : '');
                const taskTime = task.deadlineTime || (task.deadline ? task.deadline.split('T')[1]?.slice(0,5) : '');
                
                if (!taskDeadline) return;
                
                const notifyKey = `${task.id}-${taskDeadline}`;
                
                // Already notified for this deadline
                if (notifiedTasks.has(notifyKey)) return;
                
                // Check if deadline is today
                if (taskDeadline === today) {
                    let shouldNotify = false;
                    let message = '';
                    
                    if (taskTime) {
                        // Has specific time - notify 1 hour before
                        const [deadlineHour, deadlineMinute] = taskTime.split(':').map(Number);
                        const deadlineInMinutes = deadlineHour * 60 + deadlineMinute;
                        const nowInMinutes = currentHour * 60 + currentMinute;
                        const diff = deadlineInMinutes - nowInMinutes;
                        
                        if (diff > 0 && diff <= 60) {
                            shouldNotify = true;
                            message = `⏰ Дедлайн через ${diff} хв: ${task.title}`;
                        } else if (diff <= 0 && diff > -5) {
                            shouldNotify = true;
                            message = `Дедлайн зараз: ${task.title}`;
                        }
                    } else {
                        // No specific time - notify once in the morning (9:00)
                        if (currentHour === 9 && currentMinute < 5) {
                            shouldNotify = true;
                            message = `Сьогодні дедлайн: ${task.title}`;
                        }
                    }
                    
                    if (shouldNotify) {
                        sendTaskNotification(task, message, notifyKey);
                    }
                }
                
                // Check if deadline is tomorrow (notify at 18:00)
                const tomorrow = new Date(now);
                tomorrow.setDate(tomorrow.getDate() + 1);
                const tomorrowStr = tomorrow.toISOString().split('T')[0];
                
                if (taskDeadline === tomorrowStr && currentHour === 18 && currentMinute < 5) {
                    const notifyKeyTomorrow = `${task.id}-tomorrow`;
                    if (!notifiedTasks.has(notifyKeyTomorrow)) {
                        sendTaskNotification(task, `Завтра дедлайн: ${task.title}`, notifyKeyTomorrow);
                    }
                }
                
                // Check overdue (notify once)
                if (taskDeadline < today) {
                    const notifyKeyOverdue = `${task.id}-overdue`;
                    if (!notifiedTasks.has(notifyKeyOverdue)) {
                        sendTaskNotification(task, `Прострочено: ${task.title}`, notifyKeyOverdue);
                    }
                }
            });
        }
        
        // Send notification
        function sendTaskNotification(task, message, notifyKey) {
            try {
                const notification = new Notification(message, {
                    body: task.function ? `Функція: ${task.function}` : 'Натисніть щоб відкрити',
                    icon: 'https://cdn-icons-png.flaticon.com/512/2098/2098402.png',
                    tag: task.id,
                    requireInteraction: true
                });
                
                notification.onclick = () => {
                    window.focus();
                    openTaskModal(task.id);
                    notification.close();
                };
                
                // Mark as notified
                notifiedTasks.add(notifyKey);
                localStorage.setItem('notifiedTasks', JSON.stringify([...notifiedTasks]));
                
            } catch (e) {
                console.error('Notification error:', e);
            }
        }
        
        // Start checking deadlines
        function startNotificationChecker() {
            if (notificationCheckInterval) return;
            
            // Check immediately
            checkDeadlinesAndNotify();
            
            // Then check every 1 minute
            notificationCheckInterval = setInterval(checkDeadlinesAndNotify, 60000);
        }
        
        // Stop checking
        function stopNotificationChecker() {
            if (notificationCheckInterval) {
                clearInterval(notificationCheckInterval);
                notificationCheckInterval = null;
            }
        }
        
        // Update button state
        function updateNotificationButton() {
            const btn = document.getElementById('notificationToggleBtn');
            if (!btn) return;
            
            if (notificationsEnabled) {
                btn.innerHTML = '<i data-lucide="bell-off" class="icon"></i> Вимкнути сповіщення';
                btn.classList.add('btn-warning');
                btn.classList.remove('btn-success');
            } else {
                btn.innerHTML = '<i data-lucide="bell" class="icon"></i> Увімкнути сповіщення';
                btn.classList.remove('btn-warning');
                btn.classList.add('btn-success');
            }
            refreshIcons();
        }
        
        // Clear old notifications daily
        function clearOldNotifications() {
            const today = new Date().toISOString().split('T')[0];
            const lastClear = localStorage.getItem('lastNotificationClear');
            
            if (lastClear !== today) {
                // Keep only overdue notifications
                const filtered = [...notifiedTasks].filter(key => key.includes('-overdue'));
                notifiedTasks = new Set(filtered);
                localStorage.setItem('notifiedTasks', JSON.stringify(filtered));
                localStorage.setItem('lastNotificationClear', today);
            }
        }
        
        // Init notifications on load
        document.addEventListener('DOMContentLoaded', () => {
            clearOldNotifications();
            
            if (notificationsEnabled && Notification.permission === 'granted') {
                startNotificationChecker();
            } else if (notificationsEnabled) {
                // Permission was revoked
                notificationsEnabled = false;
                localStorage.setItem('notificationsEnabled', 'false');
            }
            
            updateNotificationButton();
            
            // Init FAB for tasks tab
            updateFab('tasks');
        });
    </script>
    
    <!-- Bottom Navigation for Mobile -->
    <nav class="bottom-nav" id="bottomNav">
        <div class="bottom-nav-items">
            <button class="bottom-nav-btn active" onclick="switchTab('tasks')" data-tab="tasks">
                <i data-lucide="clipboard-list" class="icon"></i>
                <span data-i18n="tabTasks">Завдання</span>
            </button>
            <button class="bottom-nav-btn" onclick="switchTab('control')" data-tab="control">
                <i data-lucide="layout-dashboard" class="icon"></i>
                <span data-i18n="tabControl">Контроль</span>
            </button>
            <button class="bottom-nav-btn" onclick="switchTab('regular')" data-tab="regular">
                <i data-lucide="repeat" class="icon"></i>
                <span data-i18n="tabRegular">Регулярні</span>
            </button>
            <button class="bottom-nav-btn" onclick="switchTab('users')" data-tab="users">
                <i data-lucide="users" class="icon"></i>
                <span data-i18n="tabUsers">Команда</span>
            </button>
            <button class="bottom-nav-btn" onclick="openMobileMenu()" data-tab="more">
                <i data-lucide="more-horizontal" class="icon"></i>
                <span>Ще</span>
            </button>
        </div>
    </nav>
    
    <!-- FAB for adding tasks -->
    <button class="fab-add" id="fabAdd">
        <i data-lucide="plus" class="icon"></i>
    </button>
    
    <!-- Mobile Filter Modal -->
    <div class="modal" id="filterModal">
        <div class="modal-content" style="max-width:400px;margin-top:auto;margin-bottom:0;border-radius:16px 16px 0 0;padding:0;">
            <div class="filter-modal-header">
                <h3><i data-lucide="sliders" class="icon icon-sm"></i> Фільтри</h3>
                <button onclick="closeFilterModal()" style="background:none;border:none;cursor:pointer;padding:0.5rem;">
                    <i data-lucide="x" class="icon"></i>
                </button>
            </div>
            
            <div class="filter-modal-content">
                <div class="filter-section">
                    <div class="filter-section-title">Тип завдань</div>
                    <div class="filter-chips" id="filterTypeChips">
                        <div class="filter-chip selected" data-value="" onclick="selectFilterChip(this, 'type')">Всі</div>
                        <div class="filter-chip" data-value="my" onclick="selectFilterChip(this, 'type')">Мої завдання</div>
                        <div class="filter-chip" data-value="created" onclick="selectFilterChip(this, 'type')">Створені мною</div>
                    </div>
                </div>
                
                <div class="filter-section">
                    <div class="filter-section-title">Дата</div>
                    <div class="filter-chips" id="filterDateChips">
                        <div class="filter-chip selected" data-value="" onclick="selectFilterChip(this, 'date')">Всі</div>
                        <div class="filter-chip" data-value="overdue" onclick="selectFilterChip(this, 'date')">Прострочені</div>
                        <div class="filter-chip" data-value="today" onclick="selectFilterChip(this, 'date')">Сьогодні</div>
                        <div class="filter-chip" data-value="week" onclick="selectFilterChip(this, 'date')">Цей тиждень</div>
                        <div class="filter-chip" data-value="month" onclick="selectFilterChip(this, 'date')">Цей місяць</div>
                    </div>
                </div>
                
                <div class="filter-section">
                    <div class="filter-section-title">Статус</div>
                    <div class="filter-chips" id="filterStatusChips">
                        <div class="filter-chip selected" data-value="" onclick="selectFilterChip(this, 'status')">Всі</div>
                        <div class="filter-chip" data-value="new" onclick="selectFilterChip(this, 'status')">Нові</div>
                        <div class="filter-chip" data-value="progress" onclick="selectFilterChip(this, 'status')">В роботі</div>
                        <div class="filter-chip" data-value="review" onclick="selectFilterChip(this, 'status')">Перевірка</div>
                        <div class="filter-chip" data-value="done" onclick="selectFilterChip(this, 'status')">Готово</div>
                    </div>
                </div>
                
                <div class="filter-section">
                    <div class="filter-section-title">Функція</div>
                    <div class="filter-chips" id="filterFunctionChips">
                        <div class="filter-chip selected" data-value="" onclick="selectFilterChip(this, 'function')">Всі</div>
                        <!-- Filled dynamically -->
                    </div>
                </div>
                
                <div class="filter-section">
                    <div class="filter-section-title">Виконавець</div>
                    <div class="filter-chips" id="filterAssigneeChips">
                        <div class="filter-chip selected" data-value="" onclick="selectFilterChip(this, 'assignee')">Всі</div>
                        <!-- Filled dynamically -->
                    </div>
                </div>
            </div>
            
            <div class="filter-modal-footer">
                <button class="btn" onclick="clearAllFilters()">
                    <i data-lucide="x" class="icon icon-sm"></i> Очистити
                </button>
                <button class="btn btn-success" onclick="applyFiltersAndClose()">
                    <i data-lucide="check" class="icon icon-sm"></i> Застосувати
                </button>
            </div>
        </div>
    </div>
    
    <!-- Mobile More Menu Modal -->
    <div class="modal" id="mobileMenuModal" onclick="if(event.target === this) closeMobileMenu();">
        <div class="modal-content" style="max-width:320px;margin-top:auto;margin-bottom:0;border-radius:16px 16px 0 0;">
            <div style="padding:1rem;">
                <h3 style="margin-bottom:1rem;text-align:center;" data-i18n="menu">Меню</h3>
                <div style="display:flex;flex-direction:column;gap:0.5rem;">
                    
                    <!-- AI Assistants -->
                    <p style="margin:0;font-size:0.8rem;color:#888;text-transform:uppercase;letter-spacing:0.5px;" data-i18n="aiAssistants">AI Асистенти</p>
                    <div style="display:flex;gap:0.5rem;">
                        <a href="https://chatgpt.com/g/g-684bb075301481918669f787231e1af7-radar-ai-alex-talko" target="_blank" class="btn" style="flex:1;justify-content:center;background:#8b5cf6;color:white;font-size:0.85rem;" onclick="closeMobileMenu();">
                            <i data-lucide="target" class="icon icon-sm"></i> <span data-i18n="aiManager">Керівник</span>
                        </a>
                        <a href="https://chatgpt.com/g/g-685640bc592881918743da9332b83f31-ai-alex-talko-technical-lead" target="_blank" class="btn" style="flex:1;justify-content:center;background:#22c55e;color:white;font-size:0.85rem;" onclick="closeMobileMenu();">
                            <i data-lucide="wrench" class="icon icon-sm"></i> <span data-i18n="aiTechnical">Технічний</span>
                        </a>
                    </div>
                    <a href="https://chatgpt.com/g/g-69382bfa841881918aff7b50aa25a4f9-talko-task-manager-support" target="_blank" class="btn" style="justify-content:center;background:#3b82f6;color:white;" onclick="closeMobileMenu();">
                        <i data-lucide="message-circle" class="icon"></i> <span data-i18n="aiSupport">AI Помічник (Підтримка)</span>
                    </a>
                    
                    <hr style="border:none;border-top:1px solid #eee;margin:0.5rem 0;">
                    
                    <button class="btn" onclick="switchTab('functions');closeMobileMenu();" style="justify-content:flex-start;">
                        <i data-lucide="settings" class="icon"></i> <span data-i18n="tabFunctions">Функції</span>
                    </button>
                    <button class="btn" onclick="switchTab('analytics');closeMobileMenu();" style="justify-content:flex-start;">
                        <i data-lucide="bar-chart-3" class="icon"></i> <span data-i18n="tabAnalytics">Аналітика</span>
                    </button>
                    <button class="btn" onclick="openProfileModal();closeMobileMenu();" style="justify-content:flex-start;">
                        <i data-lucide="user" class="icon"></i> <span data-i18n="profile">Профіль</span>
                    </button>
                    <button id="notificationToggleBtn" class="btn btn-success" onclick="toggleNotifications();closeMobileMenu();" style="justify-content:flex-start;">
                        <i data-lucide="bell" class="icon"></i> <span data-i18n="enableNotifications">Увімкнути сповіщення</span>
                    </button>
                    <button class="btn" onclick="openDemoDataModal();closeMobileMenu();" style="justify-content:flex-start;" id="demoDataBtn">
                        <i data-lucide="database" class="icon"></i> <span data-i18n="loadDemoData">Завантажити демо-дані</span>
                    </button>
                    <div style="display:flex;gap:0.5rem;margin-top:0.5rem;">
                        <button class="btn" onclick="setLanguage('ua');closeMobileMenu();" style="flex:1;" id="mLangUA">UA</button>
                        <button class="btn" onclick="setLanguage('ru');closeMobileMenu();" style="flex:1;" id="mLangRU">RU</button>
                    </div>
                    <button class="btn btn-danger" onclick="auth.signOut();closeMobileMenu();" style="justify-content:flex-start;margin-top:0.5rem;">
                        <i data-lucide="log-out" class="icon"></i> <span data-i18n="logout">Вийти</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Demo Data Modal -->
    <div class="modal" id="demoDataModal">
        <div class="modal-content" style="max-width:450px;">
            <div class="modal-header">
                <h3><i data-lucide="database" class="icon"></i> Завантажити демо-дані</h3>
                <button class="close-btn" onclick="closeDemoDataModal()">&times;</button>
            </div>
            <div style="padding:1.5rem;">
                <p style="color:#666;margin-bottom:1.5rem;font-size:0.9rem;">
                    Оберіть тип бізнесу для завантаження демо-даних. Буде створено функції, регулярні завдання та приклади задач.
                </p>
                
                <div style="display:flex;flex-direction:column;gap:1rem;">
                    <button class="demo-option-btn" onclick="loadDemoData('clinic')">
                        <div class="demo-option-icon" style="background:#ecfdf5;color:#10b981;">
                            <i data-lucide="heart-pulse" class="icon icon-lg"></i>
                        </div>
                        <div class="demo-option-info">
                            <strong>Медична клініка</strong>
                            <span>Стоматологія, приватна практика, медцентр</span>
                        </div>
                        <i data-lucide="chevron-right" class="icon"></i>
                    </button>
                    
                    <button class="demo-option-btn" onclick="loadDemoData('manufacturing')">
                        <div class="demo-option-icon" style="background:#fef3c7;color:#f59e0b;">
                            <i data-lucide="factory" class="icon icon-lg"></i>
                        </div>
                        <div class="demo-option-info">
                            <strong>Виробництво</strong>
                            <span>Завод, цех, виробнича компанія</span>
                        </div>
                        <i data-lucide="chevron-right" class="icon"></i>
                    </button>
                </div>
                
                <div style="margin-top:1.5rem;padding:1rem;background:#fef2f2;border-radius:8px;font-size:0.85rem;color:#991b1b;">
                    <i data-lucide="alert-triangle" class="icon icon-sm" style="vertical-align:middle;margin-right:0.25rem;"></i>
                    Увага: демо-дані будуть додані до існуючих даних компанії.
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Mobile menu functions
        function openMobileMenu() {
            document.getElementById('mobileMenuModal').style.display = 'flex';
            refreshIcons();
        }
        
        function closeMobileMenu() {
            document.getElementById('mobileMenuModal').style.display = 'none';
        }
        
        // =====================
        // GOOGLE CALENDAR INTEGRATION
        // =====================
        
        function initGoogleCalendar() {
            // Initialize token client for Google Identity Services
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: GOOGLE_CLIENT_ID,
                scope: GOOGLE_SCOPES,
                callback: handleGoogleAuthResponse,
            });
            
            // Check if user already has calendar connected
            checkGoogleCalendarStatus();
        }
        
        function checkGoogleCalendarStatus() {
            if (!currentUser || !currentCompany) return;
            
            db.collection('companies').doc(currentCompany)
                .collection('users').doc(currentUser.uid)
                .get()
                .then(doc => {
                    if (doc.exists) {
                        const data = doc.data();
                        if (data.googleCalendarConnected && data.googleCalendarEmail) {
                            showCalendarConnected(data.googleCalendarEmail);
                            googleAccessToken = data.googleAccessToken || null;
                        } else {
                            showCalendarNotConnected();
                        }
                    }
                })
                .catch(err => console.error('Error checking calendar status:', err));
        }
        
        function showCalendarConnected(email) {
            const connected = document.getElementById('gcalConnected');
            const notConnected = document.getElementById('gcalNotConnected');
            const emailEl = document.getElementById('gcalEmail');
            
            if (connected) connected.style.display = 'block';
            if (notConnected) notConnected.style.display = 'none';
            if (emailEl) emailEl.textContent = 'Підключено: ' + email;
        }
        
        function showCalendarNotConnected() {
            const connected = document.getElementById('gcalConnected');
            const notConnected = document.getElementById('gcalNotConnected');
            
            if (connected) connected.style.display = 'none';
            if (notConnected) notConnected.style.display = 'block';
        }
        
        function connectGoogleCalendar() {
            if (!tokenClient) {
                alert('Google API не завантажено. Спробуйте оновити сторінку.');
                return;
            }
            
            // Request access token
            tokenClient.requestAccessToken({ prompt: 'consent' });
        }
        
        function handleGoogleAuthResponse(response) {
            if (response.error) {
                console.error('Google auth error:', response);
                alert('Помилка авторизації Google: ' + response.error);
                return;
            }
            
            googleAccessToken = response.access_token;
            
            // Get user email from Google
            fetch('https://www.googleapis.com/oauth2/v2/userinfo', {
                headers: { 'Authorization': 'Bearer ' + googleAccessToken }
            })
            .then(res => {
                if (!res.ok) {
                    throw new Error('Failed to get user info: ' + res.status);
                }
                return res.json();
            })
            .then(userInfo => {
                const email = userInfo.email || currentUser.email || 'Підключено';
                
                // Save to Firestore using set with merge
                return db.collection('companies').doc(currentCompany)
                    .collection('users').doc(currentUser.uid)
                    .set({
                        googleCalendarConnected: true,
                        googleCalendarEmail: email,
                        googleAccessToken: googleAccessToken,
                        googleCalendarUpdatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    }, { merge: true })
                    .then(() => {
                        showCalendarConnected(email);
                        alert('Google Calendar успішно підключено!');
                    });
            })
            .catch(err => {
                console.error('Error saving calendar connection:', err);
                // Try to save without email
                db.collection('companies').doc(currentCompany)
                    .collection('users').doc(currentUser.uid)
                    .set({
                        googleCalendarConnected: true,
                        googleCalendarEmail: currentUser.email || 'Підключено',
                        googleAccessToken: googleAccessToken,
                        googleCalendarUpdatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    }, { merge: true })
                    .then(() => {
                        showCalendarConnected(currentUser.email || 'Підключено');
                        alert('Google Calendar успішно підключено!');
                    })
                    .catch(err2 => {
                        alert('Помилка збереження: ' + err2.message);
                    });
            });
        }
        
        function disconnectGoogleCalendar() {
            if (!confirm('Відключити Google Calendar? Синхронізація завдань буде зупинена.')) {
                return;
            }
            
            // Revoke token if exists
            if (googleAccessToken) {
                google.accounts.oauth2.revoke(googleAccessToken, () => {
                    console.log('Token revoked');
                });
            }
            
            // Update Firestore
            db.collection('companies').doc(currentCompany)
                .collection('users').doc(currentUser.uid)
                .set({
                    googleCalendarConnected: false,
                    googleCalendarEmail: firebase.firestore.FieldValue.delete(),
                    googleAccessToken: firebase.firestore.FieldValue.delete()
                }, { merge: true })
                .then(() => {
                    googleAccessToken = null;
                    showCalendarNotConnected();
                    alert('Google Calendar відключено');
                })
                .catch(err => {
                    console.error('Error disconnecting calendar:', err);
                    alert('Помилка: ' + err.message);
                });
        }
        
        // Create event in Google Calendar
        async function createCalendarEvent(task) {
            if (!googleAccessToken) {
                console.log('No Google Calendar token, skipping sync');
                return null;
            }
            
            const startDateTime = new Date(task.deadlineDate + 'T' + (task.deadlineTime || '09:00'));
            const durationMinutes = parseInt(task.estimatedTime) || 60;
            const endDateTime = new Date(startDateTime.getTime() + durationMinutes * 60000);
            
            const event = {
                summary: task.title,
                description: task.description || task.expectedResult || '',
                start: {
                    dateTime: startDateTime.toISOString(),
                    timeZone: 'Europe/Kyiv'
                },
                end: {
                    dateTime: endDateTime.toISOString(),
                    timeZone: 'Europe/Kyiv'
                },
                reminders: {
                    useDefault: false,
                    overrides: [
                        { method: 'popup', minutes: 60 },
                        { method: 'popup', minutes: 15 }
                    ]
                }
            };
            
            try {
                const response = await fetch('https://www.googleapis.com/calendar/v3/calendars/primary/events', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + googleAccessToken,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(event)
                });
                
                if (response.status === 401) {
                    // Token expired, need to reconnect
                    console.log('Google token expired');
                    googleAccessToken = null;
                    return null;
                }
                
                if (!response.ok) {
                    throw new Error('Failed to create event: ' + response.status);
                }
                
                const result = await response.json();
                console.log('Calendar event created:', result.id);
                return result.id;
            } catch (err) {
                console.error('Error creating calendar event:', err);
                return null;
            }
        }
        
        // Update event in Google Calendar
        async function updateCalendarEvent(eventId, task) {
            if (!googleAccessToken || !eventId) {
                return false;
            }
            
            const startDateTime = new Date(task.deadlineDate + 'T' + (task.deadlineTime || '09:00'));
            const durationMinutes = parseInt(task.estimatedTime) || 60;
            const endDateTime = new Date(startDateTime.getTime() + durationMinutes * 60000);
            
            const event = {
                summary: task.title,
                description: task.description || task.expectedResult || '',
                start: {
                    dateTime: startDateTime.toISOString(),
                    timeZone: 'Europe/Kyiv'
                },
                end: {
                    dateTime: endDateTime.toISOString(),
                    timeZone: 'Europe/Kyiv'
                }
            };
            
            try {
                const response = await fetch(`https://www.googleapis.com/calendar/v3/calendars/primary/events/${eventId}`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': 'Bearer ' + googleAccessToken,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(event)
                });
                
                if (!response.ok) {
                    throw new Error('Failed to update event');
                }
                
                console.log('Calendar event updated:', eventId);
                return true;
            } catch (err) {
                console.error('Error updating calendar event:', err);
                return false;
            }
        }
        
        // Delete event from Google Calendar
        async function deleteCalendarEvent(eventId) {
            if (!googleAccessToken || !eventId) {
                return false;
            }
            
            try {
                const response = await fetch(`https://www.googleapis.com/calendar/v3/calendars/primary/events/${eventId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': 'Bearer ' + googleAccessToken
                    }
                });
                
                // 204 = success, 404/410 = already deleted (ok)
                if (response.ok || response.status === 404 || response.status === 410) {
                    console.log('Calendar event deleted:', eventId);
                    return true;
                }
                
                console.warn('Calendar delete response:', response.status);
                return false;
            } catch (err) {
                console.error('Error deleting calendar event:', err);
                return false;
            }
        }
        
        // Profile Modal
        function openProfileModal() {
            const modal = document.getElementById('profileModal');
            if (!modal) return;
            
            // Fill profile data
            const nameEl = document.getElementById('profileName');
            const emailEl = document.getElementById('profileEmail');
            const roleEl = document.getElementById('profileRole');
            const avatarEl = document.getElementById('profileAvatar');
            
            if (currentUserData) {
                const name = currentUserData.name || currentUser?.displayName || 'Користувач';
                if (nameEl) nameEl.textContent = name;
                if (emailEl) emailEl.textContent = currentUser?.email || '';
                if (roleEl) roleEl.textContent = getRoleText(currentUserData.role);
                if (avatarEl) avatarEl.textContent = name.charAt(0).toUpperCase();
            }
            
            // Check calendar status
            checkGoogleCalendarStatus();
            
            modal.style.display = 'flex';
            refreshIcons();
        }
        
        // =====================
        // CALENDAR QUICK ACTIONS
        // =====================
        
        // Open task form with pre-filled date and time
        function openTaskAtTime(dateStr, hour) {
            editingId = null;
            document.getElementById('taskModalTitle').textContent = t('addTask');
            document.getElementById('taskForm').reset();
            
            // Pre-fill date and time
            document.getElementById('taskDeadlineDate').value = dateStr;
            document.getElementById('taskDeadlineTime').value = hour.toString().padStart(2, '0') + ':00';
            document.getElementById('taskStatus').value = 'new';
            
            // Reset assignee and function
            document.getElementById('taskAssignee').value = '';
            document.getElementById('taskFunction').value = '';
            
            document.getElementById('taskModal').style.display = 'flex';
            refreshIcons();
        }
        
        // Quick menu for task actions
        let activeQuickMenu = null;
        let activeOverlay = null;
        
        function showTaskQuickMenu(event, taskId) {
            event.stopPropagation();
            
            // Close existing menu
            closeTaskQuickMenu();
            
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;
            
            const isMobile = window.innerWidth <= 767;
            
            // Get deadline info
            const deadline = task.deadline?.toDate ? task.deadline.toDate() : new Date(task.deadline);
            const deadlineStr = deadline.toLocaleDateString('uk-UA', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' });
            const assignee = task.assigneeName || 'Не призначено';
            const funcName = task.function || '';
            
            // Status colors
            const statusColors = {
                'new': '#3b82f6',
                'in_progress': '#f59e0b', 
                'review': '#8b5cf6',
                'done': '#10b981'
            };
            const statusColor = statusColors[task.status] || '#6b7280';
            
            // Create overlay for mobile
            if (isMobile) {
                const overlay = document.createElement('div');
                overlay.className = 'task-bottom-sheet-overlay';
                overlay.onclick = closeTaskQuickMenu;
                document.body.appendChild(overlay);
                activeOverlay = overlay;
            }
            
            // Create menu
            const menu = document.createElement('div');
            menu.className = 'task-quick-menu';
            menu.id = 'taskQuickMenu';
            menu.innerHTML = `
                <div class="task-quick-menu-header">
                    <div style="display:flex;align-items:center;gap:8px;">
                        <div style="width:12px;height:12px;border-radius:50%;background:${statusColor};flex-shrink:0;"></div>
                        <span style="flex:1;overflow:hidden;text-overflow:ellipsis;">${task.title}</span>
                    </div>
                    ${isMobile ? `<div style="font-size:0.85rem;color:#888;margin-top:6px;font-weight:400;">
                        ${deadlineStr}${funcName ? ' • ' + funcName : ''}
                    </div>` : ''}
                </div>
                <div class="task-quick-menu-item" onclick="openTaskModal('${taskId}');closeTaskQuickMenu();">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                    Редагувати
                </div>
                ${task.status !== 'done' ? `
                <div class="task-quick-menu-item complete" onclick="quickCompleteFromMenu('${taskId}')">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                    Завершити
                </div>
                ` : `
                <div class="task-quick-menu-item" onclick="reopenTaskFromMenu('${taskId}')">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>
                    Відновити
                </div>
                `}
                <div class="task-quick-menu-item delete" onclick="deleteTaskFromMenu('${taskId}')">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                    Видалити
                </div>
            `;
            
            // Position menu (only for desktop)
            if (!isMobile) {
                const rect = event.target.closest('.calendar-event, .calendar-allday-event').getBoundingClientRect();
                menu.style.position = 'fixed';
                menu.style.left = Math.min(rect.left, window.innerWidth - 200) + 'px';
                menu.style.top = Math.min(rect.bottom + 5, window.innerHeight - 180) + 'px';
            }
            
            document.body.appendChild(menu);
            activeQuickMenu = menu;
            
            // Close on click outside (desktop only)
            if (!isMobile) {
                setTimeout(() => {
                    document.addEventListener('click', closeTaskQuickMenu);
                }, 10);
            }
        }
        
        function closeTaskQuickMenu() {
            if (activeOverlay) {
                activeOverlay.remove();
                activeOverlay = null;
            }
            if (activeQuickMenu) {
                activeQuickMenu.remove();
                activeQuickMenu = null;
            }
            document.removeEventListener('click', closeTaskQuickMenu);
        }
        
        async function quickCompleteFromMenu(taskId) {
            closeTaskQuickMenu();
            
            const task = tasks.find(t => t.id === taskId);
            if (task?.calendarEventId && googleAccessToken) {
                deleteCalendarEvent(task.calendarEventId);
            }
            
            await db.collection('companies').doc(currentCompany).collection('tasks').doc(taskId).update({ 
                status: 'done',
                completedAt: new Date().toISOString()
            });
            loadAllData();
        }
        
        async function reopenTaskFromMenu(taskId) {
            closeTaskQuickMenu();
            await db.collection('companies').doc(currentCompany).collection('tasks').doc(taskId).update({ 
                status: 'in_progress'
            });
            loadAllData();
        }
        
        async function deleteTaskFromMenu(taskId) {
            closeTaskQuickMenu();
            if (!confirm('Видалити це завдання?')) return;
            
            const task = tasks.find(t => t.id === taskId);
            if (task?.calendarEventId && googleAccessToken) {
                deleteCalendarEvent(task.calendarEventId);
            }
            
            await db.collection('companies').doc(currentCompany).collection('tasks').doc(taskId).delete();
            loadAllData();
        }
        
        // Drag and drop
        let draggedTaskId = null;
        
        function onTaskDragStart(event, taskId) {
            draggedTaskId = taskId;
            event.dataTransfer.effectAllowed = 'move';
            event.target.style.opacity = '0.5';
        }
        
        function onTaskDragEnd(event) {
            event.target.style.opacity = '1';
            draggedTaskId = null;
        }
        
        function onHourDragOver(event) {
            event.preventDefault();
            event.dataTransfer.dropEffect = 'move';
            event.target.classList.add('drag-over');
        }
        
        function onHourDragLeave(event) {
            event.target.classList.remove('drag-over');
        }
        
        async function onHourDrop(event, dateStr, hour) {
            event.preventDefault();
            event.target.classList.remove('drag-over');
            
            if (!draggedTaskId) return;
            
            const task = tasks.find(t => t.id === draggedTaskId);
            if (!task) return;
            
            // Get minutes from original time if available
            const oldDeadline = task.deadline?.toDate ? task.deadline.toDate() : new Date(task.deadline);
            const minutes = oldDeadline ? oldDeadline.getMinutes() : 0;
            
            const newTime = hour.toString().padStart(2, '0') + ':' + minutes.toString().padStart(2, '0');
            const newDeadline = dateStr + 'T' + newTime;
            
            // Update task
            await db.collection('companies').doc(currentCompany).collection('tasks').doc(draggedTaskId).update({
                deadlineDate: dateStr,
                deadlineTime: newTime,
                deadline: newDeadline,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            // Update Google Calendar
            if (task.calendarEventId && googleAccessToken) {
                updateCalendarEvent(task.calendarEventId, { ...task, deadlineDate: dateStr, deadlineTime: newTime });
            }
            
            draggedTaskId = null;
            loadAllData();
        }

        // =====================
        // DEMO DATA
        // =====================
        
        function openDemoDataModal() {
            document.getElementById('demoDataModal').style.display = 'flex';
            refreshIcons();
        }
        
        function closeDemoDataModal() {
            document.getElementById('demoDataModal').style.display = 'none';
        }
        
        async function loadDemoData(type) {
            if (!confirm(currentLang === 'ua' 
                ? 'Завантажити демо-дані? Існуючі дані не будуть видалені.' 
                : 'Загрузить демо-данные? Существующие данные не будут удалены.')) {
                return;
            }
            
            closeDemoDataModal();
            
            try {
                if (type === 'clinic') {
                    await loadClinicDemoData();
                } else if (type === 'manufacturing') {
                    await loadManufacturingDemoData();
                }
                
                await loadAllData();
                alert(currentLang === 'ua' ? 'Демо-дані успішно завантажено!' : 'Демо-данные успешно загружены!');
            } catch (e) {
                console.error('Error loading demo data:', e);
                alert(currentLang === 'ua' ? 'Помилка завантаження: ' + e.message : 'Ошибка загрузки: ' + e.message);
            }
        }
        
        async function loadClinicDemoData() {
            const batch = db.batch();
            const companyRef = db.collection('companies').doc(currentCompany);
            
            // Demo users (if not exist)
            const demoUsers = [
                { name: 'Марія Коваленко', email: 'maria@demo.clinic', role: 'employee' },
                { name: 'Олег Петренко', email: 'oleg@demo.clinic', role: 'employee' },
                { name: 'Анна Шевченко', email: 'anna@demo.clinic', role: 'employee' }
            ];
            
            const userIds = [];
            for (const user of demoUsers) {
                const userRef = companyRef.collection('users').doc();
                batch.set(userRef, { ...user, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
                userIds.push(userRef.id);
            }
            
            // Functions for clinic
            const clinicFunctions = [
                { name: 'Адміністрування', description: 'Запис пацієнтів, документообіг, організація роботи', assigneeIds: [userIds[0]] },
                { name: 'Лікування', description: 'Прийом пацієнтів, консультації, процедури', assigneeIds: [userIds[1]] },
                { name: 'Маркетинг', description: 'Залучення пацієнтів, реклама, соцмережі', assigneeIds: [userIds[0], userIds[2]] },
                { name: 'Закупівлі', description: 'Замовлення матеріалів, обладнання, розхідники', assigneeIds: [userIds[2]] },
                { name: 'Фінанси', description: 'Рахунки, звіти, бухгалтерія', assigneeIds: [userIds[0]] }
            ];
            
            const funcRefs = [];
            for (const func of clinicFunctions) {
                const funcRef = companyRef.collection('functions').doc();
                batch.set(funcRef, { ...func, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
                funcRefs.push({ id: funcRef.id, ...func });
            }
            
            // Regular tasks for clinic
            const clinicRegularTasks = [
                { title: 'Обдзвін пацієнтів на завтра', function: 'Адміністрування', period: 'weekly', dayOfWeek: '1', time: '09:00', estimatedTime: '30', instruction: 'Зателефонувати всім пацієнтам, записаним на завтра. Підтвердити візит. Нагадати про підготовку якщо потрібно.' },
                { title: 'Обдзвін пацієнтів на завтра', function: 'Адміністрування', period: 'weekly', dayOfWeek: '2', time: '09:00', estimatedTime: '30', instruction: 'Зателефонувати всім пацієнтам, записаним на завтра.' },
                { title: 'Обдзвін пацієнтів на завтра', function: 'Адміністрування', period: 'weekly', dayOfWeek: '3', time: '09:00', estimatedTime: '30', instruction: 'Зателефонувати всім пацієнтам, записаним на завтра.' },
                { title: 'Обдзвін пацієнтів на завтра', function: 'Адміністрування', period: 'weekly', dayOfWeek: '4', time: '09:00', estimatedTime: '30', instruction: 'Зателефонувати всім пацієнтам, записаним на завтра.' },
                { title: 'Замовлення розхідних матеріалів', function: 'Закупівлі', period: 'weekly', dayOfWeek: '5', time: '14:00', estimatedTime: '60', instruction: 'Перевірити залишки матеріалів. Сформувати замовлення. Відправити постачальнику.' },
                { title: 'Публікація в соцмережах', function: 'Маркетинг', period: 'weekly', dayOfWeek: '1', time: '11:00', estimatedTime: '45', instruction: 'Підготувати та опублікувати контент в Instagram та Facebook.' },
                { title: 'Публікація в соцмережах', function: 'Маркетинг', period: 'weekly', dayOfWeek: '4', time: '11:00', estimatedTime: '45', instruction: 'Підготувати та опублікувати контент в Instagram та Facebook.' },
                { title: 'Фінансовий звіт за тиждень', function: 'Фінанси', period: 'weekly', dayOfWeek: '5', time: '17:00', estimatedTime: '60', instruction: 'Підготувати звіт по виручці, витратах, прибутку за тиждень.' },
                { title: 'Місячний звіт керівнику', function: 'Фінанси', period: 'monthly', dayOfMonth: 'last', time: '16:00', estimatedTime: '120', instruction: 'Підготувати повний місячний звіт: фінанси, пацієнти, маркетинг, проблеми.' },
                { title: 'Ревізія обладнання', function: 'Закупівлі', period: 'monthly', dayOfMonth: '15', time: '10:00', estimatedTime: '90', instruction: 'Перевірити стан обладнання, скласти список необхідного ремонту/заміни.' }
            ];
            
            for (const rt of clinicRegularTasks) {
                const rtRef = companyRef.collection('regularTasks').doc();
                batch.set(rtRef, { ...rt, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
            }
            
            // Sample tasks for today/tomorrow
            const today = new Date();
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            
            // Завдання прив'язані до ФУНКЦІЙ, виконавці беруться автоматично
            // Коли людина звільняється - видаляємо її з функції, нові завдання падають на нового співробітника
            const clinicTasks = [
                { title: 'Первинна консультація - Іванов І.І.', function: 'Лікування', status: 'new', priority: 'high', deadlineDate: today.toISOString().split('T')[0], deadlineTime: '10:00', estimatedTime: '45', expectedResult: 'Діагноз, план лікування' },
                { title: 'Підготувати рекламну акцію на Новий рік', function: 'Маркетинг', status: 'progress', priority: 'medium', deadlineDate: tomorrow.toISOString().split('T')[0], deadlineTime: '15:00', estimatedTime: '120', expectedResult: 'Готовий макет та текст акції' },
                { title: 'Замовити нові рукавички та маски', function: 'Закупівлі', status: 'new', priority: 'medium', deadlineDate: today.toISOString().split('T')[0], deadlineTime: '14:00', estimatedTime: '30', expectedResult: 'Замовлення оформлене' },
                { title: 'Оплатити рахунок за оренду', function: 'Фінанси', status: 'new', priority: 'high', deadlineDate: today.toISOString().split('T')[0], deadlineTime: '16:00', estimatedTime: '15', expectedResult: 'Рахунок оплачено' }
            ];
            
            for (const task of clinicTasks) {
                // Знаходимо функцію і беремо першого виконавця з неї
                const func = clinicFunctions.find(f => f.name === task.function);
                const assigneeId = func?.assigneeIds?.[0] || null;
                // Знаходимо ім'я виконавця по індексу в userIds
                const assigneeIndex = userIds.indexOf(assigneeId);
                const assigneeName = assigneeIndex >= 0 ? demoUsers[assigneeIndex].name : '';
                
                const taskRef = companyRef.collection('tasks').doc();
                batch.set(taskRef, { 
                    ...task,
                    assigneeId: assigneeId,
                    assigneeName: assigneeName,
                    createdBy: currentUser.uid,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    deadline: firebase.firestore.Timestamp.fromDate(new Date(task.deadlineDate + 'T' + task.deadlineTime))
                });
            }
            
            await batch.commit();
        }
        
        async function loadManufacturingDemoData() {
            const batch = db.batch();
            const companyRef = db.collection('companies').doc(currentCompany);
            
            // Demo users
            const demoUsers = [
                { name: 'Сергій Мельник', email: 'sergiy@demo.factory', role: 'employee' },
                { name: 'Віктор Бондаренко', email: 'viktor@demo.factory', role: 'employee' },
                { name: 'Ірина Ткаченко', email: 'iryna@demo.factory', role: 'employee' }
            ];
            
            const userIds = [];
            for (const user of demoUsers) {
                const userRef = companyRef.collection('users').doc();
                batch.set(userRef, { ...user, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
                userIds.push(userRef.id);
            }
            
            // Functions for manufacturing
            const mfgFunctions = [
                { name: 'Виробництво', description: 'Управління виробничим процесом, контроль лінії', assigneeIds: [userIds[0]] },
                { name: 'Контроль якості', description: 'Перевірка продукції, стандарти, брак', assigneeIds: [userIds[1]] },
                { name: 'Логістика', description: 'Відвантаження, доставка, склад', assigneeIds: [userIds[2]] },
                { name: 'Постачання', description: 'Закупівля сировини, комплектуючих', assigneeIds: [userIds[2]] },
                { name: 'Обслуговування', description: 'Ремонт обладнання, профілактика', assigneeIds: [userIds[0], userIds[1]] }
            ];
            
            const funcRefs = [];
            for (const func of mfgFunctions) {
                const funcRef = companyRef.collection('functions').doc();
                batch.set(funcRef, { ...func, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
                funcRefs.push({ id: funcRef.id, ...func });
            }
            
            // Regular tasks for manufacturing
            const mfgRegularTasks = [
                { title: 'Ранкова перевірка обладнання', function: 'Виробництво', period: 'weekly', dayOfWeek: '1', time: '07:30', estimatedTime: '30', instruction: 'Перевірити стан всіх верстатів, рівень мастила, тиск, температуру.' },
                { title: 'Ранкова перевірка обладнання', function: 'Виробництво', period: 'weekly', dayOfWeek: '2', time: '07:30', estimatedTime: '30', instruction: 'Перевірити стан всіх верстатів.' },
                { title: 'Ранкова перевірка обладнання', function: 'Виробництво', period: 'weekly', dayOfWeek: '3', time: '07:30', estimatedTime: '30', instruction: 'Перевірити стан всіх верстатів.' },
                { title: 'Ранкова перевірка обладнання', function: 'Виробництво', period: 'weekly', dayOfWeek: '4', time: '07:30', estimatedTime: '30', instruction: 'Перевірити стан всіх верстатів.' },
                { title: 'Ранкова перевірка обладнання', function: 'Виробництво', period: 'weekly', dayOfWeek: '5', time: '07:30', estimatedTime: '30', instruction: 'Перевірити стан всіх верстатів.' },
                { title: 'Контроль якості партії', function: 'Контроль якості', period: 'weekly', dayOfWeek: '2', time: '14:00', estimatedTime: '60', instruction: 'Вибіркова перевірка продукції, заповнення журналу якості.' },
                { title: 'Контроль якості партії', function: 'Контроль якості', period: 'weekly', dayOfWeek: '4', time: '14:00', estimatedTime: '60', instruction: 'Вибіркова перевірка продукції.' },
                { title: 'Інвентаризація складу', function: 'Логістика', period: 'weekly', dayOfWeek: '5', time: '16:00', estimatedTime: '90', instruction: 'Перевірити залишки готової продукції та сировини. Оновити систему.' },
                { title: 'Замовлення сировини', function: 'Постачання', period: 'weekly', dayOfWeek: '1', time: '10:00', estimatedTime: '45', instruction: 'Проаналізувати потреби на тиждень, сформувати замовлення постачальникам.' },
                { title: 'Технічне обслуговування обладнання', function: 'Обслуговування', period: 'monthly', dayOfMonth: '1', time: '08:00', estimatedTime: '240', instruction: 'Повне ТО всіх верстатів: мастило, фільтри, калібрування.' },
                { title: 'Звіт по виробництву за місяць', function: 'Виробництво', period: 'monthly', dayOfMonth: 'last', time: '15:00', estimatedTime: '120', instruction: 'Підготувати звіт: обсяг виробництва, простої, брак, ефективність.' }
            ];
            
            for (const rt of mfgRegularTasks) {
                const rtRef = companyRef.collection('regularTasks').doc();
                batch.set(rtRef, { ...rt, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
            }
            
            // Sample tasks - виконавці беруться з функцій автоматично
            const today = new Date();
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            
            const mfgTasks = [
                { title: 'Виготовити партію 500 од. - Замовлення #1247', function: 'Виробництво', status: 'progress', priority: 'high', deadlineDate: today.toISOString().split('T')[0], deadlineTime: '17:00', estimatedTime: '360', expectedResult: '500 одиниць готової продукції' },
                { title: 'Перевірити якість партії #1245', function: 'Контроль якості', status: 'new', priority: 'high', deadlineDate: today.toISOString().split('T')[0], deadlineTime: '12:00', estimatedTime: '60', expectedResult: 'Звіт про якість, % браку' },
                { title: 'Відвантаження клієнту ТОВ "Альфа"', function: 'Логістика', status: 'new', priority: 'medium', deadlineDate: tomorrow.toISOString().split('T')[0], deadlineTime: '09:00', estimatedTime: '90', expectedResult: 'Товар відвантажено, ТТН підписана' },
                { title: 'Замовити комплектуючі до верстата #3', function: 'Постачання', status: 'new', priority: 'medium', deadlineDate: today.toISOString().split('T')[0], deadlineTime: '14:00', estimatedTime: '30', expectedResult: 'Замовлення оформлене' },
                { title: 'Ремонт конвеєра - лінія 2', function: 'Обслуговування', status: 'progress', priority: 'high', deadlineDate: today.toISOString().split('T')[0], deadlineTime: '11:00', estimatedTime: '120', expectedResult: 'Конвеєр працює' }
            ];
            
            for (const task of mfgTasks) {
                // Знаходимо функцію і беремо першого виконавця з неї
                const func = mfgFunctions.find(f => f.name === task.function);
                const assigneeId = func?.assigneeIds?.[0] || null;
                // Знаходимо ім'я виконавця по індексу в userIds
                const assigneeIndex = userIds.indexOf(assigneeId);
                const assigneeName = assigneeIndex >= 0 ? demoUsers[assigneeIndex].name : '';
                
                const taskRef = companyRef.collection('tasks').doc();
                batch.set(taskRef, { 
                    ...task,
                    assigneeId: assigneeId,
                    assigneeName: assigneeName,
                    createdBy: currentUser.uid,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    deadline: firebase.firestore.Timestamp.fromDate(new Date(task.deadlineDate + 'T' + task.deadlineTime))
                });
            }
            
            await batch.commit();
        }

        // =====================
        // MOBILE FILTERS
        // =====================
        let mobileFilters = {
            type: '',
            date: '',
            status: '',
            function: '',
            assignee: ''
        };
        
        function openFilterModal() {
            const modal = document.getElementById('filterModal');
            modal.style.display = 'flex';
            
            // Populate function chips
            const funcContainer = document.getElementById('filterFunctionChips');
            funcContainer.innerHTML = '<div class="filter-chip selected" data-value="" onclick="selectFilterChip(this, \'function\')">Всі</div>';
            functions.forEach(f => {
                const selected = mobileFilters.function === f.name ? 'selected' : '';
                funcContainer.innerHTML += `<div class="filter-chip ${selected}" data-value="${f.name}" onclick="selectFilterChip(this, 'function')">${f.name}</div>`;
            });
            
            // Populate assignee chips
            const assigneeContainer = document.getElementById('filterAssigneeChips');
            assigneeContainer.innerHTML = '<div class="filter-chip selected" data-value="" onclick="selectFilterChip(this, \'assignee\')">Всі</div>';
            users.forEach(u => {
                const name = u.name || u.email.split('@')[0];
                const selected = mobileFilters.assignee === u.id ? 'selected' : '';
                assigneeContainer.innerHTML += `<div class="filter-chip ${selected}" data-value="${u.id}" onclick="selectFilterChip(this, 'assignee')">${name}</div>`;
            });
            
            // Sync current filters
            syncFilterChips();
            refreshIcons();
        }
        
        function closeFilterModal() {
            document.getElementById('filterModal').style.display = 'none';
        }
        
        function selectFilterChip(chip, category) {
            // Remove selected from siblings
            chip.parentElement.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('selected'));
            chip.classList.add('selected');
            mobileFilters[category] = chip.dataset.value;
        }
        
        function syncFilterChips() {
            // Sync type
            document.querySelectorAll('#filterTypeChips .filter-chip').forEach(c => {
                c.classList.toggle('selected', c.dataset.value === mobileFilters.type);
            });
            // Sync date
            document.querySelectorAll('#filterDateChips .filter-chip').forEach(c => {
                c.classList.toggle('selected', c.dataset.value === mobileFilters.date);
            });
            // Sync status
            document.querySelectorAll('#filterStatusChips .filter-chip').forEach(c => {
                c.classList.toggle('selected', c.dataset.value === mobileFilters.status);
            });
        }
        
        function applyFiltersAndClose() {
            // Apply filters to desktop selects
            document.getElementById('taskTypeFilter').value = mobileFilters.type;
            document.getElementById('dateFilter').value = mobileFilters.date;
            document.getElementById('statusFilter').value = mobileFilters.status;
            document.getElementById('functionFilter').value = mobileFilters.function;
            document.getElementById('assigneeFilter').value = mobileFilters.assignee;
            
            // Update filter count badge
            updateFilterCount();
            
            // Update quick filter buttons
            updateQuickFilterButtons();
            
            renderTasks();
            closeFilterModal();
        }
        
        function clearAllFilters() {
            mobileFilters = { type: '', date: '', status: '', function: '', assignee: '' };
            document.querySelectorAll('.filter-chip').forEach(c => {
                c.classList.toggle('selected', c.dataset.value === '');
            });
            applyFiltersAndClose();
        }
        
        function updateFilterCount() {
            const count = Object.values(mobileFilters).filter(v => v !== '').length;
            const badge = document.getElementById('activeFilterCount');
            if (count > 0) {
                badge.textContent = count;
                badge.style.display = 'inline';
            } else {
                badge.style.display = 'none';
            }
        }
        
        function setMobileQuickFilter(filter) {
            // Toggle behavior
            if (filter === 'my') {
                mobileFilters.type = mobileFilters.type === 'my' ? '' : 'my';
                mobileFilters.date = '';
            } else if (filter === 'today') {
                mobileFilters.date = mobileFilters.date === 'today' ? '' : 'today';
                mobileFilters.type = '';
            }
            
            // Apply to desktop filters
            document.getElementById('taskTypeFilter').value = mobileFilters.type;
            document.getElementById('dateFilter').value = mobileFilters.date;
            
            updateQuickFilterButtons();
            updateFilterCount();
            renderTasks();
        }
        
        function updateQuickFilterButtons() {
            document.querySelectorAll('.mobile-filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            if (mobileFilters.type === 'my') {
                document.querySelector('.mobile-filter-btn[onclick*="my"]')?.classList.add('active');
            }
            if (mobileFilters.date === 'today') {
                document.querySelector('.mobile-filter-btn[onclick*="today"]')?.classList.add('active');
            }
        }
        
        // Update bottom nav active state
        const originalSwitchTab = window.switchTab;
        window.switchTab = function(tab) {
            originalSwitchTab(tab);
            
            // Update bottom nav
            document.querySelectorAll('.bottom-nav-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.tab === tab) {
                    btn.classList.add('active');
                }
            });
        };
        
        // Show FAB when logged in
        auth.onAuthStateChanged(user => {
            const fab = document.getElementById('fabAdd');
            const bottomNav = document.getElementById('bottomNav');
            if (user && fab) {
                fab.style.display = 'flex';
            } else if (fab) {
                fab.style.display = 'none';
            }
        });
        
        // =====================
        // SWIPE BETWEEN TABS
        // =====================
        const mobileTabs = ['tasks', 'control', 'regular', 'users'];
        let tabSwipeStartX = 0;
        let tabSwipeStartY = 0;
        let isTabSwiping = false;
        
        function initTabSwipeGestures() {
            const mainInterface = document.getElementById('mainInterface');
            if (!mainInterface || mainInterface.dataset.tabSwipeInit) return;
            
            mainInterface.dataset.tabSwipeInit = 'true';
            
            mainInterface.addEventListener('touchstart', (e) => {
                // Ignore if swiping on a task card or modal
                if (e.target.closest('.mobile-task-card') || 
                    e.target.closest('.modal') ||
                    e.target.closest('.filter-chips') ||
                    e.target.closest('input') ||
                    e.target.closest('select') ||
                    e.target.closest('button')) {
                    return;
                }
                
                tabSwipeStartX = e.touches[0].clientX;
                tabSwipeStartY = e.touches[0].clientY;
                isTabSwiping = true;
            }, { passive: true });
            
            mainInterface.addEventListener('touchmove', (e) => {
                if (!isTabSwiping) return;
                
                const diffX = e.touches[0].clientX - tabSwipeStartX;
                const diffY = e.touches[0].clientY - tabSwipeStartY;
                
                // If scrolling vertically, cancel swipe
                if (Math.abs(diffY) > Math.abs(diffX)) {
                    isTabSwiping = false;
                }
            }, { passive: true });
            
            mainInterface.addEventListener('touchend', (e) => {
                if (!isTabSwiping) return;
                isTabSwiping = false;
                
                const diffX = e.changedTouches[0].clientX - tabSwipeStartX;
                const threshold = 80;
                
                // Get current tab
                const activeTab = document.querySelector('.tab-content.active');
                if (!activeTab) return;
                
                const currentTabId = activeTab.id.replace('Tab', '');
                const currentIndex = mobileTabs.indexOf(currentTabId);
                
                if (currentIndex === -1) return;
                
                // Swipe right = previous tab
                if (diffX > threshold && currentIndex > 0) {
                    const prevTab = mobileTabs[currentIndex - 1];
                    switchTab(prevTab);
                    showTabSwipeIndicator('←');
                }
                
                // Swipe left = next tab
                if (diffX < -threshold && currentIndex < mobileTabs.length - 1) {
                    const nextTab = mobileTabs[currentIndex + 1];
                    switchTab(nextTab);
                    showTabSwipeIndicator('→');
                }
            });
        }
        
        function showTabSwipeIndicator(direction) {
            // Brief visual feedback
            const indicator = document.createElement('div');
            indicator.className = 'tab-swipe-indicator';
            indicator.textContent = direction;
            document.body.appendChild(indicator);
            
            setTimeout(() => indicator.remove(), 300);
        }
        
        // Init on load
        document.addEventListener('DOMContentLoaded', initTabSwipeGestures);
        
        // =====================
        // OFFLINE SUPPORT
        // =====================
        let offlineData = {
            tasks: [],
            functions: [],
            users: [],
            regularTasks: []
        };
        
        // Save data to localStorage for offline access
        function saveOfflineData() {
            offlineData = {
                tasks: tasks,
                functions: functions,
                users: users,
                regularTasks: regularTasks,
                lastSync: new Date().toISOString()
            };
            localStorage.setItem('offlineData', JSON.stringify(offlineData));
        }
        
        // Load offline data
        function loadOfflineData() {
            const saved = localStorage.getItem('offlineData');
            if (saved) {
                offlineData = JSON.parse(saved);
                return true;
            }
            return false;
        }
        
        // Check online status
        function isOnline() {
            return navigator.onLine;
        }
        
        // Show offline indicator
        function updateOnlineStatus() {
            let indicator = document.getElementById('offlineIndicator');
            
            if (!isOnline()) {
                if (!indicator) {
                    indicator = document.createElement('div');
                    indicator.id = 'offlineIndicator';
                    indicator.className = 'offline-indicator';
                    indicator.innerHTML = '<i data-lucide="wifi-off" class="icon icon-sm"></i> Офлайн режим';
                    document.body.appendChild(indicator);
                    refreshIcons();
                }
                indicator.classList.add('visible');
                
                // Load offline data
                if (loadOfflineData() && offlineData.tasks.length) {
                    tasks = offlineData.tasks;
                    functions = offlineData.functions;
                    users = offlineData.users;
                    regularTasks = offlineData.regularTasks;
                    renderTasks();
                }
            } else {
                if (indicator) {
                    indicator.classList.remove('visible');
                }
            }
        }
        
        // Auto-save data when loaded
        const originalLoadAllData = window.loadAllData;
        if (originalLoadAllData) {
            window.loadAllData = async function() {
                const result = await originalLoadAllData();
                if (isOnline()) {
                    saveOfflineData();
                }
                return result;
            };
        }
        
        // Listen for online/offline events
        window.addEventListener('online', () => {
            updateOnlineStatus();
            // Reload fresh data
            if (typeof loadAllData === 'function') {
                loadAllData();
            }
        });
        
        window.addEventListener('offline', updateOnlineStatus);
        
        // Check on load
        document.addEventListener('DOMContentLoaded', updateOnlineStatus);
        
        // Periodic save (every 30 seconds)
        setInterval(() => {
            if (isOnline() && tasks.length > 0) {
                saveOfflineData();
            }
        }, 30000);
        
        // =====================
        // COMMENTS SYSTEM
        // =====================
        
        let currentTaskIdForComments = null;
        let commentsUnsubscribe = null;
        
        // Initialize comments when opening task modal for editing
        function initTaskComments(taskId) {
            currentTaskIdForComments = taskId;
            const section = document.getElementById('taskCommentsSection');
            
            if (!taskId) {
                // New task - hide comments
                section.classList.add('hidden');
                return;
            }
            
            // Show comments section for existing tasks
            section.classList.remove('hidden');
            loadComments(taskId);
            
            // Re-initialize lucide icons for comment section
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }
        
        // Load comments with real-time listener
        function loadComments(taskId) {
            const listEl = document.getElementById('commentsList');
            const countEl = document.getElementById('commentCount');
            
            // Unsubscribe from previous listener
            if (commentsUnsubscribe) {
                commentsUnsubscribe();
            }
            
            listEl.innerHTML = '<div class="comments-loading">Завантаження...</div>';
            
            // Real-time listener for comments
            commentsUnsubscribe = db.collection('companies').doc(companyId)
                .collection('tasks').doc(taskId)
                .collection('comments')
                .orderBy('createdAt', 'asc')
                .onSnapshot(snapshot => {
                    const comments = [];
                    snapshot.forEach(doc => {
                        comments.push({ id: doc.id, ...doc.data() });
                    });
                    
                    renderComments(comments);
                    countEl.textContent = comments.length;
                }, error => {
                    console.error('Error loading comments:', error);
                    listEl.innerHTML = '<div class="comments-empty">Помилка завантаження</div>';
                });
        }
        
        // Render comments list
        function renderComments(comments) {
            const listEl = document.getElementById('commentsList');
            const currentUserId = currentUser?.id;
            
            if (comments.length === 0) {
                listEl.innerHTML = `
                    <div class="comments-empty">
                        <div class="comments-empty-icon">💬</div>
                        <span data-i18n="noComments">Ще немає коментарів</span>
                    </div>
                `;
                return;
            }
            
            listEl.innerHTML = comments.map(comment => {
                const isOwn = comment.authorId === currentUserId;
                const time = formatCommentTime(comment.createdAt);
                
                return `
                    <div class="comment-item ${isOwn ? 'own-comment' : ''}">
                        <div class="comment-header">
                            <span class="comment-author">${escapeHtml(comment.authorName || 'Невідомий')}</span>
                            <span class="comment-time">${time}</span>
                        </div>
                        <div class="comment-text">${escapeHtml(comment.text)}</div>
                    </div>
                `;
            }).join('');
            
            // Scroll to bottom
            listEl.scrollTop = listEl.scrollHeight;
        }
        
        // Format comment timestamp
        function formatCommentTime(timestamp) {
            if (!timestamp) return '';
            
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            const now = new Date();
            const diff = now - date;
            
            // Less than 1 minute
            if (diff < 60000) return 'щойно';
            
            // Less than 1 hour
            if (diff < 3600000) {
                const mins = Math.floor(diff / 60000);
                return `${mins} хв тому`;
            }
            
            // Today
            if (date.toDateString() === now.toDateString()) {
                return date.toLocaleTimeString('uk-UA', { hour: '2-digit', minute: '2-digit' });
            }
            
            // Yesterday
            const yesterday = new Date(now);
            yesterday.setDate(yesterday.getDate() - 1);
            if (date.toDateString() === yesterday.toDateString()) {
                return 'вчора ' + date.toLocaleTimeString('uk-UA', { hour: '2-digit', minute: '2-digit' });
            }
            
            // Older
            return date.toLocaleDateString('uk-UA', { day: 'numeric', month: 'short' }) + 
                   ' ' + date.toLocaleTimeString('uk-UA', { hour: '2-digit', minute: '2-digit' });
        }
        
        // Send new comment
        async function sendComment() {
            const input = document.getElementById('commentInput');
            const btn = document.getElementById('sendCommentBtn');
            const text = input.value.trim();
            
            if (!text || !currentTaskIdForComments || !currentUser) return;
            
            btn.disabled = true;
            
            try {
                await db.collection('companies').doc(companyId)
                    .collection('tasks').doc(currentTaskIdForComments)
                    .collection('comments')
                    .add({
                        text: text,
                        authorId: currentUser.id,
                        authorName: currentUser.name || currentUser.email,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                
                input.value = '';
                input.style.height = 'auto';
            } catch (error) {
                console.error('Error sending comment:', error);
                showToast('Помилка відправки коментаря', 'error');
            } finally {
                btn.disabled = false;
            }
        }
        
        // Handle Enter key in comment input
        function handleCommentKeydown(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendComment();
            }
        }
        
        // Auto-resize textarea
        document.addEventListener('DOMContentLoaded', () => {
            const textarea = document.getElementById('commentInput');
            if (textarea) {
                textarea.addEventListener('input', function() {
                    this.style.height = 'auto';
                    this.style.height = Math.min(this.scrollHeight, 120) + 'px';
                });
            }
        });
        
        // Escape HTML for security
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Clean up comments listener when closing modal
        const originalCloseModal = window.closeModal;
        window.closeModal = function(modalId) {
            if (modalId === 'taskModal' && commentsUnsubscribe) {
                commentsUnsubscribe();
                commentsUnsubscribe = null;
                currentTaskIdForComments = null;
            }
            if (originalCloseModal) {
                originalCloseModal(modalId);
            }
        };
    </script>
    
    <style>
        /* Tab swipe indicator */
        .tab-swipe-indicator {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 3rem;
            color: var(--success);
            opacity: 0.8;
            pointer-events: none;
            animation: fadeOut 0.3s forwards;
            z-index: 9999;
        }
        
        @keyframes fadeOut {
            to { opacity: 0; transform: translate(-50%, -50%) scale(1.5); }
        }
        
        /* Offline indicator */
        .offline-indicator {
            position: fixed;
            top: 70px;
            left: 50%;
            transform: translateX(-50%) translateY(-100%);
            background: #ff9800;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            z-index: 9998;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            transition: transform 0.3s;
        }
        
        .o

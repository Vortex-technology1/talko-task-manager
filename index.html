<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TALKO System - –¢–∞—Å–∫ –ú–µ–Ω–µ–¥–∂–µ—Ä Pro</title>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --primary: #667eea;
            --primary-dark: #764ba2;
            --success: #27ae60;
            --warning: #f39c12;
            --danger: #e74c3c;
            --info: #3498db;
            --dark: #2c3e50;
            --gray: #7f8c8d;
            --light: #f5f7fa;
            --white: #ffffff;
            --shadow: 0 2px 10px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 40px rgba(0,0,0,0.15);
            --radius: 12px;
            --radius-sm: 8px;
        }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            background: var(--light); 
            color: var(--dark);
            min-height: 100vh;
        }
        
        .header { 
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); 
            color: white; 
            padding: 0.75rem 1rem; 
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header-content { 
            max-width: 1400px; 
            margin: 0 auto; 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        
        .logo { font-size: 1.1rem; font-weight: 700; }
        .header-actions { display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap; }
        
        .header-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 0.5rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .header-btn:hover { background: rgba(255,255,255,0.3); }
        
        .user-info {
            display: none;
            background: rgba(255,255,255,0.2);
            padding: 0.4rem 0.8rem;
            border-radius: 20px;
            font-size: 0.85rem;
        }
        
        .container { max-width: 1400px; margin: 0 auto; padding: 1rem; }
        
        .tab-navigation { 
            display: flex; 
            background: var(--white); 
            border-radius: var(--radius) var(--radius) 0 0; 
            box-shadow: var(--shadow);
            overflow-x: auto;
            scrollbar-width: none;
        }
        
        .tab-navigation::-webkit-scrollbar { display: none; }
        
        .tab-btn { 
            background: transparent; 
            border: none; 
            padding: 0.9rem 1rem; 
            cursor: pointer; 
            font-size: 0.8rem; 
            font-weight: 500; 
            color: var(--gray); 
            border-bottom: 3px solid transparent; 
            white-space: nowrap;
            flex-shrink: 0;
        }
        
        .tab-btn:hover { color: var(--dark); background: rgba(52, 73, 94, 0.05); }
        .tab-btn.active { color: var(--info); border-bottom-color: var(--info); font-weight: 600; }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .controls { 
            background: var(--white); 
            padding: 1rem; 
            border-radius: 0 0 var(--radius) var(--radius); 
            box-shadow: var(--shadow); 
            margin-bottom: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        
        .controls-row { display: flex; flex-wrap: wrap; gap: 0.5rem; }
        
        .btn { 
            background: var(--info); 
            color: white; 
            border: none; 
            padding: 0.7rem 1rem; 
            border-radius: var(--radius-sm); 
            cursor: pointer; 
            font-size: 0.85rem; 
            font-weight: 500;
            min-height: 44px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.4rem;
            transition: all 0.2s;
        }
        
        .btn:hover { transform: translateY(-1px); box-shadow: var(--shadow); }
        .btn:active { transform: translateY(0); }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        .btn-success { background: var(--success); }
        .btn-danger { background: var(--danger); }
        .btn-warning { background: var(--warning); }
        .btn-clear { background: var(--gray); }
        .btn-small { padding: 0.4rem 0.6rem; font-size: 0.8rem; min-height: 36px; }
        
        .btn-google {
            background: white;
            color: #444;
            border: 2px solid #ddd;
            font-weight: 600;
        }
        
        .btn-google:hover {
            background: #f8f9fa;
            border-color: #ccc;
        }
        
        .btn-google img {
            width: 20px;
            height: 20px;
        }
        
        .filters { display: flex; flex-wrap: wrap; gap: 0.5rem; width: 100%; }
        
        .filter-select { 
            padding: 0.6rem; 
            border: 2px solid #ecf0f1; 
            border-radius: var(--radius-sm); 
            background: var(--white); 
            font-size: 0.85rem;
            min-height: 44px;
            flex: 1;
            min-width: 100px;
        }
        
        .filter-select:focus { outline: none; border-color: var(--info); }
        
        .tasks-container, .cards-grid {
            background: var(--white);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            overflow: hidden;
        }
        
        .cards-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 0.75rem;
            padding: 1rem;
        }
        
        .task-card, .function-card, .user-card {
            padding: 1rem;
            border-bottom: 1px solid #ecf0f1;
            transition: all 0.2s;
        }
        
        .function-card, .user-card {
            background: #f8f9fa;
            border: 2px solid #ecf0f1;
            border-radius: var(--radius);
        }
        
        .task-card:last-child { border-bottom: none; }
        .task-card:hover, .function-card:hover, .user-card:hover { background: #f8f9fa; border-color: var(--info); }
        
        .task-card.pinned {
            background: linear-gradient(90deg, rgba(52, 152, 219, 0.08) 0%, var(--white) 100%);
            border-left: 4px solid var(--info);
        }
        
        .task-card-header, .function-header, .user-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }
        
        .task-title, .function-title, .user-name { font-weight: 600; font-size: 0.95rem; flex: 1; }
        
        .pin-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 0.9rem;
            color: #bdc3c7;
            padding: 0.2rem;
        }
        
        .pin-btn:hover, .pin-btn.pinned { color: var(--warning); }
        
        .task-meta, .function-description, .user-details {
            font-size: 0.8rem;
            color: var(--gray);
            margin-bottom: 0.5rem;
            line-height: 1.4;
        }
        
        .task-meta { display: flex; flex-wrap: wrap; gap: 0.5rem; }
        .task-meta-item { display: flex; align-items: center; gap: 0.2rem; }
        
        .task-badges, .function-assignees { display: flex; flex-wrap: wrap; gap: 0.4rem; margin-bottom: 0.5rem; }
        
        .badge, .assignee-badge, .role-badge {
            padding: 0.2rem 0.5rem;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 500;
        }
        
        .badge-new { background: #e3f2fd; color: #1976d2; }
        .badge-progress { background: #fff3e0; color: #f57c00; }
        .badge-review { background: #fce4ec; color: #c2185b; }
        .badge-done { background: #e8f5e8; color: #388e3c; }
        .badge-high { background: #ffebee; color: #d32f2f; }
        .badge-medium { background: #fff3e0; color: #f57c00; }
        .badge-low { background: #e8f5e8; color: #388e3c; }
        
        .assignee-badge { background: var(--success); color: white; }
        .assignee-badge.head { background: var(--warning); }
        
        .role-badge { color: white; }
        .role-badge.owner { background: var(--danger); }
        .role-badge.manager { background: var(--warning); }
        .role-badge.employee { background: var(--info); }
        
        .task-actions, .function-stats, .user-stats { 
            display: flex; 
            gap: 0.4rem; 
            justify-content: flex-end;
            padding-top: 0.5rem;
        }
        
        .function-stats, .user-stats {
            justify-content: space-between;
            border-top: 1px solid #ecf0f1;
            font-size: 0.8rem;
        }
        
        .empty-state { text-align: center; padding: 2.5rem 1.5rem; color: var(--gray); }
        .empty-state h3 { margin-bottom: 0.5rem; color: var(--dark); font-size: 1.1rem; }
        
        .modal { 
            display: none; 
            position: fixed; 
            z-index: 1000; 
            left: 0; top: 0; 
            width: 100%; height: 100%; 
            background: rgba(0,0,0,0.5); 
            backdrop-filter: blur(3px);
            overflow-y: auto;
            padding: 0.5rem;
        }
        
        .modal-content { 
            background: var(--white); 
            margin: 0 auto;
            border-radius: var(--radius); 
            width: 100%;
            max-width: 550px;
            max-height: calc(100vh - 1rem);
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
        }
        
        .modal-header { 
            background: var(--dark); 
            color: white; 
            padding: 1rem; 
            border-radius: var(--radius) var(--radius) 0 0;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .modal-header h2 { font-size: 1.1rem; padding-right: 2rem; }
        .modal-body { padding: 1rem; }
        
        .close { 
            color: rgba(255,255,255,0.7);
            position: absolute;
            right: 1rem; top: 0.8rem;
            font-size: 1.5rem;
            cursor: pointer;
        }
        
        .close:hover { color: white; }
        
        .form-grid { display: grid; grid-template-columns: 1fr; gap: 0.9rem; }
        .form-group { display: flex; flex-direction: column; }
        .form-group.full-width { grid-column: span 1; }
        .form-label { margin-bottom: 0.4rem; font-weight: 600; color: var(--dark); font-size: 0.85rem; }
        
        .form-input, .form-select, .form-textarea { 
            padding: 0.7rem; 
            border: 2px solid #ecf0f1; 
            border-radius: var(--radius-sm); 
            font-size: 1rem;
            min-height: 44px;
        }
        
        .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: var(--info); }
        .form-textarea { resize: vertical; min-height: 70px; }
        .form-actions { display: flex; gap: 0.5rem; justify-content: flex-end; margin-top: 1rem; flex-wrap: wrap; }
        
        .dashboard-cards {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.6rem;
            margin-bottom: 1rem;
        }
        
        .dashboard-card {
            border-radius: var(--radius);
            padding: 0.8rem;
            text-align: center;
            color: white;
        }
        
        .dashboard-card.urgent { background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%); }
        .dashboard-card.warning { background: linear-gradient(135deg, #feca57 0%, #f39c12 100%); }
        .dashboard-card.active { background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%); }
        .dashboard-card.completed { background: linear-gradient(135deg, #55efc4 0%, #00b894 100%); }
        
        .dashboard-card h3 { font-size: 0.75rem; margin-bottom: 0.2rem; opacity: 0.9; }
        .dashboard-number { font-size: 1.75rem; font-weight: 700; }
        
        /* AUTH */
        .auth-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: calc(100vh - 80px);
            padding: 1rem;
        }
        
        .auth-card {
            background: var(--white);
            border-radius: var(--radius);
            box-shadow: var(--shadow-lg);
            width: 100%;
            max-width: 420px;
            overflow: hidden;
        }
        
        .auth-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 1.5rem;
            text-align: center;
        }
        
        .auth-header h2 { font-size: 1.4rem; margin-bottom: 0.3rem; }
        .auth-header p { opacity: 0.9; font-size: 0.85rem; }
        .auth-body { padding: 1.25rem; }
        
        .auth-tabs { display: flex; margin-bottom: 1rem; }
        .auth-tab {
            flex: 1;
            padding: 0.75rem;
            border: none;
            background: #f0f0f0;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }
        .auth-tab:first-child { border-radius: 8px 0 0 8px; }
        .auth-tab:last-child { border-radius: 0 8px 8px 0; }
        .auth-tab.active { background: var(--info); color: white; }
        
        .auth-message {
            padding: 0.75rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            font-size: 0.85rem;
        }
        .auth-message.success { background: #e8f5e8; color: #388e3c; }
        .auth-message.error { background: #ffebee; color: #d32f2f; }
        .auth-message.info { background: #e3f2fd; color: #1976d2; }
        
        .auth-divider {
            display: flex;
            align-items: center;
            margin: 1.25rem 0;
            color: var(--gray);
            font-size: 0.85rem;
        }
        
        .auth-divider::before,
        .auth-divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: #ecf0f1;
        }
        
        .auth-divider span {
            padding: 0 1rem;
        }
        
        .main-interface { display: none; }
        
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 3rem;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #ecf0f1;
            border-top-color: var(--info);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .footer {
            text-align: center;
            padding: 1.25rem;
            background: #f8f9fa;
            border-top: 1px solid #ecf0f1;
            margin-top: 1.5rem;
        }
        
        .footer p { color: var(--gray); font-size: 0.8rem; margin-bottom: 0.5rem; }
        .footer-links { display: flex; justify-content: center; gap: 1rem; flex-wrap: wrap; }
        .footer-links a { color: var(--info); text-decoration: none; font-size: 0.8rem; }
        
        .support-btn {
            position: fixed;
            bottom: 16px;
            right: 16px;
            z-index: 999;
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 10px 16px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: #ffffff !important;
            border-radius: 50px;
            font-weight: 600;
            font-size: 13px;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
            cursor: pointer;
            text-decoration: none;
            border: none;
        }
        
        .support-btn:hover { transform: translateY(-2px); }
        .support-btn svg { width: 18px; height: 18px; stroke: #ffffff; }
        
        @media (min-width: 768px) {
            .header { padding: 1rem 2rem; }
            .logo { font-size: 1.4rem; }
            .user-info { display: flex; }
            .container { padding: 1.5rem; }
            .controls { flex-direction: row; align-items: center; justify-content: space-between; }
            .filters { width: auto; flex-wrap: nowrap; }
            .filter-select { flex: none; min-width: auto; }
            .form-grid { grid-template-columns: 1fr 1fr; }
            .form-group.full-width { grid-column: span 2; }
            .cards-grid { grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); }
            .dashboard-cards { grid-template-columns: repeat(4, 1fr); }
        }
        
        @media (max-width: 400px) {
            .support-btn span { display: none; }
            .support-btn { padding: 12px; border-radius: 50%; }
        }
        
        .assignee-checkbox {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            background: #f0f0f0;
            padding: 0.3rem 0.5rem;
            border-radius: 15px;
            font-size: 0.8rem;
            cursor: pointer;
        }
        
        .assignee-checkbox:hover { background: #e0e0e0; }
        .assignee-checkbox input { width: 14px; height: 14px; cursor: pointer; }
        
        .company-badge {
            background: rgba(255,255,255,0.3);
            padding: 0.2rem 0.5rem;
            border-radius: 10px;
            font-size: 0.7rem;
            margin-left: 0.5rem;
        }
        
        .password-toggle {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.1rem;
            color: var(--gray);
        }
        
        .input-wrapper {
            position: relative;
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="logo">
                üöÄ TALKO System
                <span class="company-badge" id="companyBadge" style="display:none;"></span>
            </div>
            <div class="header-actions">
                <div class="user-info" id="currentUserInfo">
                    <span>üë§ <span id="currentUserName">...</span></span>
                    <span id="currentUserRole" style="opacity:0.8;font-size:0.8rem;"></span>
                </div>
                <button class="header-btn" onclick="logout()" id="logoutBtn" style="display:none;">üö™ –í–∏–π—Ç–∏</button>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- LOADING -->
        <div id="loadingPage" class="loading">
            <div class="spinner"></div>
        </div>

        <!-- AUTH PAGE -->
        <div id="authPage" class="auth-container" style="display:none;">
            <div class="auth-card">
                <div class="auth-header">
                    <h2>üöÄ TALKO System</h2>
                    <p>–£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –∑–∞–≤–¥–∞–Ω–Ω—è–º–∏ –¥–ª—è –±—ñ–∑–Ω–µ—Å—É</p>
                </div>
                <div class="auth-body">
                    <div class="auth-tabs">
                        <button class="auth-tab active" onclick="showAuthTab('login')">–í—Ö—ñ–¥</button>
                        <button class="auth-tab" onclick="showAuthTab('register')">–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è</button>
                    </div>
                    
                    <div id="authMessage" class="auth-message" style="display:none;"></div>
                    
                    <!-- LOGIN -->
                    <div id="loginTab">
                        <button onclick="signInWithGoogle()" class="btn btn-google" style="width:100%;">
                            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google">
                            –£–≤—ñ–π—Ç–∏ —á–µ—Ä–µ–∑ Google
                        </button>
                        
                        <div class="auth-divider"><span>–∞–±–æ</span></div>
                        
                        <div class="form-group">
                            <label class="form-label">Email:</label>
                            <input type="email" id="loginEmail" class="form-input" placeholder="your@email.com">
                        </div>
                        <div class="form-group" style="margin-top:0.75rem;">
                            <label class="form-label">–ü–∞—Ä–æ–ª—å:</label>
                            <div class="input-wrapper">
                                <input type="password" id="loginPassword" class="form-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                                <button type="button" class="password-toggle" onclick="togglePassword('loginPassword', this)">üëÅÔ∏è</button>
                            </div>
                        </div>
                        <button onclick="signInWithEmail()" class="btn btn-success" style="width:100%;margin-top:1rem;">
                            üîê –£–≤—ñ–π—Ç–∏
                        </button>
                        <p style="text-align:center;margin-top:0.75rem;font-size:0.85rem;">
                            <a href="#" onclick="resetPassword()" style="color:var(--info);">–ó–∞–±—É–ª–∏ –ø–∞—Ä–æ–ª—å?</a>
                        </p>
                    </div>
                    
                    <!-- REGISTER -->
                    <div id="registerTab" style="display:none;">
                        <button onclick="signInWithGoogle()" class="btn btn-google" style="width:100%;">
                            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google">
                            –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è —á–µ—Ä–µ–∑ Google
                        </button>
                        
                        <div class="auth-divider"><span>–∞–±–æ</span></div>
                        
                        <div class="form-group">
                            <label class="form-label">–í–∞—à–µ —ñ–º'—è:</label>
                            <input type="text" id="registerName" class="form-input" placeholder="–û–ª–µ–∫—Å–∞–Ω–¥—Ä">
                        </div>
                        <div class="form-group" style="margin-top:0.75rem;">
                            <label class="form-label">Email:</label>
                            <input type="email" id="registerEmail" class="form-input" placeholder="your@email.com">
                        </div>
                        <div class="form-group" style="margin-top:0.75rem;">
                            <label class="form-label">–ü–∞—Ä–æ–ª—å:</label>
                            <div class="input-wrapper">
                                <input type="password" id="registerPassword" class="form-input" placeholder="–ú—ñ–Ω—ñ–º—É–º 6 —Å–∏–º–≤–æ–ª—ñ–≤">
                                <button type="button" class="password-toggle" onclick="togglePassword('registerPassword', this)">üëÅÔ∏è</button>
                            </div>
                        </div>
                        <div class="form-group" style="margin-top:0.75rem;">
                            <label class="form-label">–ù–∞–∑–≤–∞ –∫–æ–º–ø–∞–Ω—ñ—ó:</label>
                            <input type="text" id="registerCompany" class="form-input" placeholder="–ú–æ—è –∫–æ–º–ø–∞–Ω—ñ—è">
                        </div>
                        <button onclick="registerWithEmail()" class="btn btn-success" style="width:100%;margin-top:1rem;">
                            üöÄ –°—Ç–≤–æ—Ä–∏—Ç–∏ –∫–æ–º–ø–∞–Ω—ñ—é
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- MAIN INTERFACE -->
        <div id="mainInterface" class="main-interface">
            <div class="tab-navigation">
                <button class="tab-btn active" onclick="switchTab('tasks')">üìã –ó–∞–≤–¥–∞–Ω–Ω—è</button>
                <button class="tab-btn" onclick="switchTab('control')">üìä –ö–æ–Ω—Ç—Ä–æ–ª—å</button>
                <button class="tab-btn" onclick="switchTab('regular')">üîÑ –†–µ–≥—É–ª—è—Ä–Ω—ñ</button>
                <button class="tab-btn" onclick="switchTab('functions')">‚öôÔ∏è –§—É–Ω–∫—Ü—ñ—ó</button>
                <button class="tab-btn" onclick="switchTab('users')">üë• –ö–æ–º–∞–Ω–¥–∞</button>
            </div>

            <!-- TASKS -->
            <div id="tasksTab" class="tab-content active">
                <div class="controls">
                    <div class="controls-row">
                        <button class="btn btn-success" onclick="openTaskModal()">+ –ó–∞–≤–¥–∞–Ω–Ω—è</button>
                    </div>
                    <div class="filters">
                        <select class="filter-select" id="statusFilter" onchange="renderTasks()">
                            <option value="">–í—Å—ñ —Å—Ç–∞—Ç—É—Å–∏</option>
                            <option value="new">–ù–æ–≤—ñ</option>
                            <option value="progress">–í —Ä–æ–±–æ—Ç—ñ</option>
                            <option value="review">–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞</option>
                            <option value="done">–ì–æ—Ç–æ–≤–æ</option>
                        </select>
                        <select class="filter-select" id="functionFilter" onchange="renderTasks()"><option value="">–í—Å—ñ —Ñ—É–Ω–∫—Ü—ñ—ó</option></select>
                        <select class="filter-select" id="assigneeFilter" onchange="renderTasks()"><option value="">–í—Å—ñ</option></select>
                    </div>
                </div>
                <div class="tasks-container" id="tasksContainer">
                    <div class="loading"><div class="spinner"></div></div>
                </div>
            </div>

            <!-- CONTROL -->
            <div id="controlTab" class="tab-content">
                <div class="controls"><h2 style="font-size:1.1rem;">üìä –ü–∞–Ω–µ–ª—å –∫–æ–Ω—Ç—Ä–æ–ª—é</h2></div>
                <div style="background:white;border-radius:12px;padding:1rem;box-shadow:var(--shadow);">
                    <div class="dashboard-cards">
                        <div class="dashboard-card urgent"><h3>üö® –ö—Ä–∏—Ç–∏—á–Ω—ñ</h3><div class="dashboard-number" id="urgentCount">0</div></div>
                        <div class="dashboard-card warning"><h3>‚ö†Ô∏è –£–≤–∞–≥–∞</h3><div class="dashboard-number" id="warningCount">0</div></div>
                        <div class="dashboard-card active"><h3>üîÑ –ê–∫—Ç–∏–≤–Ω—ñ</h3><div class="dashboard-number" id="activeCount">0</div></div>
                        <div class="dashboard-card completed"><h3>‚úÖ –ì–æ—Ç–æ–≤–æ</h3><div class="dashboard-number" id="completedCount">0</div></div>
                    </div>
                    <div id="controlContent"></div>
                </div>
            </div>

            <!-- REGULAR -->
            <div id="regularTab" class="tab-content">
                <div class="controls">
                    <button class="btn btn-success" onclick="openRegularTaskModal()">+ –†–µ–≥—É–ª—è—Ä–Ω–µ</button>
                </div>
                <div id="regularTasksContainer" class="cards-grid">
                    <div class="loading"><div class="spinner"></div></div>
                </div>
            </div>

            <!-- FUNCTIONS -->
            <div id="functionsTab" class="tab-content">
                <div class="controls">
                    <button class="btn btn-success" onclick="openFunctionModal()">+ –§—É–Ω–∫—Ü—ñ—è</button>
                </div>
                <div id="functionsContainer" class="cards-grid">
                    <div class="loading"><div class="spinner"></div></div>
                </div>
            </div>

            <!-- USERS -->
            <div id="usersTab" class="tab-content">
                <div class="controls">
                    <button class="btn btn-warning" onclick="openInviteModal()">üì§ –ó–∞–ø—Ä–æ—Å–∏—Ç–∏</button>
                </div>
                <div id="usersContainer" class="cards-grid">
                    <div class="loading"><div class="spinner"></div></div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODALS -->
    <div id="taskModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><span class="close" onclick="closeModal('taskModal')">&times;</span><h2 id="taskModalTitle">–ù–æ–≤–µ –∑–∞–≤–¥–∞–Ω–Ω—è</h2></div>
            <div class="modal-body">
                <form id="taskForm" onsubmit="saveTask(event)">
                    <div class="form-grid">
                        <div class="form-group full-width"><label class="form-label">–ù–∞–∑–≤–∞ *</label><input type="text" id="taskTitle" class="form-input" required></div>
                        <div class="form-group"><label class="form-label">–§—É–Ω–∫—Ü—ñ—è</label><select id="taskFunction" class="form-select"><option value="">–ë–µ–∑ —Ñ—É–Ω–∫—Ü—ñ—ó</option></select></div>
                        <div class="form-group"><label class="form-label">–í–∏–∫–æ–Ω–∞–≤–µ—Ü—å *</label><select id="taskAssignee" class="form-select" required><option value="">–û–±–µ—Ä—ñ—Ç—å</option></select></div>
                        <div class="form-group"><label class="form-label">–î–µ–¥–ª–∞–π–Ω *</label><input type="datetime-local" id="taskDeadline" class="form-input" required></div>
                        <div class="form-group"><label class="form-label">–ü—Ä—ñ–æ—Ä–∏—Ç–µ—Ç</label><select id="taskPriority" class="form-select"><option value="low">–ù–∏–∑—å–∫–∏–π</option><option value="medium" selected>–°–µ—Ä–µ–¥–Ω—ñ–π</option><option value="high">–í–∏—Å–æ–∫–∏–π</option></select></div>
                        <div class="form-group"><label class="form-label">–°—Ç–∞—Ç—É—Å</label><select id="taskStatus" class="form-select"><option value="new">–ù–æ–≤–µ</option><option value="progress">–í —Ä–æ–±–æ—Ç—ñ</option><option value="review">–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞</option><option value="done">–ì–æ—Ç–æ–≤–æ</option></select></div>
                        <div class="form-group full-width"><label class="form-label">–û–ø–∏—Å</label><textarea id="taskDescription" class="form-textarea"></textarea></div>
                    </div>
                    <div class="form-actions"><button type="button" class="btn" onclick="closeModal('taskModal')">–°–∫–∞—Å—É–≤–∞—Ç–∏</button><button type="submit" class="btn btn-success">–ó–±–µ—Ä–µ–≥—Ç–∏</button></div>
                </form>
            </div>
        </div>
    </div>

    <div id="functionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><span class="close" onclick="closeModal('functionModal')">&times;</span><h2 id="functionModalTitle">–ù–æ–≤–∞ —Ñ—É–Ω–∫—Ü—ñ—è</h2></div>
            <div class="modal-body">
                <form id="functionForm" onsubmit="saveFunction(event)">
                    <div class="form-grid">
                        <div class="form-group"><label class="form-label">–ù–∞–∑–≤–∞ *</label><input type="text" id="functionName" class="form-input" required></div>
                        <div class="form-group"><label class="form-label">üëë –ì–æ–ª–æ–≤–Ω–∏–π *</label><select id="functionHead" class="form-select" required><option value="">–û–±–µ—Ä—ñ—Ç—å</option></select></div>
                        <div class="form-group full-width"><label class="form-label">–û–ø–∏—Å</label><textarea id="functionDescription" class="form-textarea"></textarea></div>
                        <div class="form-group full-width"><label class="form-label">üë• –£—á–∞—Å–Ω–∏–∫–∏</label><div id="functionAssignees" style="display:flex;flex-wrap:wrap;gap:0.4rem;margin-top:0.4rem;"></div></div>
                    </div>
                    <div class="form-actions"><button type="button" class="btn" onclick="closeModal('functionModal')">–°–∫–∞—Å—É–≤–∞—Ç–∏</button><button type="submit" class="btn btn-success">–ó–±–µ—Ä–µ–≥—Ç–∏</button></div>
                </form>
            </div>
        </div>
    </div>

    <div id="regularTaskModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><span class="close" onclick="closeModal('regularTaskModal')">&times;</span><h2>–†–µ–≥—É–ª—è—Ä–Ω–µ –∑–∞–≤–¥–∞–Ω–Ω—è</h2></div>
            <div class="modal-body">
                <form id="regularTaskForm" onsubmit="saveRegularTask(event)">
                    <div class="form-grid">
                        <div class="form-group full-width"><label class="form-label">–ù–∞–∑–≤–∞ *</label><input type="text" id="regularTaskTitle" class="form-input" required></div>
                        <div class="form-group"><label class="form-label">–§—É–Ω–∫—Ü—ñ—è *</label><select id="regularTaskFunction" class="form-select" required onchange="updateRegularTaskAssignees()"><option value="">–û–±–µ—Ä—ñ—Ç—å</option></select></div>
                        <div class="form-group"><label class="form-label">–ü–µ—Ä—ñ–æ–¥–∏—á–Ω—ñ—Å—Ç—å</label><select id="regularTaskPeriod" class="form-select"><option value="daily">–©–æ–¥–Ω—è</option><option value="weekly">–©–æ—Ç–∏–∂–Ω—è</option><option value="monthly">–©–æ–º—ñ—Å—è—Ü—è</option></select></div>
                        <div class="form-group full-width"><label class="form-label">üë• –í–∏–∫–æ–Ω–∞–≤—Ü—ñ</label><div id="regularTaskAssignees" style="display:flex;flex-wrap:wrap;gap:0.4rem;margin-top:0.4rem;padding:0.8rem;background:#f8f9fa;border-radius:8px;"><p style="color:#7f8c8d;">–°–ø–æ—á–∞—Ç–∫—É –æ–±–µ—Ä—ñ—Ç—å —Ñ—É–Ω–∫—Ü—ñ—é</p></div></div>
                    </div>
                    <div class="form-actions"><button type="button" class="btn" onclick="closeModal('regularTaskModal')">–°–∫–∞—Å—É–≤–∞—Ç–∏</button><button type="submit" class="btn btn-success">–ó–±–µ—Ä–µ–≥—Ç–∏</button></div>
                </form>
            </div>
        </div>
    </div>

    <div id="inviteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><span class="close" onclick="closeModal('inviteModal')">&times;</span><h2>üì§ –ó–∞–ø—Ä–æ—à–µ–Ω–Ω—è</h2></div>
            <div class="modal-body">
                <form id="inviteForm" onsubmit="sendInvite(event)">
                    <div class="form-group">
                        <label class="form-label">Email —Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫–∞ *</label>
                        <input type="email" id="inviteEmail" class="form-input" required>
                    </div>
                    <div class="form-group" style="margin-top:0.75rem;">
                        <label class="form-label">–†–æ–ª—å</label>
                        <select id="inviteRole" class="form-select"><option value="employee">–°–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫</option><option value="manager">–ú–µ–Ω–µ–¥–∂–µ—Ä</option></select>
                    </div>
                    <div id="inviteLink" style="margin-top:1rem;padding:1rem;background:#e3f2fd;border-radius:8px;display:none;">
                        <p style="font-size:0.85rem;margin-bottom:0.5rem;"><strong>–ü–æ—Å–∏–ª–∞–Ω–Ω—è –¥–ª—è –≤—Ö–æ–¥—É:</strong></p>
                        <input type="text" id="inviteLinkText" class="form-input" readonly style="font-size:0.8rem;">
                        <button type="button" onclick="copyInviteLink()" class="btn btn-small" style="margin-top:0.5rem;">üìã –ö–æ–ø—ñ—é–≤–∞—Ç–∏</button>
                    </div>
                    <div class="form-actions"><button type="button" class="btn" onclick="closeModal('inviteModal')">–ó–∞–∫—Ä–∏—Ç–∏</button><button type="submit" class="btn btn-success">üì§ –°—Ç–≤–æ—Ä–∏—Ç–∏ –∑–∞–ø—Ä–æ—à–µ–Ω–Ω—è</button></div>
                </form>
            </div>
        </div>
    </div>

    <a href="https://alextalko.com" target="_blank" class="support-btn">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
        <span>–ü—ñ–¥—Ç—Ä–∏–º–∫–∞</span>
    </a>

    <footer class="footer">
        <p>Powered by <strong style="color:#3498db;">TALKO System</strong></p>
        <div class="footer-links"><a href="https://alextalko.com" target="_blank">üõü –ü—ñ–¥—Ç—Ä–∏–º–∫–∞</a></div>
    </footer>

    <script>
        // =====================
        // FIREBASE CONFIG
        // =====================
        const firebaseConfig = {
            apiKey: "AIzaSyD1oBJuuFiVVo4HHjjeb81IhGEt1oz4Ydc",
            authDomain: "task-manager-44e84.firebaseapp.com",
            projectId: "task-manager-44e84",
            storageBucket: "task-manager-44e84.firebasestorage.app",
            messagingSenderId: "181519398491",
            appId: "1:181519398491:web:baa17a9a88f637ee94717e"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const googleProvider = new firebase.auth.GoogleAuthProvider();

        // =====================
        // APP STATE
        // =====================
        let currentUser = null;
        let currentCompany = null;
        let currentUserData = null;
        let tasks = [];
        let users = [];
        let functions = [];
        let regularTasks = [];
        let editingId = null;

        // =====================
        // AUTH FUNCTIONS
        // =====================
        function showAuthTab(tab) {
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`[onclick="showAuthTab('${tab}')"]`).classList.add('active');
            document.getElementById('loginTab').style.display = tab === 'login' ? 'block' : 'none';
            document.getElementById('registerTab').style.display = tab === 'register' ? 'block' : 'none';
            hideAuthMessage();
        }

        function showAuthMessage(msg, type = 'info') {
            const el = document.getElementById('authMessage');
            el.textContent = msg;
            el.className = 'auth-message ' + type;
            el.style.display = 'block';
        }

        function hideAuthMessage() {
            document.getElementById('authMessage').style.display = 'none';
        }

        function togglePassword(inputId, btn) {
            const input = document.getElementById(inputId);
            if (input.type === 'password') {
                input.type = 'text';
                btn.textContent = 'üôà';
            } else {
                input.type = 'password';
                btn.textContent = 'üëÅÔ∏è';
            }
        }

        // Google Sign-In
        async function signInWithGoogle() {
            try {
                const result = await auth.signInWithPopup(googleProvider);
                // Check if new user needs company
                await handleNewUser(result.user, result.user.displayName);
            } catch (e) {
                showAuthMessage('–ü–æ–º–∏–ª–∫–∞: ' + e.message, 'error');
            }
        }

        // Email + Password Sign In
        async function signInWithEmail() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            if (!email || !password) {
                showAuthMessage('–í–≤–µ–¥—ñ—Ç—å email —ñ –ø–∞—Ä–æ–ª—å', 'error');
                return;
            }
            
            try {
                await auth.signInWithEmailAndPassword(email, password);
            } catch (e) {
                let msg = '–ü–æ–º–∏–ª–∫–∞ –≤—Ö–æ–¥—É';
                if (e.code === 'auth/user-not-found') msg = '–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ';
                if (e.code === 'auth/wrong-password') msg = '–ù–µ–≤—ñ—Ä–Ω–∏–π –ø–∞—Ä–æ–ª—å';
                if (e.code === 'auth/invalid-email') msg = '–ù–µ–≤—ñ—Ä–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç email';
                showAuthMessage(msg, 'error');
            }
        }

        // Email + Password Registration
        async function registerWithEmail() {
            const name = document.getElementById('registerName').value.trim();
            const email = document.getElementById('registerEmail').value.trim();
            const password = document.getElementById('registerPassword').value;
            const company = document.getElementById('registerCompany').value.trim();
            
            if (!name || !email || !password || !company) {
                showAuthMessage('–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –≤—Å—ñ –ø–æ–ª—è', 'error');
                return;
            }
            
            if (password.length < 6) {
                showAuthMessage('–ü–∞—Ä–æ–ª—å –º–∞—î –±—É—Ç–∏ –º—ñ–Ω—ñ–º—É–º 6 —Å–∏–º–≤–æ–ª—ñ–≤', 'error');
                return;
            }
            
            try {
                const result = await auth.createUserWithEmailAndPassword(email, password);
                await result.user.updateProfile({ displayName: name });
                
                // Create company
                await createNewCompany(result.user, { name, email, company });
                showAuthMessage('‚úÖ –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è —É—Å–ø—ñ—à–Ω–∞!', 'success');
            } catch (e) {
                let msg = '–ü–æ–º–∏–ª–∫–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó';
                if (e.code === 'auth/email-already-in-use') msg = '–¶–µ–π email –≤–∂–µ –∑–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω–æ';
                if (e.code === 'auth/weak-password') msg = '–ü–∞—Ä–æ–ª—å –∑–∞–Ω–∞–¥—Ç–æ –ø—Ä–æ—Å—Ç–∏–π';
                if (e.code === 'auth/invalid-email') msg = '–ù–µ–≤—ñ—Ä–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç email';
                showAuthMessage(msg, 'error');
            }
        }

        // Password Reset
        async function resetPassword() {
            const email = document.getElementById('loginEmail').value.trim();
            if (!email) {
                showAuthMessage('–í–≤–µ–¥—ñ—Ç—å email –¥–ª—è –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è –ø–∞—Ä–æ–ª—è', 'error');
                return;
            }
            
            try {
                await auth.sendPasswordResetEmail(email);
                showAuthMessage('üìß –ü–æ—Å–∏–ª–∞–Ω–Ω—è –¥–ª—è –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è –Ω–∞–¥—ñ—Å–ª–∞–Ω–æ –Ω–∞ ' + email, 'success');
            } catch (e) {
                showAuthMessage('–ü–æ–º–∏–ª–∫–∞: ' + e.message, 'error');
            }
        }

        // Handle new user (check for invite or create company prompt)
        async function handleNewUser(user, displayName) {
            const companyId = await findUserCompany(user.uid, user.email);
            
            if (!companyId) {
                // New user without company - check if registering
                const companyName = document.getElementById('registerCompany')?.value?.trim();
                if (companyName) {
                    await createNewCompany(user, {
                        name: displayName || user.email.split('@')[0],
                        email: user.email,
                        company: companyName
                    });
                }
            }
        }

        async function createNewCompany(user, regData) {
            const companyRef = db.collection('companies').doc();
            const companyId = companyRef.id;
            
            await companyRef.set({
                name: regData.company,
                ownerId: user.uid,
                ownerEmail: regData.email,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            await companyRef.collection('users').doc(user.uid).set({
                name: regData.name,
                email: regData.email,
                role: 'owner',
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            await db.collection('users').doc(user.uid).set({
                email: regData.email,
                companyId: companyId,
                role: 'owner'
            });
        }

        async function findUserCompany(userId, email) {
            // Check global users collection
            const userDoc = await db.collection('users').doc(userId).get();
            if (userDoc.exists) {
                return userDoc.data().companyId;
            }
            
            // Search for invites
            const invitesQuery = await db.collection('invites')
                .where('email', '==', email)
                .where('accepted', '==', false)
                .limit(1)
                .get();
            
            if (!invitesQuery.empty) {
                const invite = invitesQuery.docs[0];
                const inviteData = invite.data();
                const companyId = inviteData.companyId;
                
                // Accept invite
                await db.collection('companies').doc(companyId).collection('users').doc(userId).set({
                    name: email.split('@')[0],
                    email: email,
                    role: inviteData.role || 'employee',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                await db.collection('users').doc(userId).set({
                    email: email,
                    companyId: companyId,
                    role: inviteData.role || 'employee'
                });
                
                await invite.ref.update({ accepted: true, acceptedAt: firebase.firestore.FieldValue.serverTimestamp() });
                
                return companyId;
            }
            
            return null;
        }

        function logout() {
            auth.signOut();
        }

        // =====================
        // AUTH STATE LISTENER
        // =====================
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                
                const companyId = await findUserCompany(user.uid, user.email);
                
                if (!companyId) {
                    document.getElementById('loadingPage').style.display = 'none';
                    document.getElementById('authPage').style.display = 'flex';
                    showAuthMessage('–°—Ç–≤–æ—Ä—ñ—Ç—å –Ω–æ–≤—É –∫–æ–º–ø–∞–Ω—ñ—é –∞–±–æ –ø–æ–ø—Ä–æ—Å—ñ—Ç—å –∑–∞–ø—Ä–æ—à–µ–Ω–Ω—è', 'info');
                    showAuthTab('register');
                    document.getElementById('registerName').value = user.displayName || '';
                    document.getElementById('registerEmail').value = user.email || '';
                    return;
                }
                
                currentCompany = companyId;
                
                const userDoc = await db.collection('companies').doc(companyId).collection('users').doc(user.uid).get();
                currentUserData = userDoc.exists ? { id: user.uid, ...userDoc.data() } : { id: user.uid, email: user.email, role: 'employee' };
                
                const companyDoc = await db.collection('companies').doc(companyId).get();
                const companyData = companyDoc.data();
                
                document.getElementById('currentUserName').textContent = currentUserData.name || user.displayName || user.email;
                document.getElementById('currentUserRole').textContent = `(${getRoleText(currentUserData.role)})`;
                document.getElementById('companyBadge').textContent = companyData?.name || '';
                document.getElementById('companyBadge').style.display = 'inline';
                
                showMainInterface();
                loadAllData();
            } else {
                document.getElementById('loadingPage').style.display = 'none';
                document.getElementById('authPage').style.display = 'flex';
                document.getElementById('mainInterface').style.display = 'none';
                document.getElementById('logoutBtn').style.display = 'none';
            }
        });

        function showMainInterface() {
            document.getElementById('loadingPage').style.display = 'none';
            document.getElementById('authPage').style.display = 'none';
            document.getElementById('mainInterface').style.display = 'block';
            document.getElementById('logoutBtn').style.display = 'block';
            document.getElementById('currentUserInfo').style.display = 'flex';
        }

        function getRoleText(role) {
            return { owner: '–í–ª–∞—Å–Ω–∏–∫', manager: '–ú–µ–Ω–µ–¥–∂–µ—Ä', employee: '–°–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫' }[role] || role;
        }

        // =====================
        // DATA LOADING
        // =====================
        async function loadAllData() {
            if (!currentCompany) return;
            
            const usersSnap = await db.collection('companies').doc(currentCompany).collection('users').get();
            users = usersSnap.docs.map(d => ({ id: d.id, ...d.data() }));
            
            const funcsSnap = await db.collection('companies').doc(currentCompany).collection('functions').get();
            functions = funcsSnap.docs.map(d => ({ id: d.id, ...d.data() }));
            
            const tasksSnap = await db.collection('companies').doc(currentCompany).collection('tasks').orderBy('createdAt', 'desc').get();
            tasks = tasksSnap.docs.map(d => ({ id: d.id, ...d.data() }));
            
            const regSnap = await db.collection('companies').doc(currentCompany).collection('regularTasks').get();
            regularTasks = regSnap.docs.map(d => ({ id: d.id, ...d.data() }));
            
            updateSelects();
            renderTasks();
        }

        // =====================
        // TASKS
        // =====================
        function openTaskModal(id = null) {
            document.getElementById('taskModal').style.display = 'block';
            updateSelects();
            
            if (id) {
                editingId = id;
                const t = tasks.find(x => x.id === id);
                if (t) {
                    document.getElementById('taskModalTitle').textContent = '–†–µ–¥–∞–≥—É–≤–∞—Ç–∏';
                    document.getElementById('taskTitle').value = t.title || '';
                    document.getElementById('taskFunction').value = t.function || '';
                    document.getElementById('taskAssignee').value = t.assigneeId || '';
                    document.getElementById('taskDeadline').value = t.deadline || '';
                    document.getElementById('taskPriority').value = t.priority || 'medium';
                    document.getElementById('taskStatus').value = t.status || 'new';
                    document.getElementById('taskDescription').value = t.description || '';
                }
            } else {
                editingId = null;
                document.getElementById('taskModalTitle').textContent = '–ù–æ–≤–µ –∑–∞–≤–¥–∞–Ω–Ω—è';
                document.getElementById('taskForm').reset();
            }
        }

        async function saveTask(e) {
            e.preventDefault();
            
            const assigneeId = document.getElementById('taskAssignee').value;
            const assignee = users.find(u => u.id === assigneeId);
            
            const data = {
                title: document.getElementById('taskTitle').value.trim(),
                function: document.getElementById('taskFunction').value,
                assigneeId: assigneeId,
                assigneeName: assignee?.name || assignee?.email || '',
                deadline: document.getElementById('taskDeadline').value,
                priority: document.getElementById('taskPriority').value,
                status: document.getElementById('taskStatus').value,
                description: document.getElementById('taskDescription').value.trim(),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            try {
                if (editingId) {
                    await db.collection('companies').doc(currentCompany).collection('tasks').doc(editingId).update(data);
                } else {
                    data.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                    data.creatorId = currentUser.uid;
                    data.creatorName = currentUserData?.name || currentUser.email;
                    data.pinned = false;
                    await db.collection('companies').doc(currentCompany).collection('tasks').add(data);
                }
                
                closeModal('taskModal');
                loadAllData();
            } catch (e) {
                alert('–ü–æ–º–∏–ª–∫–∞: ' + e.message);
            }
        }

        async function deleteTask(id) {
            if (!confirm('–í–∏–¥–∞–ª–∏—Ç–∏?')) return;
            await db.collection('companies').doc(currentCompany).collection('tasks').doc(id).delete();
            loadAllData();
        }

        async function togglePin(id) {
            const t = tasks.find(x => x.id === id);
            if (t) {
                await db.collection('companies').doc(currentCompany).collection('tasks').doc(id).update({ pinned: !t.pinned });
                loadAllData();
            }
        }

        function renderTasks() {
            const c = document.getElementById('tasksContainer');
            const sf = document.getElementById('statusFilter')?.value;
            const ff = document.getElementById('functionFilter')?.value;
            const af = document.getElementById('assigneeFilter')?.value;
            
            let f = tasks.filter(t => {
                if (sf && t.status !== sf) return false;
                if (ff && t.function !== ff) return false;
                if (af && t.assigneeId !== af) return false;
                return true;
            });
            
            f.sort((a, b) => {
                if (a.pinned && !b.pinned) return -1;
                if (!a.pinned && b.pinned) return 1;
                return new Date(a.deadline || 0) - new Date(b.deadline || 0);
            });
            
            if (f.length === 0) {
                c.innerHTML = '<div class="empty-state"><h3>üìã –ó–∞–≤–¥–∞–Ω—å –Ω–µ–º–∞—î</h3><p>–°—Ç–≤–æ—Ä—ñ—Ç—å –ø–µ—Ä—à–µ –∑–∞–≤–¥–∞–Ω–Ω—è</p></div>';
                return;
            }
            
            const st = { new: '–ù–æ–≤–µ', progress: '–í —Ä–æ–±–æ—Ç—ñ', review: '–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞', done: '–ì–æ—Ç–æ–≤–æ' };
            const pt = { low: '–ù–∏–∑—å–∫–∏–π', medium: '–°–µ—Ä–µ–¥–Ω—ñ–π', high: '–í–∏—Å–æ–∫–∏–π' };
            
            c.innerHTML = f.map(t => {
                const od = t.deadline && new Date(t.deadline) < new Date() && t.status !== 'done';
                return `
                    <div class="task-card ${t.pinned ? 'pinned' : ''}">
                        <div class="task-card-header">
                            <div class="task-title">
                                <button class="pin-btn ${t.pinned ? 'pinned' : ''}" onclick="togglePin('${t.id}')">üìå</button>
                                ${t.title}
                            </div>
                        </div>
                        <div class="task-meta">
                            <span class="task-meta-item">üë§ ${t.assigneeName || '–ù–µ –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–æ'}</span>
                            <span class="task-meta-item" style="${od ? 'color:#e74c3c;font-weight:600;' : ''}">üìÖ ${t.deadline ? formatDate(t.deadline) : '-'}</span>
                            ${t.function ? `<span class="task-meta-item">‚öôÔ∏è ${t.function}</span>` : ''}
                        </div>
                        <div class="task-badges">
                            <span class="badge badge-${t.status}">${st[t.status] || t.status}</span>
                            <span class="badge badge-${t.priority}">${pt[t.priority] || t.priority}</span>
                        </div>
                        ${t.description ? `<div style="font-size:0.8rem;color:#7f8c8d;padding:0.5rem;background:#f8f9fa;border-radius:8px;margin-top:0.5rem;">${t.description}</div>` : ''}
                        <div class="task-actions">
                            <button class="btn btn-small" onclick="openTaskModal('${t.id}')">‚úèÔ∏è</button>
                            <button class="btn btn-small btn-danger" onclick="deleteTask('${t.id}')">üóëÔ∏è</button>
                        </div>
                    </div>`;
            }).join('');
        }

        // =====================
        // FUNCTIONS
        // =====================
        function openFunctionModal(id = null) {
            document.getElementById('functionModal').style.display = 'block';
            updateFunctionAssignees();
            
            if (id) {
                editingId = id;
                const f = functions.find(x => x.id === id);
                if (f) {
                    document.getElementById('functionModalTitle').textContent = '–†–µ–¥–∞–≥—É–≤–∞—Ç–∏';
                    document.getElementById('functionName').value = f.name || '';
                    document.getElementById('functionHead').value = f.headId || '';
                    document.getElementById('functionDescription').value = f.description || '';
                    setTimeout(() => {
                        document.querySelectorAll('#functionAssignees input').forEach(cb => {
                            cb.checked = f.assigneeIds?.includes(cb.value);
                        });
                    }, 50);
                }
            } else {
                editingId = null;
                document.getElementById('functionModalTitle').textContent = '–ù–æ–≤–∞ —Ñ—É–Ω–∫—Ü—ñ—è';
                document.getElementById('functionForm').reset();
            }
        }

        function updateFunctionAssignees() {
            const c = document.getElementById('functionAssignees');
            const h = document.getElementById('functionHead');
            c.innerHTML = users.map(u => `<label class="assignee-checkbox"><input type="checkbox" value="${u.id}">${u.name || u.email}</label>`).join('');
            h.innerHTML = '<option value="">–û–±–µ—Ä—ñ—Ç—å</option>' + users.map(u => `<option value="${u.id}">${u.name || u.email}</option>`).join('');
        }

        async function saveFunction(e) {
            e.preventDefault();
            
            const headId = document.getElementById('functionHead').value;
            const head = users.find(u => u.id === headId);
            const assigneeIds = Array.from(document.querySelectorAll('#functionAssignees input:checked')).map(cb => cb.value);
            if (!assigneeIds.includes(headId)) assigneeIds.push(headId);
            
            const data = {
                name: document.getElementById('functionName').value.trim(),
                headId: headId,
                headName: head?.name || head?.email || '',
                description: document.getElementById('functionDescription').value.trim(),
                assigneeIds: assigneeIds,
                assigneeNames: assigneeIds.map(id => users.find(u => u.id === id)?.name || users.find(u => u.id === id)?.email || '').filter(Boolean)
            };
            
            try {
                if (editingId) {
                    await db.collection('companies').doc(currentCompany).collection('functions').doc(editingId).update(data);
                } else {
                    data.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                    await db.collection('companies').doc(currentCompany).collection('functions').add(data);
                }
                closeModal('functionModal');
                loadAllData();
            } catch (e) {
                alert('–ü–æ–º–∏–ª–∫–∞: ' + e.message);
            }
        }

        async function deleteFunction(id) {
            if (!confirm('–í–∏–¥–∞–ª–∏—Ç–∏?')) return;
            await db.collection('companies').doc(currentCompany).collection('functions').doc(id).delete();
            loadAllData();
        }

        function renderFunctions() {
            const c = document.getElementById('functionsContainer');
            if (functions.length === 0) {
                c.innerHTML = '<div class="empty-state" style="grid-column:1/-1;"><h3>‚öôÔ∏è –§—É–Ω–∫—Ü—ñ–π –Ω–µ–º–∞—î</h3><p>–°—Ç–≤–æ—Ä—ñ—Ç—å –ø–µ—Ä—à—É —Ñ—É–Ω–∫—Ü—ñ—é</p></div>';
                return;
            }
            c.innerHTML = functions.map(f => `
                <div class="function-card">
                    <div class="function-header">
                        <div class="function-title">‚öôÔ∏è ${f.name}</div>
                    </div>
                    ${f.description ? `<div class="function-description">${f.description}</div>` : ''}
                    <div class="function-assignees">
                        ${f.headName ? `<span class="assignee-badge head">üëë ${f.headName}</span>` : ''}
                        ${f.assigneeNames?.filter(n => n !== f.headName).map(n => `<span class="assignee-badge">${n}</span>`).join('') || ''}
                    </div>
                    <div class="function-stats">
                        <span>üìã ${tasks.filter(t => t.function === f.name).length} –∑–∞–≤–¥–∞–Ω—å</span>
                        <div>
                            <button class="btn btn-small" onclick="openFunctionModal('${f.id}')">‚úèÔ∏è</button>
                            <button class="btn btn-small btn-danger" onclick="deleteFunction('${f.id}')">üóëÔ∏è</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // =====================
        // REGULAR TASKS
        // =====================
        function openRegularTaskModal(id = null) {
            document.getElementById('regularTaskModal').style.display = 'block';
            updateRegularTaskFunctions();
            editingId = id;
            
            if (id) {
                const rt = regularTasks.find(r => r.id === id);
                if (rt) {
                    document.getElementById('regularTaskTitle').value = rt.title;
                    document.getElementById('regularTaskFunction').value = rt.function;
                    document.getElementById('regularTaskPeriod').value = rt.period;
                    updateRegularTaskAssignees();
                    setTimeout(() => {
                        document.querySelectorAll('#regularTaskAssignees input').forEach(cb => {
                            cb.checked = rt.assigneeIds?.includes(cb.value);
                        });
                    }, 50);
                }
            } else {
                document.getElementById('regularTaskForm').reset();
                document.getElementById('regularTaskAssignees').innerHTML = '<p style="color:#7f8c8d;">–°–ø–æ—á–∞—Ç–∫—É –æ–±–µ—Ä—ñ—Ç—å —Ñ—É–Ω–∫—Ü—ñ—é</p>';
            }
        }

        function updateRegularTaskFunctions() {
            const s = document.getElementById('regularTaskFunction');
            s.innerHTML = '<option value="">–û–±–µ—Ä—ñ—Ç—å</option>' + functions.map(f => `<option value="${f.name}">${f.name}</option>`).join('');
        }

        function updateRegularTaskAssignees() {
            const fn = document.getElementById('regularTaskFunction').value;
            const c = document.getElementById('regularTaskAssignees');
            const f = functions.find(x => x.name === fn);
            
            if (!f || !f.assigneeIds?.length) {
                c.innerHTML = '<p style="color:#7f8c8d;">–ù–µ–º–∞—î —É—á–∞—Å–Ω–∏–∫—ñ–≤</p>';
                return;
            }
            
            c.innerHTML = f.assigneeIds.map(id => {
                const u = users.find(x => x.id === id);
                return `<label class="assignee-checkbox"><input type="checkbox" value="${id}">${id === f.headId ? 'üëë ' : ''}${u?.name || u?.email || id}</label>`;
            }).join('');
        }

        async function saveRegularTask(e) {
            e.preventDefault();
            
            const assigneeIds = Array.from(document.querySelectorAll('#regularTaskAssignees input:checked')).map(cb => cb.value);
            if (!assigneeIds.length) { alert('–û–±–µ—Ä—ñ—Ç—å –≤–∏–∫–æ–Ω–∞–≤—Ü—ñ–≤'); return; }
            
            const data = {
                title: document.getElementById('regularTaskTitle').value.trim(),
                function: document.getElementById('regularTaskFunction').value,
                period: document.getElementById('regularTaskPeriod').value,
                assigneeIds: assigneeIds,
                assigneeNames: assigneeIds.map(id => users.find(u => u.id === id)?.name || users.find(u => u.id === id)?.email || '').filter(Boolean)
            };
            
            try {
                if (editingId) {
                    await db.collection('companies').doc(currentCompany).collection('regularTasks').doc(editingId).update(data);
                } else {
                    data.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                    await db.collection('companies').doc(currentCompany).collection('regularTasks').add(data);
                }
                closeModal('regularTaskModal');
                loadAllData();
            } catch (e) {
                alert('–ü–æ–º–∏–ª–∫–∞: ' + e.message);
            }
        }

        async function generateFromRegular(id) {
            const rt = regularTasks.find(r => r.id === id);
            if (!rt) return;
            
            const deadline = new Date();
            deadline.setDate(deadline.getDate() + 1);
            
            const batch = db.batch();
            rt.assigneeIds.forEach(assigneeId => {
                const ref = db.collection('companies').doc(currentCompany).collection('tasks').doc();
                batch.set(ref, {
                    title: rt.title,
                    function: rt.function,
                    assigneeId: assigneeId,
                    assigneeName: users.find(u => u.id === assigneeId)?.name || '',
                    deadline: deadline.toISOString().slice(0, 16),
                    status: 'new',
                    priority: 'medium',
                    pinned: false,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    creatorName: '–°–∏—Å—Ç–µ–º–∞'
                });
            });
            
            await batch.commit();
            alert(`‚úÖ –°—Ç–≤–æ—Ä–µ–Ω–æ ${rt.assigneeIds.length} –∑–∞–≤–¥–∞–Ω—å`);
            loadAllData();
        }

        async function deleteRegularTask(id) {
            if (!confirm('–í–∏–¥–∞–ª–∏—Ç–∏?')) return;
            await db.collection('companies').doc(currentCompany).collection('regularTasks').doc(id).delete();
            loadAllData();
        }

        function renderRegularTasks() {
            const c = document.getElementById('regularTasksContainer');
            const pt = { daily: '–©–æ–¥–Ω—è', weekly: '–©–æ—Ç–∏–∂–Ω—è', monthly: '–©–æ–º—ñ—Å—è—Ü—è' };
            
            if (regularTasks.length === 0) {
                c.innerHTML = '<div class="empty-state" style="grid-column:1/-1;"><h3>üîÑ –†–µ–≥—É–ª—è—Ä–Ω–∏—Ö –Ω–µ–º–∞—î</h3><p>–°—Ç–≤–æ—Ä—ñ—Ç—å —Ä–µ–≥—É–ª—è—Ä–Ω–µ –∑–∞–≤–¥–∞–Ω–Ω—è</p></div>';
                return;
            }
            
            c.innerHTML = regularTasks.map(rt => `
                <div class="function-card">
                    <div class="function-header">
                        <div class="function-title">${rt.title}</div>
                        <span class="badge" style="background:#f3e5f5;color:#7b1fa2;">${pt[rt.period] || rt.period}</span>
                    </div>
                    <div style="font-size:0.85rem;color:#7f8c8d;margin-bottom:0.5rem;">–§—É–Ω–∫—Ü—ñ—è: ${rt.function}</div>
                    <div class="function-assignees">
                        ${rt.assigneeNames?.map(n => `<span class="assignee-badge">${n}</span>`).join('') || ''}
                    </div>
                    <div class="function-stats">
                        <button class="btn btn-small btn-success" onclick="generateFromRegular('${rt.id}')">‚ö° –°—Ç–≤–æ—Ä–∏—Ç–∏</button>
                        <div>
                            <button class="btn btn-small" onclick="openRegularTaskModal('${rt.id}')">‚úèÔ∏è</button>
                            <button class="btn btn-small btn-danger" onclick="deleteRegularTask('${rt.id}')">üóëÔ∏è</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // =====================
        // USERS & INVITES
        // =====================
        function openInviteModal() {
            document.getElementById('inviteModal').style.display = 'block';
            document.getElementById('inviteForm').reset();
            document.getElementById('inviteLink').style.display = 'none';
        }

        async function sendInvite(e) {
            e.preventDefault();
            const email = document.getElementById('inviteEmail').value.trim();
            const role = document.getElementById('inviteRole').value;
            
            try {
                await db.collection('invites').add({
                    email: email,
                    companyId: currentCompany,
                    role: role,
                    invitedBy: currentUser.uid,
                    accepted: false,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                const link = window.location.origin + window.location.pathname;
                document.getElementById('inviteLinkText').value = link;
                document.getElementById('inviteLink').style.display = 'block';
                
                alert(`‚úÖ –ó–∞–ø—Ä–æ—à–µ–Ω–Ω—è —Å—Ç–≤–æ—Ä–µ–Ω–æ!\n\n–ù–∞–¥—ñ—à–ª—ñ—Ç—å –ø–æ—Å–∏–ª–∞–Ω–Ω—è —Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫—É.\n–í—ñ–Ω –º–∞—î —É–≤—ñ–π—Ç–∏ –∑ email: ${email}`);
            } catch (e) {
                alert('–ü–æ–º–∏–ª–∫–∞: ' + e.message);
            }
        }

        function copyInviteLink() {
            const input = document.getElementById('inviteLinkText');
            input.select();
            document.execCommand('copy');
            alert('üìã –ü–æ—Å–∏–ª–∞–Ω–Ω—è —Å–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ!');
        }

        async function deleteUser(id) {
            const u = users.find(x => x.id === id);
            if (u?.role === 'owner') { alert('–ù–µ –º–æ–∂–Ω–∞ –≤–∏–¥–∞–ª–∏—Ç–∏ –≤–ª–∞—Å–Ω–∏–∫–∞'); return; }
            if (!confirm('–í–∏–¥–∞–ª–∏—Ç–∏?')) return;
            await db.collection('companies').doc(currentCompany).collection('users').doc(id).delete();
            loadAllData();
        }

        function renderUsers() {
            const c = document.getElementById('usersContainer');
            if (users.length === 0) {
                c.innerHTML = '<div class="empty-state" style="grid-column:1/-1;"><h3>üë• –ù–µ–º–∞—î –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤</h3></div>';
                return;
            }
            
            c.innerHTML = users.map(u => `
                <div class="user-card">
                    <div class="user-header">
                        <div class="user-name">${u.name || u.email}</div>
                        <span class="role-badge ${u.role}">${getRoleText(u.role)}</span>
                    </div>
                    <div class="user-details">
                        <div>üìß ${u.email}</div>
                        ${u.position ? `<div>üíº ${u.position}</div>` : ''}
                    </div>
                    <div class="user-stats">
                        <span>üìã ${tasks.filter(t => t.assigneeId === u.id).length} –∑–∞–≤–¥–∞–Ω—å</span>
                        <div>
                            ${u.role !== 'owner' ? `<button class="btn btn-small btn-danger" onclick="deleteUser('${u.id}')">üóëÔ∏è</button>` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // =====================
        // CONTROL DASHBOARD
        // =====================
        function renderControl() {
            const now = new Date();
            const tm = new Date(now); tm.setDate(tm.getDate() + 1);
            
            const urgent = tasks.filter(t => t.deadline && new Date(t.deadline) < now && t.status !== 'done').length;
            const warning = tasks.filter(t => { const d = new Date(t.deadline); return d >= now && d <= tm && t.status !== 'done'; }).length;
            const active = tasks.filter(t => t.status === 'progress').length;
            const completed = tasks.filter(t => t.status === 'done').length;
            
            document.getElementById('urgentCount').textContent = urgent;
            document.getElementById('warningCount').textContent = warning;
            document.getElementById('activeCount').textContent = active;
            document.getElementById('completedCount').textContent = completed;
            
            const wl = {};
            tasks.filter(t => t.status !== 'done').forEach(t => { wl[t.assigneeName || '–ù–µ –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–æ'] = (wl[t.assigneeName || '–ù–µ –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–æ'] || 0) + 1; });
            
            document.getElementById('controlContent').innerHTML = `
                <h3 style="margin-bottom:0.8rem;">üë• –ù–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è</h3>
                ${Object.entries(wl).map(([n, c]) => `<div style="display:flex;justify-content:space-between;padding:0.4rem;background:#f8f9fa;border-radius:8px;margin-bottom:0.4rem;"><span>${n}</span><span style="font-weight:600;color:${c > 5 ? '#e74c3c' : '#27ae60'};">${c}</span></div>`).join('') || '<p style="color:#7f8c8d;">–ù–µ–º–∞—î –∞–∫—Ç–∏–≤–Ω–∏—Ö –∑–∞–≤–¥–∞–Ω—å</p>'}
            `;
        }

        // =====================
        // HELPERS
        // =====================
        function updateSelects() {
            const tf = document.getElementById('taskFunction');
            const ta = document.getElementById('taskAssignee');
            const ff = document.getElementById('functionFilter');
            const af = document.getElementById('assigneeFilter');
            
            if (tf) tf.innerHTML = '<option value="">–ë–µ–∑ —Ñ—É–Ω–∫—Ü—ñ—ó</option>' + functions.map(f => `<option value="${f.name}">${f.name}</option>`).join('');
            if (ta) ta.innerHTML = '<option value="">–û–±–µ—Ä—ñ—Ç—å</option>' + users.map(u => `<option value="${u.id}">${u.name || u.email}</option>`).join('');
            if (ff) ff.innerHTML = '<option value="">–í—Å—ñ —Ñ—É–Ω–∫—Ü—ñ—ó</option>' + functions.map(f => `<option value="${f.name}">${f.name}</option>`).join('');
            if (af) af.innerHTML = '<option value="">–í—Å—ñ</option>' + users.map(u => `<option value="${u.id}">${u.name || u.email}</option>`).join('');
        }

        function formatDate(s) {
            const d = new Date(s);
            return d.toLocaleDateString('uk-UA', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
        }

        function switchTab(t) {
            document.querySelectorAll('.tab-content').forEach(x => x.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(x => x.classList.remove('active'));
            document.getElementById(t + 'Tab').classList.add('active');
            document.querySelector(`[onclick="switchTab('${t}')"]`).classList.add('active');
            
            switch (t) {
                case 'tasks': renderTasks(); break;
                case 'control': renderControl(); break;
                case 'regular': renderRegularTasks(); break;
                case 'functions': renderFunctions(); break;
                case 'users': renderUsers(); break;
            }
        }

        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
            editingId = null;
        }

        window.onclick = function(e) {
            ['taskModal', 'functionModal', 'regularTaskModal', 'inviteModal'].forEach(id => {
                if (e.target === document.getElementById(id)) closeModal(id);
            });
        }
    </script>
</body>
</html>
